I"”-<ul id="markdown-toc">
  <li><a href="#nginx-rewriteä¸locationçš„æ¯”è¾ƒ" id="markdown-toc-nginx-rewriteä¸locationçš„æ¯”è¾ƒ">Nginx rewriteä¸Locationçš„æ¯”è¾ƒ</a></li>
</ul>

<p>nginxé…ç½®æ–‡ä»¶ä¸»è¦åˆ†ä¸ºå…­ä¸ªåŒºåŸŸï¼š</p>
<ul>
  <li>
    <p>main
æ§åˆ¶å­è¿›ç¨‹çš„æ‰€å±ç”¨æˆ·/ç”¨æˆ·ç»„ã€æ´¾ç”Ÿå­è¿›ç¨‹æ•°ã€é”™è¯¯æ—¥å¿—ä½ç½®/çº§åˆ«ã€pidä½ç½®ã€å­è¿›ç¨‹ä¼˜å…ˆçº§ã€è¿›ç¨‹å¯¹åº”cpuã€è¿›ç¨‹èƒ½å¤Ÿæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°ç›®ç­‰</p>
  </li>
  <li>
    <p>events
æ§åˆ¶nginxå¤„ç†è¿æ¥çš„æ–¹å¼</p>
  </li>
  <li>http</li>
  <li>sever</li>
  <li>location</li>
  <li>upstream</li>
</ul>

<p><strong>å®ä¾‹ï¼š</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># è¿è¡Œç”¨æˆ·
user www-data;

# å¯åŠ¨è¿›ç¨‹æ•°,é€šå¸¸è®¾ç½®æˆå’Œcpuçš„æ•°é‡ç›¸ç­‰
worker_processes 1;

# å…¨å±€é”™è¯¯æ—¥å¿—
error_log /var/log/nginx/error.log;

# PIDæ–‡ä»¶
pid /var/run/nginx.pid;

events {
  # ä½¿ç”¨epollå¤šè·¯å¤ç”¨æ¨¡å¼
  use epoll;   

  # å•ä¸ªåå°worker processè¿›ç¨‹çš„æœ€å¤§å¹¶å‘é“¾æ¥æ•°
  worker_connections  1024;
  # multi_accept on; 
}

http {
  # è®¾å®šmimeç±»å‹,ç±»å‹ç”±mime.typeæ–‡ä»¶å®šä¹‰
  include       /etc/nginx/mime.types;

  # 1 octet = 8 bit
  default_type  application/octet-stream;

  # è®¾å®šè®¿é—®æ—¥å¿—
  access_log    /var/log/nginx/access.log;

  # sendfileæŒ‡ä»¤æŒ‡å®šnginxæ˜¯å¦è°ƒç”¨sendfileå‡½æ•°ï¼ˆzero copyæ–¹å¼ï¼‰æ¥è¾“å‡ºæ–‡ä»¶ï¼Œå¯¹äºæ™®é€šåº”ç”¨ï¼Œå¿…é¡»è®¾ä¸ºon,å¦‚æœç”¨æ¥è¿›è¡Œä¸‹è½½ç­‰åº”ç”¨ç£ç›˜IOé‡è´Ÿè½½åº”ç”¨ï¼Œå¯è®¾ç½®ä¸ºoffï¼Œä»¥å¹³è¡¡ç£ç›˜ä¸ç½‘ç»œI/Oå¤„ç†é€Ÿåº¦ï¼Œé™ä½ç³»ç»Ÿçš„uptime.
  sendfile        on;

  # åœ¨ä¸€ä¸ªæ•°æ®åŒ…é‡Œå‘é€æ‰€æœ‰å¤´æ–‡ä»¶ï¼Œè€Œä¸ä¸€ä¸ªæ¥ä¸€ä¸ªçš„å‘é€
  #tcp_nopush     on;

  # è¿æ¥è¶…æ—¶æ—¶é—´
  keepalive_timeout  65;

  # ä½œç”¨äºsocketå‚æ•°TCP_NODELAYï¼Œç¦ç”¨nagleç®—æ³•ï¼Œä¹Ÿå³ä¸ç¼“å­˜æ•°æ®
  tcp_nodelay        on;
    
  # å¼€å¯gzipå‹ç¼©
  gzip  on;
  gzip_disable "MSIE [1-6]\.(?!.*SV1)";
 
  # è®¾å®šè¯·æ±‚ç¼“å†²
  client_header_buffer_size    1k;
  large_client_header_buffers  44k;

  include /etc/nginx/conf.d/*.conf;
  include /etc/nginx/sites-enabled/*;

  # è®¾å®šè´Ÿè½½å‡è¡¡çš„æœåŠ¡å™¨åˆ—è¡¨
  upstream mysvr {
    # weigthå‚æ•°è¡¨ç¤ºæƒå€¼ï¼Œæƒå€¼è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§
    # æœ¬æœºä¸Šçš„Squidå¼€å¯3128ç«¯å£
    server 192.168.8.1:3128 weight=5;
    server 192.168.8.2:80 weight=1;
    server 192.168.8.3:80 weight=6;
  }
 
server {
  # ä¾¦å¬80ç«¯å£
  listen 80;

  # å®šä¹‰ä½¿ç”¨www.xx.comè®¿é—®
  server_name  www.xx.com;

  # è®¾å®šæœ¬è™šæ‹Ÿä¸»æœºçš„è®¿é—®æ—¥å¿—
  access_log  logs/www.xx.com.access.log  main;

  # é»˜è®¤è¯·æ±‚
  location / {
    # å®šä¹‰æœåŠ¡å™¨çš„é»˜è®¤ç½‘ç«™æ ¹ç›®å½•ä½ç½®
    root   /root;      	

    # å®šä¹‰é¦–é¡µç´¢å¼•æ–‡ä»¶çš„åç§°
    index index.php index.html index.htm;  

    fastcgi_pass  localhost:9000;
      fastcgi_param  SCRIPT_FILENAME  $document_root/$fastcgi_script_name; 
      include /etc/nginx/fastcgi_params;  
    }

    # å®šä¹‰é”™è¯¯æç¤ºé¡µé¢
    error_page   500 502 503 504 /50x.html;  
      location = /50x.html {
      root   /root;
    }

    # é™æ€æ–‡ä»¶ï¼Œnginxè‡ªå·±å¤„ç†
    location ~ ^/(images|javascript|js|css|flash|media|static)/ {
      root /var/www/virtual/htdocs;
      
      # è¿‡æœŸæ—¶é—´30å¤©
      expires 30d;
    }

    # PHPè„šæœ¬è¯·æ±‚å…¨éƒ¨è½¬å‘åˆ°FastCGIå¤„ç†ï¼Œä½¿ç”¨FastCGIé»˜è®¤é…ç½®
    location ~ \.php$ {
      root /root;
      fastcgi_pass 127.0.0.1:9000;
      fastcgi_index index.php;
      fastcgi_param SCRIPT_FILENAME /home/www/www$fastcgi_script_name;
      include fastcgi_params;
    }

    # è®¾å®šæŸ¥çœ‹NginxçŠ¶æ€çš„åœ°å€
    location /NginxStatus {
      stub_status on;
      access_log on;
      auth_basic "NginxStatus";
      auth_basic_user_file conf/htpasswd;
    }

    # ç¦æ­¢è®¿é—® .htxxx æ–‡ä»¶
    location ~ /\.ht {
      deny all;
    }
  }
}
</code></pre></div></div>

<h2 id="nginx-rewriteä¸locationçš„æ¯”è¾ƒ">Nginx rewriteä¸Locationçš„æ¯”è¾ƒ</h2>
<p><strong>rewrite</strong>
ä½¿ç”¨Nginxæä¾›çš„å…¨å±€å˜é‡æˆ–è‡ªå·±è®¾ç½®çš„å˜é‡ï¼Œç»“åˆæ­£åˆ™è¡¨è¾¾å¼å’Œæ ‡å¿—ä½<strong>å®ç°urlé‡å†™ä»¥åŠé‡å®šå‘</strong>ã€‚rewriteåªèƒ½æ”¾åœ¨server{},location{},if{}ä¸­ï¼Œå¹¶ä¸”<strong>åªèƒ½å¯¹åŸŸååè¾¹çš„é™¤å»ä¼ é€’çš„å‚æ•°å¤–çš„å­—ç¬¦ä¸²èµ·ä½œç”¨</strong>ã€‚å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">http://demo.com/a/we/index.php?id=1&amp;u=str</code> åªå¯¹<code class="language-plaintext highlighter-rouge">/a/we/index.php</code>é‡å†™ã€‚
å¦‚æœæƒ³å¯¹åŸŸåæˆ–å‚æ•°å­—ç¬¦ä¸²èµ·ä½œç”¨ï¼Œå¯ä»¥ä½¿ç”¨å…¨å±€å˜é‡åŒ¹é…ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨proxy_passåå‘ä»£ç†ã€‚</p>

<p><strong>Rewriteæ ‡å¿—ä½</strong></p>
<ul>
  <li>last  ç›¸å½“äºApacheçš„[L]æ ‡è®°ï¼Œè¡¨ç¤ºå®Œæˆrewrite</li>
  <li>break  åœæ­¢æ‰§è¡Œå½“å‰è™šæ‹Ÿä¸»æœºçš„åç»­rewriteæŒ‡ä»¤é›†</li>
  <li>redirect è¿”å›302ä¸´æ—¶é‡å®šå‘ï¼Œåœ°å€æ ä¼šæ˜¾ç¤ºè·³è½¬åçš„åœ°å€</li>
  <li>permanent è¿”å›301æ°¸ä¹…é‡å®šå‘ï¼Œåœ°å€æ ä¼šæ˜¾ç¤ºè·³è½¬åçš„åœ°å€</li>
</ul>

<p><strong>Rewriteå®ä¾‹</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// åº”ç”¨äºServer
server {
  listen 80;
  server_name demo.com;
  index index.html index.php;
  root html;
  if ($http_host !~ â€œ^star\.igrow\.cn$&amp;quot {
    rewrite ^(.*) http://star.igrow.cn$1 redirect;
  }
}

// é˜²ç›—é“¾
location ~* \.(gif|jpg|swf)$ {
  valid_referers none blocked start.igrow.cn sta.igrow.cn;
  if ($invalid_referer) {
    rewrite ^/ http://$host/logo.png;
  }
}

// æ ¹æ®æ–‡ä»¶ç±»å‹è®¾ç½®è¿‡æœŸæ—¶é—´
location ~* \.(js|css|jpg|jpeg|gif|png|swf)$ {
  if (-f $request_filename) {
    expires 1h;
    break;
  }
}

// ç¦æ­¢è®¿é—®æŸä¸ªç›®å½•
location ~* \.(txt|doc)${
root /data/www/wwwroot/linuxtone/test;
deny all;
}
</code></pre></div></div>

<p><strong>rewriteå’Œlocationçš„æ¯”è¾ƒ</strong>
rewriteå’Œlocationéƒ½èƒ½å®ç°è·³è½¬ï¼Œä¸»è¦åŒºåˆ«åœ¨äº<strong>rewriteæ˜¯åœ¨åŒä¸€åŸŸåå†…æ›´æ”¹è·å–èµ„æºçš„è·¯å¾„ï¼Œè€Œlocationæ˜¯å¯¹ä¸€ç±»è·¯å¾„åšæ§åˆ¶è®¿é—®æˆ–åå‘ä»£ç†ï¼Œå¯ä»¥proxy_passåˆ°å…¶ä»–æœºå™¨</strong>ã€‚å¾ˆå¤šæƒ…å†µä¸‹rewriteä¹Ÿä¼šå†™åœ¨locationé‡Œï¼Œå®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼š</p>

<ul>
  <li>ï¼ˆ1ï¼‰æ‰§è¡Œserverå—çš„rewriteæŒ‡ä»¤</li>
  <li>ï¼ˆ2ï¼‰æ‰§è¡ŒlocationåŒ¹é…</li>
  <li>ï¼ˆ3ï¼‰æ‰§è¡Œé€‰å®šçš„locationä¸­çš„rewriteæŒ‡ä»¤</li>
</ul>

<p>å¦‚æœå…¶ä¸­æŸæ­¥URIè¢«é‡å†™ï¼Œåˆ™é‡æ–°å¾ªç¯æ‰§è¡Œï¼ˆ1ï¼‰~ï¼ˆ3ï¼‰ï¼Œç›´åˆ°æ‰¾åˆ°çœŸå®å­˜åœ¨çš„æ–‡ä»¶ï¼›å¾ªç¯è¶…è¿‡10æ¬¡ï¼Œåˆ™è¿”å›500 Internal Server Erroré”™è¯¯ã€‚</p>

<p>æ­£åˆ™åŒ¹é…ä¼šè¦†ç›–æ™®é€šåŒ¹é…ï¼Œ<strong>locationçš„æ‰§è¡Œé€»è¾‘è·Ÿlocationçš„ç¼–è¾‘é¡ºåºæ— å…³</strong>ã€‚</p>

<p><strong>locationè¯­æ³•æ ¼å¼</strong>ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>location [=|~|~*|^~|@] /uri/ { â€¦ }
</code></pre></div></div>

<ul>
  <li>= è¡¨ç¤ºç²¾ç¡®åŒ¹é…</li>
  <li>~  åŒºåˆ†å¤§å°å†™åŒ¹é…</li>
  <li>~* ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…</li>
  <li>!~ åŒºåˆ†å¤§å°å†™ä¸åŒ¹é…</li>
  <li>!~* ä¸åŒºåˆ†å¤§å°å†™ä¸åŒ¹é…</li>
  <li>^ ä»¥ä»€ä¹ˆå¼€å¤´çš„åŒ¹é…</li>
  <li>$ ä»¥ä»€ä¹ˆç»“å°¾çš„åŒ¹é…</li>
  <li>^~ è¡¨ç¤ºuriä»¥æŸä¸ªå¸¸è§„å­—ç¬¦ä¸²å¼€å¤´ï¼Œä¸æ˜¯æ­£åˆ™åŒ¹é…ï¼Œä¼˜å…ˆçº§é«˜äºæ­£åˆ™</li>
  <li>/ é€šç”¨åŒ¹é…,å¦‚æœæ²¡æœ‰å…¶å®ƒåŒ¹é…,ä»»ä½•è¯·æ±‚éƒ½ä¼šåŒ¹é…åˆ°</li>
  <li>ä»£è¡¨ä»»æ„å­—ç¬¦</li>
  <li>. åŒ¹é…é™¤æ¢è¡Œç¬¦ä»¥å¤–çš„ä»»æ„å­—ç¬¦</li>
  <li>? é‡å¤0æ¬¡æˆ–1æ¬¡</li>
  <li>+ é‡å¤1æ¬¡æˆ–æ›´å¤šæ¬¡</li>
  <li>* é‡å¤0æ¬¡æˆ–æ›´å¤šæ¬¡</li>
  <li>\d åŒ¹é…æ•°å­—</li>
  <li>{n}é‡å¤næ¬¡</li>
  <li>{n,}é‡å¤næ¬¡æˆ–æ›´å¤šæ¬¡</li>
  <li>[c]åŒ¹é…å•ä¸ªå­—ç¬¦c</li>
  <li>[a-z]åŒ¹é…a-zå°å†™å­—æ¯çš„ä»»æ„ä¸€ä¸ª</li>
  <li>\è½¬ä¹‰å­—ç¬¦</li>
  <li>-få’Œ!-fåˆ¤æ–­æ˜¯å¦å­˜åœ¨æ–‡ä»¶</li>
  <li>-då’Œ!-dåˆ¤æ–­æ˜¯å¦å­˜åœ¨ç›®å½•</li>
  <li>-eå’Œ!-eåˆ¤æ–­æ˜¯å¦å­˜åœ¨æ–‡ä»¶æˆ–ç›®å½•</li>
  <li>-xå’Œ!-xåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œ</li>
</ul>

<p><strong>å®é™…ä½¿ç”¨ä¸­ä¸€èˆ¬è‡³å°‘æœ‰ä¸‰ä¸ªåŒ¹é…è§„åˆ™å®šä¹‰ï¼š</strong></p>
<ul>
  <li>ç›´æ¥åŒ¹é…ç½‘ç«™æ ¹ï¼Œé€šè¿‡åŸŸåè®¿é—®ç½‘ç«™é¦–é¡µæ¯”è¾ƒé¢‘ç¹ï¼Œä½¿ç”¨è¿™ä¸ªä¼šåŠ é€Ÿå¤„ç†ã€‚è¿™é‡Œæ˜¯ç›´æ¥è½¬å‘ç»™åç«¯åº”ç”¨æœåŠ¡å™¨äº†ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªé™æ€é¦–é¡µã€‚
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>location = / {
proxy_pass http://tomcat:8080/index
}
</code></pre></div>    </div>
  </li>
  <li>å¤„ç†é™æ€æ–‡ä»¶çš„è¯·æ±‚ï¼Œè¿™æ˜¯nginxä½œä¸ºhttpæœåŠ¡å™¨çš„å¼ºé¡¹ã€‚æœ‰ä¸¤ç§é…ç½®æ¨¡å¼ï¼Œç›®å½•åŒ¹é…æˆ–åç¼€åŒ¹é…,ä»»é€‰å…¶ä¸€æˆ–æ­é…ä½¿ç”¨ã€‚
```
location ^~ /static/ {
root /webroot/static/;
}</li>
</ul>

<p>location ~* .(gif|jpg|jpeg|png|css|js|ico)$ {<br />
  root /webroot/res/;
}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* é€šç”¨è§„åˆ™ï¼Œç”¨æ¥è½¬å‘åŠ¨æ€è¯·æ±‚åˆ°åç«¯åº”ç”¨æœåŠ¡å™¨éé™æ€æ–‡ä»¶è¯·æ±‚å°±é»˜è®¤æ˜¯åŠ¨æ€è¯·æ±‚
</code></pre></div></div>
<p>location / {
  proxy_pass http://tomcat:8080/
}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
### å¦‚ä½•ä½¿ç”¨Nginxå®ç°è´Ÿè½½å‡è¡¡å’Œåå‘ä»£ç†ï¼Ÿ
è®¾å®šhttpæœåŠ¡å™¨ï¼Œåˆ©ç”¨å®ƒçš„åå‘ä»£ç†åŠŸèƒ½æä¾›è´Ÿè½½å‡è¡¡æ”¯æŒ

</code></pre></div></div>
<p>http {
  # è®¾å®šmimeç±»å‹,ç±»å‹ç”±mime.typeæ–‡ä»¶å®šä¹‰
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;</p>

<p># è®¾å®šæ—¥å¿—æ ¼å¼
  access_log    /var/log/nginx/access.log;</p>

<p># å…¶ä»–é…ç½®ï¼Œç•¥</p>

<p># è®¾å®šè´Ÿè½½å‡è¡¡çš„æœåŠ¡å™¨åˆ—è¡¨
  upstream mysvr {
    # weigthå‚æ•°è¡¨ç¤ºæƒå€¼ï¼Œæƒå€¼è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§
    # æœ¬æœºä¸Šçš„Squidå¼€å¯3128ç«¯å£
    server 192.168.8.1x:3128 weight=5;
      server 192.168.8.2x:80 weight=1;
      server 192.168.8.3x:80 weight=6;
    }</p>

<p>upstream mysvr2 {
    # weigthå‚æ•°è¡¨ç¤ºæƒå€¼ï¼Œæƒå€¼è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§
    server 192.168.8.x:80  weight=1;
    server 192.168.8.x:80  weight=6;
  }</p>

<p># ç¬¬ä¸€ä¸ªè™šæ‹ŸæœåŠ¡å™¨
  server {
     # ä¾¦å¬192.168.8.xçš„80ç«¯å£
    listen 80;
    server_name  192.168.8.x;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># å¯¹aspxåç¼€çš„è¿›è¡Œè´Ÿè½½å‡è¡¡è¯·æ±‚
# å®šä¹‰æœåŠ¡å™¨çš„é»˜è®¤ç½‘ç«™æ ¹ç›®å½•ä½ç½®
location ~ .*\.aspx$ {
  # å®šä¹‰æœåŠ¡å™¨çš„é»˜è®¤ç½‘ç«™æ ¹ç›®å½•ä½ç½®
  root   /root;

  # å®šä¹‰é¦–é¡µç´¢å¼•æ–‡ä»¶çš„åç§°
  index index.php index.html index.htm;   

  # è¯·æ±‚è½¬å‘mysvrå®šä¹‰çš„æœåŠ¡å™¨åˆ—è¡¨
  proxy_pass  http://mysvr ;

  # åå‘ä»£ç†çš„é…ç½®
  proxy_redirect off;

  # åç«¯çš„WebæœåŠ¡å™¨å¯ä»¥é€šè¿‡X-Forwarded-Forè·å–ç”¨æˆ·çœŸå®IP
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

  # å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°
  client_max_body_size 10m;

  # ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°
  client_body_buffer_size 128k;

  # nginxè·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶)
  proxy_connect_timeout 90;

  # åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ æ—¶é—´(ä»£ç†å‘é€è¶…æ—¶)
  proxy_send_timeout 90;

  # è¿æ¥æˆåŠŸåï¼Œåç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)
  proxy_read_timeout 90;

  # è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°
  proxy_buffer_size 4k;    

  # proxy_buffersç¼“å†²åŒºï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è¯ï¼Œè¿™æ ·è®¾ç½®
  proxy_buffers 4 32k;    

  # é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰
  proxy_busy_buffers_size 64k;    

  # è®¾å®šç¼“å­˜æ–‡ä»¶å¤¹å¤§å°ï¼Œå¤§äºè¿™ä¸ªå€¼ï¼Œå°†ä»upstreamæœåŠ¡å™¨ä¼ 
  proxy_temp_file_write_size 64k;  
}   } } ```
</code></pre></div></div>

:ET