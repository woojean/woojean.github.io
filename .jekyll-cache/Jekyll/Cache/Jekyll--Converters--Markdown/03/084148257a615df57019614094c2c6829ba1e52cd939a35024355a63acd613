I"×<ul id="markdown-toc">
  <li><a href="#æ·±å…¥phpé¢å‘å¯¹è±¡æ¨¡å¼ä¸å®è·µè¯»ä¹¦ç¬”è®°" id="markdown-toc-æ·±å…¥phpé¢å‘å¯¹è±¡æ¨¡å¼ä¸å®è·µè¯»ä¹¦ç¬”è®°">ã€Šæ·±å…¥PHPâ€”â€”é¢å‘å¯¹è±¡ã€æ¨¡å¼ä¸å®è·µã€‹è¯»ä¹¦ç¬”è®°</a>    <ul>
      <li><a href="#å•ä¾‹æ¨¡å¼" id="markdown-toc-å•ä¾‹æ¨¡å¼">å•ä¾‹æ¨¡å¼</a></li>
      <li><a href="#å·¥å‚æ–¹æ³•æ¨¡å¼" id="markdown-toc-å·¥å‚æ–¹æ³•æ¨¡å¼">å·¥å‚æ–¹æ³•æ¨¡å¼</a></li>
      <li><a href="#æŠ½è±¡å·¥å‚æ¨¡å¼" id="markdown-toc-æŠ½è±¡å·¥å‚æ¨¡å¼">æŠ½è±¡å·¥å‚æ¨¡å¼</a></li>
      <li><a href="#åŸå‹æ¨¡å¼" id="markdown-toc-åŸå‹æ¨¡å¼">åŸå‹æ¨¡å¼</a></li>
      <li><a href="#ç»„åˆæ¨¡å¼" id="markdown-toc-ç»„åˆæ¨¡å¼">ç»„åˆæ¨¡å¼</a></li>
      <li><a href="#è£…é¥°æ¨¡å¼" id="markdown-toc-è£…é¥°æ¨¡å¼">è£…é¥°æ¨¡å¼</a></li>
      <li><a href="#å¤–è§‚æ¨¡å¼" id="markdown-toc-å¤–è§‚æ¨¡å¼">å¤–è§‚æ¨¡å¼</a></li>
      <li><a href="#è§£é‡Šå™¨æ¨¡å¼" id="markdown-toc-è§£é‡Šå™¨æ¨¡å¼">è§£é‡Šå™¨æ¨¡å¼</a></li>
      <li><a href="#ç­–ç•¥æ¨¡å¼" id="markdown-toc-ç­–ç•¥æ¨¡å¼">ç­–ç•¥æ¨¡å¼</a></li>
      <li><a href="#è§‚å¯Ÿè€…æ¨¡å¼" id="markdown-toc-è§‚å¯Ÿè€…æ¨¡å¼">è§‚å¯Ÿè€…æ¨¡å¼</a></li>
      <li><a href="#è®¿é—®è€…æ¨¡å¼" id="markdown-toc-è®¿é—®è€…æ¨¡å¼">è®¿é—®è€…æ¨¡å¼</a></li>
      <li><a href="#å‘½ä»¤æ¨¡å¼" id="markdown-toc-å‘½ä»¤æ¨¡å¼">å‘½ä»¤æ¨¡å¼</a></li>
      <li><a href="#æ³¨å†Œè¡¨" id="markdown-toc-æ³¨å†Œè¡¨">æ³¨å†Œè¡¨</a></li>
      <li><a href="#å‰ç«¯æ§åˆ¶å™¨" id="markdown-toc-å‰ç«¯æ§åˆ¶å™¨">å‰ç«¯æ§åˆ¶å™¨</a></li>
      <li><a href="#åº”ç”¨æ§åˆ¶å™¨" id="markdown-toc-åº”ç”¨æ§åˆ¶å™¨">åº”ç”¨æ§åˆ¶å™¨*</a></li>
      <li><a href="#é¡µé¢æ§åˆ¶å™¨" id="markdown-toc-é¡µé¢æ§åˆ¶å™¨">é¡µé¢æ§åˆ¶å™¨</a></li>
      <li><a href="#äº‹åŠ¡è„šæœ¬" id="markdown-toc-äº‹åŠ¡è„šæœ¬">äº‹åŠ¡è„šæœ¬</a></li>
      <li><a href="#é¢†åŸŸæ¨¡å‹" id="markdown-toc-é¢†åŸŸæ¨¡å‹">é¢†åŸŸæ¨¡å‹</a></li>
      <li><a href="#æ•°æ®æ˜ å°„å™¨" id="markdown-toc-æ•°æ®æ˜ å°„å™¨">æ•°æ®æ˜ å°„å™¨</a></li>
      <li><a href="#æ ‡è¯†æ˜ å°„" id="markdown-toc-æ ‡è¯†æ˜ å°„">æ ‡è¯†æ˜ å°„</a></li>
      <li><a href="#å·¥ä½œå•å…ƒ" id="markdown-toc-å·¥ä½œå•å…ƒ">å·¥ä½œå•å…ƒ</a></li>
      <li><a href="#å»¶è¿ŸåŠ è½½" id="markdown-toc-å»¶è¿ŸåŠ è½½">å»¶è¿ŸåŠ è½½</a></li>
      <li><a href="#é¢†åŸŸå¯¹è±¡å·¥å‚" id="markdown-toc-é¢†åŸŸå¯¹è±¡å·¥å‚">é¢†åŸŸå¯¹è±¡å·¥å‚</a></li>
    </ul>
  </li>
</ul>

<h1 id="æ·±å…¥phpé¢å‘å¯¹è±¡æ¨¡å¼ä¸å®è·µè¯»ä¹¦ç¬”è®°">ã€Šæ·±å…¥PHPâ€”â€”é¢å‘å¯¹è±¡ã€æ¨¡å¼ä¸å®è·µã€‹è¯»ä¹¦ç¬”è®°</h1>

<h2 id="å•ä¾‹æ¨¡å¼">å•ä¾‹æ¨¡å¼</h2>
<p>ä¿è¯æŸä¸ªç±»åœ¨æ•´ä¸ªåº”ç”¨ä¸­ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ã€‚
å•ä¾‹æ¨¡å¼çš„è¦ç‚¹æœ‰ä¸‰ä¸ªï¼šä¸€æ˜¯æŸä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ï¼›äºŒæ˜¯å®ƒå¿…é¡»è‡ªè¡Œåˆ›å»ºè¿™ä¸ªå®ä¾‹ï¼›ä¸‰æ˜¯å®ƒå¿…é¡»è‡ªè¡Œå‘æ•´ä¸ªç³»ç»Ÿæä¾›è¿™ä¸ªå®ä¾‹ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">Preferences</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$props</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$instance</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>	

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">getInstance</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">empty</span><span class="p">(</span> <span class="k">self</span><span class="o">::</span><span class="nv">$instance</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">::</span><span class="nv">$instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Preferences</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">::</span><span class="nv">$instance</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">setProperty</span><span class="p">(</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">getProperty</span><span class="p">(</span> <span class="nv">$key</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="nv">$pref</span> <span class="o">=</span> <span class="nc">Preferences</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>
<span class="nv">$pref</span><span class="o">-&gt;</span><span class="nf">setProperty</span><span class="p">(</span> <span class="s2">"name"</span><span class="p">,</span> <span class="s2">"matt"</span> <span class="p">);</span>

<span class="nb">unset</span><span class="p">(</span> <span class="nv">$pref</span> <span class="p">);</span> <span class="c1">// åˆ é™¤$pref</span>

<span class="nv">$pref2</span> <span class="o">=</span> <span class="nc">Preferences</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">();</span>
<span class="k">print</span> <span class="nv">$pref2</span><span class="o">-&gt;</span><span class="nf">getProperty</span><span class="p">(</span> <span class="s2">"name"</span> <span class="p">)</span> <span class="mf">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span> 	<span class="c1">// è™½ç„¶$prefè¢«åˆ é™¤äº†ï¼Œä½†æ˜¯å€¼è¢«ä¿ç•™äº†</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<h2 id="å·¥å‚æ–¹æ³•æ¨¡å¼">å·¥å‚æ–¹æ³•æ¨¡å¼</h2>
<p>å·¥å‚æ–¹æ³•æ¨¡å¼æŠŠåˆ›å»ºè€…ç±»ä¸è¦ç”Ÿäº§çš„äº§å“ç±»åˆ†ç¦»å¼€æ¥ï¼Œåˆ›å»ºè€…æ˜¯ä¸€ä¸ªå·¥å‚ç±»ï¼Œå…¶ä¸­å®šä¹‰äº†ç”¨äºç”Ÿäº§äº§å“å¯¹è±¡çš„ç±»æ–¹æ³•ã€‚åˆ›å»ºè€…çš„æ¯ä¸ªå­ç±»å®ä¾‹åŒ–ä¸€ä¸ªç›¸åº”çš„äº§å“å­ç±»ã€‚
ä¾‹å¦‚ï¼šæœ‰ä¸€ä¸ªç¼–ç å™¨ç±»ApptEncoderï¼Œç”¨æ¥å°†æ•°æ®è½¬æ¢æˆç‰¹å®šçš„æ ¼å¼ã€‚æ­¤å¤–æœ‰ä¸€ä¸ªç®¡ç†ç±»CommsManagerï¼Œç”¨æ¥è·å–ä¸åŒçš„ç¼–ç å™¨ã€‚
ä¸€ç§æ¯”è¾ƒå·®çš„ã€åŸºäºæ¡ä»¶è¯­å¥çš„å®ç°å¦‚ä¸‹ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">ApptEncoder</span> <span class="p">{</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">encode</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">BloggsApptEncoder</span> <span class="kd">extends</span> <span class="nc">ApptEncoder</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">encode</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"Appointment data encoded in BloggsCal format</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">MegaApptEncoder</span> <span class="kd">extends</span> <span class="nc">ApptEncoder</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">encode</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"Appointment data encoded in MegaCal format</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">CommsManager</span> <span class="p">{</span>
    <span class="k">const</span> <span class="no">BLOGGS</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">MEGA</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$mode</span> <span class="p">;</span>

    <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span> <span class="nv">$mode</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="nv">$mode</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getHeaderText</span><span class="p">()</span> <span class="p">{</span>					<span class="c1">// åŸºäºæ¡ä»¶è¯­å¥</span>
        <span class="k">switch</span> <span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">(</span> <span class="k">self</span><span class="o">::</span><span class="no">MEGA</span> <span class="p">)</span><span class="o">:</span>
                <span class="k">return</span> <span class="s2">"MegaCal header</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">return</span> <span class="s2">"BloggsCal header</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">function</span> <span class="n">getApptEncoder</span><span class="p">()</span> <span class="p">{</span>					<span class="c1">// åŸºäºæ¡ä»¶è¯­å¥ï¼ˆé‡å¤åˆ¤æ–­ï¼‰</span>
        <span class="k">switch</span> <span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">(</span> <span class="k">self</span><span class="o">::</span><span class="no">MEGA</span> <span class="p">)</span><span class="o">:</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nc">MegaApptEncoder</span><span class="p">();</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nc">BloggsApptEncoder</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="c1">// å¦‚æœå†åŠ å…¥ä¸€ä¸ªæ–°çš„getFooterText()æ–¹æ³•ï¼Œåˆ™è¦å†å¤šä¸€æ¬¡æ¡ä»¶åˆ¤æ–­</span>
<span class="p">}</span>

<span class="nv">$man</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CommsManager</span><span class="p">(</span> <span class="nc">CommsManager</span><span class="o">::</span><span class="no">MEGA</span> <span class="p">);</span>
<span class="k">print</span> <span class="p">(</span> <span class="nb">get_class</span><span class="p">(</span> <span class="nv">$man</span><span class="o">-&gt;</span><span class="nf">getApptEncoder</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span><span class="mf">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="nv">$man</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CommsManager</span><span class="p">(</span> <span class="nc">CommsManager</span><span class="o">::</span><span class="no">BLOGGS</span> <span class="p">);</span>
<span class="k">print</span> <span class="p">(</span> <span class="nb">get_class</span><span class="p">(</span> <span class="nv">$man</span><span class="o">-&gt;</span><span class="nf">getApptEncoder</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span><span class="mf">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p>å·¥å‚æ–¹æ³•çš„å®ç°ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">ApptEncoder</span> <span class="p">{</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">encode</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">BloggsApptEncoder</span> <span class="kd">extends</span> <span class="nc">ApptEncoder</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">encode</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"Appointment data encode in BloggsCal format</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">CommsManager</span> <span class="p">{</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">getHeaderText</span><span class="p">();</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">getApptEncoder</span><span class="p">();</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">getFooterText</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// äº§å“å’Œå·¥å‚éƒ½æŠ½è±¡å‡ºæ¥ï¼Œä¸€ä¸ªå·¥å‚çš„å­ç±»å¯¹åº”ä¸€ä¸ªäº§å“å­ç±»</span>
<span class="kd">class</span> <span class="nc">BloggsCommsManager</span> <span class="kd">extends</span> <span class="nc">CommsManager</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">getHeaderText</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"BloggsCal header</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getApptEncoder</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">BloggsApptEncoder</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getFooterText</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"BloggsCal footer</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<h2 id="æŠ½è±¡å·¥å‚æ¨¡å¼">æŠ½è±¡å·¥å‚æ¨¡å¼</h2>
<p>å·¥å‚æ–¹æ³•è§£å†³äº†åŒä¸€ä¸ªç¼–ç å™¨æ·»åŠ ä¸åŒç¼–ç æ ¼å¼çš„é—®é¢˜ï¼Œå½“éœ€è¦æ·»åŠ ä¸åŒçš„ç¼–ç å™¨æ—¶ï¼Œéœ€è¦ä½¿ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼ã€‚
ä¾‹å¦‚éœ€è¦æ·»åŠ ä¸€ä¸ªæ–°çš„è§£ç å™¨ç±»ï¼šTtdEncoderï¼Œè¯¥ç±»åŒæ ·æ”¯æŒApptEncoderæ‰€æ”¯æŒçš„æ‰€æœ‰ç¼–ç æ ¼å¼ã€‚</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">ApptEncoder</span> <span class="p">{</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">encode</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">BloggsApptEncoder</span> <span class="kd">extends</span> <span class="nc">ApptEncoder</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">encode</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"Appointment data encoded in BloggsCal format</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">MegaApptEncoder</span> <span class="kd">extends</span> <span class="nc">ApptEncoder</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">encode</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"Appointment data encoded in MegaCal format</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// TtdEncoderåŠå…¶å­ç±»çš„å®ç°ç•¥</span>

<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">CommsManager</span> <span class="p">{</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">getHeaderText</span><span class="p">();</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">getApptEncoder</span><span class="p">();</span>		<span class="c1">// è§£ç å™¨ç±»å‹1 </span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">getTtdEncoder</span><span class="p">();</span>			<span class="c1">// è§£ç å™¨ç±»å‹2</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">getContactEncoder</span><span class="p">();</span>		<span class="c1">// è§£ç å™¨ç±»å‹3</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">getFooterText</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">BloggsCommsManager</span> <span class="kd">extends</span> <span class="nc">CommsManager</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">getHeaderText</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"BloggsCal header</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getApptEncoder</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">BloggsApptEncoder</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getTtdEncoder</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">BloggsTtdEncoder</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getContactEncoder</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">BloggsContactEncoder</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getFooterText</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"BloggsCal footer</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">MegaCommsManager</span> <span class="kd">extends</span> <span class="nc">CommsManager</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">getHeaderText</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"MegaCal header</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getApptEncoder</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MegaApptEncoder</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getTtdEncoder</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MegaTtdEncoder</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getContactEncoder</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MegaContactEncoder</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getFooterText</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"MegaCal footer</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*
$mgr = new MegaCommsManager();
print $mgr-&gt;getHeaderText();
print $mgr-&gt;getApptEncoder()-&gt;encode();
print $mgr-&gt;getFooterText();
*/</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p>å·¥å‚æ–¹æ³•ï¼šä¸€ä¸ªæŠ½è±¡äº§å“ç±»å¯ä»¥æ´¾ç”Ÿå‡ºå¤šä¸ªå…·ä½“äº§å“ç±»ï¼Œä¸€ä¸ªæŠ½è±¡å·¥å‚ç±»å¯ä»¥æ´¾ç”Ÿå‡ºå¤šä¸ªå…·ä½“å·¥å‚ç±»ï¼Œæ¯ä¸ªå…·ä½“å·¥å‚ç±»åªèƒ½åˆ›å»ºä¸€ä¸ªå…·ä½“äº§å“ç±»çš„å®ä¾‹ã€‚
æŠ½è±¡å·¥å‚ï¼šå¤šä¸ªæŠ½è±¡äº§å“ç±»ï¼Œæ¯ä¸ªæŠ½è±¡äº§å“ç±»å¯ä»¥æ´¾ç”Ÿå‡ºå¤šä¸ªå…·ä½“äº§å“ç±»ã€‚ä¸€ä¸ªæŠ½è±¡å·¥å‚å¯ä»¥æ´¾ç”Ÿå‡ºå¤šä¸ªå…·ä½“å·¥å‚ç±»ï¼Œæ¯ä¸ªå…·ä½“å·¥å‚ç±»å¯ä»¥åˆ›å»ºå¤šä¸ªå…·ä½“äº§å“ç±»çš„å®ä¾‹ã€‚
å¦‚ä¸Šä¾‹ï¼Œäº§å“æœ‰ç¼–ç å™¨ã€ç¼–ç æ ¼å¼ä¸¤ä¸ªç»´åº¦ï¼Œå·¥å‚çš„ä¸åŒå­ç±»å¯¹åº”ä¸åŒçš„ç¼–ç æ ¼å¼ï¼Œæ¯ä¸ªå­ç±»æä¾›è¯¥æ ¼å¼çš„ä¸åŒç±»å‹çš„ç¼–ç å™¨ã€‚</p>

<h2 id="åŸå‹æ¨¡å¼">åŸå‹æ¨¡å¼</h2>
<p>ç”¨åŸå‹å®ä¾‹æŒ‡å®šåˆ›å»ºå¯¹è±¡çš„ç§ç±»ï¼Œå¹¶ä¸”é€šè¿‡æ‹·è´è¿™äº›åŸå‹åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚
æŠ½è±¡å·¥å‚æ¨¡å¼å®ç°äº†å¹³è¡Œçš„ç»§æ‰¿æ‰©å±•ï¼Œä½†å½“äº§å“ç±»å‹è¿‡å¤šæ—¶ï¼Œå¾€å¾€éœ€è¦å®ç°ä¸€ä¸ªåºå¤§çš„ç»§æ‰¿ä½“ç³»ï¼Œå˜å¾—ä¸çµæ´»ã€‚è¿™æ—¶å¯ä»¥ä½¿ç”¨æŠ½è±¡å·¥å‚çš„å˜å½¢ï¼šåŸå‹æ¨¡å¼ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">Sea</span> <span class="p">{}</span>
<span class="kd">class</span> <span class="nc">EarthSea</span> <span class="kd">extends</span> <span class="nc">Sea</span> <span class="p">{}</span>
<span class="kd">class</span> <span class="nc">MarsSea</span> <span class="kd">extends</span> <span class="nc">Sea</span> <span class="p">{}</span>

<span class="kd">class</span> <span class="nc">Plains</span> <span class="p">{}</span>
<span class="kd">class</span> <span class="nc">EarthPlains</span> <span class="kd">extends</span> <span class="nc">Plains</span> <span class="p">{}</span>
<span class="kd">class</span> <span class="nc">MarsPlains</span> <span class="kd">extends</span> <span class="nc">Plains</span> <span class="p">{}</span>

<span class="kd">class</span> <span class="nc">Forest</span> <span class="p">{}</span>
<span class="kd">class</span> <span class="nc">EarthForest</span> <span class="kd">extends</span> <span class="nc">Forest</span> <span class="p">{}</span>
<span class="kd">class</span> <span class="nc">MarsForest</span> <span class="kd">extends</span> <span class="nc">Forest</span> <span class="p">{}</span>

<span class="kd">class</span> <span class="nc">TerrainFactory</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$sea</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$forest</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$plains</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span> <span class="kt">Sea</span> <span class="nv">$sea</span><span class="p">,</span> <span class="kt">Plains</span> <span class="nv">$plains</span><span class="p">,</span> <span class="kt">Forest</span> <span class="nv">$forest</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sea</span> <span class="o">=</span> <span class="nv">$sea</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">plains</span> <span class="o">=</span> <span class="nv">$plains</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">forest</span> <span class="o">=</span> <span class="nv">$forest</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getSea</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">clone</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sea</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getPlains</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">clone</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">plains</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getForest</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">clone</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">forest</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TerrainFactory</span><span class="p">(</span> <span class="k">new</span> <span class="nc">EarthSea</span><span class="p">(),</span><span class="k">new</span> <span class="nc">EarthPlains</span><span class="p">(),</span><span class="k">new</span> <span class="nc">EarthForest</span><span class="p">()</span> <span class="p">);</span>
<span class="nb">print_r</span><span class="p">(</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="nf">getSea</span><span class="p">()</span> <span class="p">);</span>
<span class="nb">print_r</span><span class="p">(</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="nf">getPlains</span><span class="p">()</span> <span class="p">);</span>
<span class="nb">print_r</span><span class="p">(</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="nf">getForest</span><span class="p">()</span> <span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p>ä»¥ä¸Šåœ¨åˆå§‹åŒ–å·¥å‚çš„æ—¶å€™ï¼Œä¼ å…¥äº†ä¸åŒç±»çš„å®ä¾‹ç”¨äºåˆå§‹åŒ–å·¥å‚ã€‚å½“éœ€è¦æ–°çš„ç±»å‹å®ä¾‹æ—¶ï¼Œæ— é¡»å†™ä¸€ä¸ªæ–°çš„åˆ›å»ºè€…ç±»ï¼Œåªéœ€è¦ç®€å•åœ°æ”¹å˜åˆ›å»ºå·¥å‚æ—¶æä¾›çš„å‚æ•°ï¼Œå¦‚ï¼š
	$factory = new TerrainFactory( new EarthSea(),new MarsPlains(),new MarsForest() );</p>

<p>åŒæ ·æ˜¯å¹³è¡Œæ‰©å±•ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼åŸºäºç»§æ‰¿å®ç°ï¼ŒåŸå‹æ¨¡å¼åŸºäºç»„åˆå®ç°ã€‚</p>

<h2 id="ç»„åˆæ¨¡å¼">ç»„åˆæ¨¡å¼</h2>
<p>æ•´ä½“å’Œå±€éƒ¨å¯ä»¥äº’æ¢ï¼Œå³å®¹å™¨å¯¹è±¡å’Œå®ƒä»¬åŒ…å«çš„å¯¹è±¡å…±äº«ç›¸åŒçš„æ¥å£ã€‚æ¯”å¦‚ä¸€ä¸ªå£«å…µã€ä¸€è¾†å¦å…‹æœ‰å®ƒä»¬çš„æˆ˜æ–—åŠ›å€¼ï¼Œä¸€ä¸ªç”±å£«å…µã€å¦å…‹ç»„æˆçš„å†›é˜Ÿï¼ˆä¸€ä¸ªé›†åˆï¼‰ä¹Ÿæœ‰å®ƒçš„æˆ˜æ–—åŠ›å€¼ã€‚å£«å…µã€å¦å…‹ã€å†›é˜Ÿï¼Œå®ƒä»¬éƒ½å¯ä»¥å®šä¹‰ä¸ºå•å…ƒï¼Œæ‹¥æœ‰å…±åŒçš„æ¥å£ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">addUnit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$unit</span> <span class="p">);</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">removeUnit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$unit</span> <span class="p">);</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">bombardStrength</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Army</span> <span class="kd">extends</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$units</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">function</span> <span class="n">addUnit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$unit</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">in_array</span><span class="p">(</span> <span class="nv">$unit</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">units</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">units</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$unit</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">removeUnit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$unit</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">units</span> <span class="o">=</span> <span class="nb">array_udiff</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">units</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span> <span class="nv">$unit</span> <span class="p">),</span> 
                      <span class="k">function</span><span class="p">(</span> <span class="nv">$a</span><span class="p">,</span> <span class="nv">$b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="nv">$a</span> <span class="o">===</span> <span class="nv">$b</span><span class="p">)</span><span class="o">?</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="p">}</span> <span class="p">);</span>
    <span class="p">}</span>

<span class="c1">// è®¡ç®—å†›é˜Ÿçš„æˆ˜æ–—åŠ›</span>
    <span class="k">function</span> <span class="n">bombardStrength</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">foreach</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">units</span> <span class="k">as</span> <span class="nv">$unit</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$ret</span> <span class="o">+=</span> <span class="nv">$unit</span><span class="o">-&gt;</span><span class="nf">bombardStrength</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Tank</span> <span class="kd">extends</span> <span class="nc">Unit</span> <span class="p">{</span> 
<span class="k">function</span> <span class="n">addUnit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$unit</span> <span class="p">)</span> <span class="p">{}</span>				<span class="c1">// å†—ä½™æ–¹æ³•ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯â€œé€æ˜æ€§â€å¿…é¡»å­˜åœ¨</span>
    <span class="k">function</span> <span class="n">removeUnit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$unit</span> <span class="p">)</span> <span class="p">{}</span>			<span class="c1">// å†—ä½™æ–¹æ³•ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯â€œé€æ˜æ€§â€å¿…é¡»å­˜åœ¨</span>

    <span class="k">function</span> <span class="n">bombardStrength</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Soldier</span> <span class="kd">extends</span> <span class="nc">Unit</span> <span class="p">{</span> 
    <span class="k">function</span> <span class="n">addUnit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$unit</span> <span class="p">)</span> <span class="p">{}</span>				<span class="c1">// å†—ä½™æ–¹æ³•ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯â€œé€æ˜æ€§â€å¿…é¡»å­˜åœ¨</span>
    <span class="k">function</span> <span class="n">removeUnit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$unit</span> <span class="p">)</span> <span class="p">{}</span>			<span class="c1">// å†—ä½™æ–¹æ³•ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯â€œé€æ˜æ€§â€å¿…é¡»å­˜åœ¨</span>

    <span class="k">function</span> <span class="n">bombardStrength</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$tank</span> <span class="o">=</span>  <span class="k">new</span> <span class="nc">Tank</span><span class="p">();</span>
<span class="nv">$tank2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Tank</span><span class="p">();</span>
<span class="nv">$soldier</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Soldier</span><span class="p">();</span>

<span class="nv">$army</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Army</span><span class="p">();</span>
<span class="nv">$army</span><span class="o">-&gt;</span><span class="nf">addUnit</span><span class="p">(</span> <span class="nv">$soldier</span> <span class="p">);</span>
<span class="nv">$army</span><span class="o">-&gt;</span><span class="nf">addUnit</span><span class="p">(</span> <span class="nv">$tank</span> <span class="p">);</span>
<span class="nv">$army</span><span class="o">-&gt;</span><span class="nf">addUnit</span><span class="p">(</span> <span class="nv">$tank2</span> <span class="p">);</span>

<span class="nb">print_r</span><span class="p">(</span> <span class="nv">$army</span> <span class="p">);</span>

<span class="nv">$army</span><span class="o">-&gt;</span><span class="nf">removeUnit</span><span class="p">(</span> <span class="nv">$tank2</span> <span class="p">);</span>

<span class="nb">print_r</span><span class="p">(</span> <span class="nv">$army</span> <span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<h2 id="è£…é¥°æ¨¡å¼">è£…é¥°æ¨¡å¼</h2>
<p>åŠŸèƒ½å®šä¹‰å®Œå…¨ä¾èµ–äºç»§æ‰¿ä½“ç³»ä¼šå¯¼è‡´ç±»çš„æ•°é‡è¿‡å¤šï¼Œè€Œä¸”ä»£ç ä¼šäº§ç”Ÿé‡å¤ã€‚
ä¾‹å¦‚ï¼Œå®šä¹‰ä¸€ä¸ªTileç±»è¡¨ç¤ºä¸€ä¸ªä½œæˆ˜åŒºåŸŸï¼Œå®ƒæœ‰ä¸€ä¸ªæ–¹æ³•getWealthFactor()ç”¨äºè®¡ç®—æŸä¸ªç‰¹å®šåŒºåŸŸè¢«ä¸€ä¸ªç©å®¶æ‰€å æœ‰åçš„æ”¶ç›Šï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">Tile</span> <span class="p">{</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">getWealthFactor</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// å¹³åŸ</span>
<span class="kd">class</span> <span class="nc">Plains</span> <span class="kd">extends</span> <span class="nc">Tile</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$wealthfactor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">function</span> <span class="n">getWealthFactor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">wealthfactor</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å¸¦é’»çŸ³çš„å¹³åŸ</span>
<span class="kd">class</span> <span class="nc">DiamondPlains</span> <span class="kd">extends</span> <span class="nc">Plains</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">getWealthFactor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="nf">getWealthFactor</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// è¢«æ±¡æŸ“çš„å¹³åŸ</span>
<span class="kd">class</span> <span class="nc">PollutedPlains</span> <span class="kd">extends</span> <span class="nc">Plains</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">getWealthFactor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="nf">getWealthFactor</span><span class="p">()</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$tile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PollutedPlains</span><span class="p">();</span>
<span class="k">print</span> <span class="nv">$tile</span><span class="o">-&gt;</span><span class="nf">getWealthFactor</span><span class="p">();</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p>æ­¤æ—¶ï¼Œå¦‚æœæƒ³è¦è·å¾—ä¸€ä¸ªæ—¢å¸¦é’»çŸ³ï¼Œåˆè¢«æ±¡æŸ“çš„å¹³åŸï¼Œå¦‚æœåŸºäºé›†æˆæ¥æ‰©å±•åŠŸèƒ½ï¼Œå°±åªèƒ½åˆ›å»ºä¸€ä¸ªå½¢å¦‚PollutedDiamondPlainsçš„æ–°ç±»ã€‚</p>

<p>è£…é¥°æ¨¡å¼ä½¿ç”¨ç»„åˆå’Œå§”æ‰˜ï¼Œè€Œä¸æ˜¯åªä½¿ç”¨ç»§æ‰¿æ¥è§£å†³åŠŸèƒ½å˜åŒ–é—®é¢˜ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">Tile</span> <span class="p">{</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">getWealthFactor</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Plains</span> <span class="kd">extends</span> <span class="nc">Tile</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$wealthfactor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">function</span> <span class="n">getWealthFactor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">wealthfactor</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å¼•å…¥ä¸€ä¸ªå§”æ‰˜ç±»</span>
<span class="c1">// å§”æ‰˜ç±»ç»§æ‰¿è‡ªTileï¼Œå› æ­¤ä¸Tileçš„å¯¹è±¡æœ‰ç›¸åŒçš„æ“ä½œæ¥å£</span>
<span class="c1">// å§”æ‰˜ç±»è¿˜åŒ…å«ä¸€ä¸ªæŒ‡å‘Tileçš„å¼•ç”¨ï¼Œç”¨äºå®ç°é“¾å¼æ“ä½œï¼Œåœ¨è¿è¡Œæ—¶è½»æ¾åˆå¹¶å¯¹è±¡</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">TileDecorator</span> <span class="kd">extends</span> <span class="nc">Tile</span> <span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$tile</span><span class="p">;</span>
    <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span> <span class="kt">Tile</span> <span class="nv">$tile</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tile</span> <span class="o">=</span> <span class="nv">$tile</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">DiamondDecorator</span> <span class="kd">extends</span> <span class="nc">TileDecorator</span> <span class="p">{</span>
    <span class="c1">// åœ¨è£…é¥°å™¨ç±»ä¸­æ‰©å±•åŠŸèƒ½</span>
<span class="k">function</span> <span class="n">getWealthFactor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tile</span><span class="o">-&gt;</span><span class="nf">getWealthFactor</span><span class="p">()</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">PollutionDecorator</span> <span class="kd">extends</span> <span class="nc">TileDecorator</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">getWealthFactor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tile</span><span class="o">-&gt;</span><span class="nf">getWealthFactor</span><span class="p">()</span><span class="o">-</span><span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$tile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Plains</span><span class="p">();</span>
<span class="k">print</span> <span class="nv">$tile</span><span class="o">-&gt;</span><span class="nf">getWealthFactor</span><span class="p">();</span> 			<span class="c1">// 2</span>

<span class="nv">$tile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DiamondDecorator</span><span class="p">(</span> <span class="k">new</span> <span class="nc">Plains</span><span class="p">()</span> <span class="p">);</span>
<span class="k">print</span> <span class="nv">$tile</span><span class="o">-&gt;</span><span class="nf">getWealthFactor</span><span class="p">();</span>			 <span class="c1">// 4</span>

<span class="nv">$tile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PollutionDecorator</span><span class="p">(</span> <span class="k">new</span> <span class="nc">DiamondDecorator</span><span class="p">(</span> <span class="k">new</span> <span class="nc">Plains</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
<span class="k">print</span> <span class="nv">$tile</span><span class="o">-&gt;</span><span class="nf">getWealthFactor</span><span class="p">();</span> 			<span class="c1">// 0</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<h2 id="å¤–è§‚æ¨¡å¼">å¤–è§‚æ¨¡å¼</h2>
<p>å¤–è§‚æ¨¡å¼æ˜¯ä¸€ä¸ªååˆ†ç®€å•çš„æ¦‚å¿µï¼Œå®ƒåªæ˜¯ä¸ºä¸€ä¸ªåˆ†å±‚æˆ–è€…ä¸€ä¸ªå­ç³»ç»Ÿåˆ›å»ºä¸€ä¸ªå•ä¸€çš„å…¥å£ï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯ä»£ç çš„ä½¿ç”¨ï¼Œé¿å…å®¢æˆ·ç«¯ä»£ç ä½¿ç”¨å­ç³»ç»Ÿå¤æ‚çš„å†…éƒ¨æ–¹æ³•ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ProductFacade</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$products</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span> <span class="nv">$file</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="nv">$file</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">compile</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">compile</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// å¤æ‚çš„æ“ä½œ</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getProducts</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">products</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getProduct</span><span class="p">(</span> <span class="nv">$id</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">products</span><span class="p">[</span><span class="nv">$id</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$facade</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProductFacade</span><span class="p">(</span> <span class="s1">'test.txt'</span> <span class="p">);</span>
<span class="nv">$object</span> <span class="o">=</span> <span class="nv">$facade</span><span class="o">-&gt;</span><span class="nf">getProduct</span><span class="p">(</span> <span class="mi">234</span> <span class="p">);</span>
</code></pre></div></div>

<h2 id="è§£é‡Šå™¨æ¨¡å¼">è§£é‡Šå™¨æ¨¡å¼</h2>
<p>æ„é€ ä¸€ä¸ªå¯ä»¥ç”¨äºåˆ›å»ºè„šæœ¬åŒ–åº”ç”¨çš„è¿·ä½ è¯­è¨€è§£é‡Šå™¨ã€‚
[ç•¥]</p>

<h2 id="ç­–ç•¥æ¨¡å¼">ç­–ç•¥æ¨¡å¼</h2>
<p>ç­–ç•¥æ¨¡å¼å®šä¹‰äº†ä¸€ç³»åˆ—çš„ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸€ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œè€Œä¸”ä½¿å®ƒä»¬è¿˜å¯ä»¥ç›¸äº’æ›¿æ¢ã€‚ç­–ç•¥æ¨¡å¼è®©ç®—æ³•ç‹¬ç«‹äºä½¿ç”¨å®ƒçš„å®¢æˆ·è€Œç‹¬ç«‹å˜åŒ–ã€‚
ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªæµ‹éªŒé—®é¢˜ç±»Questionï¼Œè¿˜æœ‰ä¸€ä¸ªmark()æ–¹æ³•ç”¨æ¥è¡¨ç¤ºå›ç­”ã€‚å½“ç”¨æˆ·å›ç­”é—®é¢˜æ—¶å¯ä»¥ä¸ºç­”æ¡ˆé€‰æ‹©ä¸åŒçš„æ ‡è®°æ–¹å¼ï¼Œå› æ­¤ç»§æ‰¿Questionç±»æ¥å®ç°é’ˆå¯¹ä¸åŒå›ç­”æ–¹å¼çš„å­ç±»ï¼Œå¦‚MarkLogicQuestionã€MatchQuestionã€RegexpQuestionã€‚æ­¤æ—¶ï¼Œå¦‚æœæ–°å¢éœ€æ±‚ï¼Œè¦æ±‚æ”¯æŒä¸åŒç±»å‹çš„é—®é¢˜ï¼Œå¦‚TextQuestionã€AVQuestionï¼Œè€Œæ¯ç§é—®é¢˜åˆåŒæ ·è¦æ”¯æŒä¹‹å‰çš„3ç§æ ‡è®°è¯­è¨€ï¼Œå¦‚æœå®Œå…¨ä¾èµ–ç»§æ‰¿ï¼Œåˆ™éœ€è¦åˆ›å»º6ä¸ªç±»ã€‚
â€œç»„åˆä¼˜äºç»§æ‰¿â€ï¼Œåªè¦å‘ç°æ­£åœ¨ä¸æ–­åœ°åœ¨ç»§æ‰¿æ ‘çš„å„ä¸ªåˆ†æ”¯ä¸­é‡å¤åŒä¸€ä¸ªç®—æ³•ï¼Œæ— è®ºæ˜¯é€šè¿‡å­ç±»è¿˜æ˜¯é€šè¿‡é‡å¤æ¡ä»¶è¯­å¥ï¼Œåº”è¯¥å°†è¿™äº›ç®—æ³•æŠ½è±¡æˆç‹¬ç«‹çš„ç±»å‹ã€‚è¯¥ä¾‹ä¸­çš„â€œç®—æ³•â€ï¼Œå³mark()æ–¹æ³•ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">Question</span> <span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$prompt</span><span class="p">;</span>		<span class="c1">// é—®é¢˜æç¤º</span>
    <span class="k">protected</span> <span class="nv">$marker</span><span class="p">;</span>		<span class="c1">// ç­”æ¡ˆæ ‡è®°å¯¹è±¡</span>

    <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span> <span class="nv">$prompt</span><span class="p">,</span> <span class="kt">Marker</span> <span class="nv">$marker</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">prompt</span><span class="o">=</span><span class="nv">$prompt</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">marker</span><span class="o">=</span><span class="nv">$marker</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">mark</span><span class="p">(</span> <span class="nv">$response</span> <span class="p">)</span> <span class="p">{</span>		<span class="c1">// ç®—æ³•ï¼šæ ‡è®°ç”¨æˆ·çš„å›ç­”</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">marker</span><span class="o">-&gt;</span><span class="nf">mark</span><span class="p">(</span> <span class="nv">$response</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">TextQuestion</span> <span class="kd">extends</span> <span class="nc">Question</span> <span class="p">{</span>
    <span class="c1">// æ–‡æœ¬ç±»å‹çš„é—®é¢˜</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">AVQuestion</span> <span class="kd">extends</span> <span class="nc">Question</span> <span class="p">{</span>
    <span class="c1">// AVç±»å‹çš„é—®é¢˜</span>
<span class="p">}</span>

<span class="c1">// ç­”æ¡ˆæ ‡è®°å¤„ç†ç±»</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">Marker</span> <span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$test</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span> <span class="nv">$test</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">test</span> <span class="o">=</span> <span class="nv">$test</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">abstract</span> <span class="k">function</span> <span class="n">mark</span><span class="p">(</span> <span class="nv">$response</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">MarkLogicMarker</span> <span class="kd">extends</span> <span class="nc">Marker</span> <span class="p">{</span>		<span class="c1">// mark()ç®—æ³•å®ç°1</span>
    <span class="k">function</span> <span class="n">mark</span><span class="p">(</span> <span class="nv">$response</span> <span class="p">)</span> <span class="p">{</span>
        <span class="mf">...</span>
<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">MatchMarker</span> <span class="kd">extends</span> <span class="nc">Marker</span> <span class="p">{</span>			<span class="c1">// mark()ç®—æ³•å®ç°2</span>
    <span class="k">function</span> <span class="n">mark</span><span class="p">(</span> <span class="nv">$response</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">test</span> <span class="o">==</span> <span class="nv">$response</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">RegexpMarker</span> <span class="kd">extends</span> <span class="nc">Marker</span> <span class="p">{</span>			<span class="c1">// mark()ç®—æ³•å®ç°3</span>
    <span class="k">function</span> <span class="n">mark</span><span class="p">(</span> <span class="nv">$response</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span> <span class="nb">preg_match</span><span class="p">(</span> <span class="s2">"</span><span class="nv">$this-&gt;test</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$response</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨</span>
<span class="c1">// æ„é€ 3ä¸ªç­–ç•¥å¯¹è±¡</span>
<span class="nv">$markers</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>	
<span class="k">new</span> <span class="nc">RegexpMarker</span><span class="p">(</span> <span class="s2">"/f.ve/"</span> <span class="p">),</span>
 			<span class="k">new</span> <span class="nc">MatchMarker</span><span class="p">(</span> <span class="s2">"five"</span> <span class="p">),</span>
    		<span class="k">new</span> <span class="nc">MarkLogicMarker</span><span class="p">(</span> <span class="s1">'$input equals "five"'</span> <span class="p">)</span>
		<span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span> <span class="nv">$markers</span> <span class="k">as</span> <span class="nv">$marker</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="nb">get_class</span><span class="p">(</span> <span class="nv">$marker</span> <span class="p">)</span><span class="mf">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="c1">// ç”¨ç­–ç•¥å¯¹è±¡æ¥å¤„ç†é—®é¢˜</span>
    <span class="nv">$question</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TextQuestion</span><span class="p">(</span> <span class="s2">"how many beans make five"</span><span class="p">,</span> <span class="nv">$marker</span> <span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span> <span class="k">array</span><span class="p">(</span> <span class="s2">"five"</span><span class="p">,</span> <span class="s2">"four"</span> <span class="p">)</span> <span class="k">as</span> <span class="nv">$response</span> <span class="p">)</span> <span class="p">{</span> 
        <span class="k">print</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">response: </span><span class="nv">$response</span><span class="s2">: "</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$question</span><span class="o">-&gt;</span><span class="nf">mark</span><span class="p">(</span> <span class="nv">$response</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">print</span> <span class="s2">"well done</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">print</span> <span class="s2">"never mind</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>

<h2 id="è§‚å¯Ÿè€…æ¨¡å¼">è§‚å¯Ÿè€…æ¨¡å¼</h2>
<p>è§‚å¯Ÿè€…æ¨¡å¼çš„æ ¸å¿ƒæ˜¯æŠŠå®¢æˆ·å…ƒç´ ï¼ˆè§‚å¯Ÿè€…ï¼‰ä»ä¸€ä¸ªä¸­å¿ƒç±»ï¼ˆä¸»ä½“ï¼Œè¢«è§‚å¯Ÿè€…ï¼‰ä¸­åˆ†ç¦»å‡ºæ¥ã€‚å½“ä¸»ä½“çŸ¥é“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè§‚å¯Ÿè€…éœ€è¦è¢«é€šçŸ¥åˆ°ï¼ŒåŒæ—¶ä¸èƒ½å°†ä¸»ä½“ä¸è§‚å¯Ÿè€…ä¹‹é—´çš„å…³ç³»è¿›è¡Œç¡¬ç¼–ç ã€‚
ä¸ºè¾¾åˆ°ä»¥ä¸Šç›®çš„ï¼Œéœ€è¦å¼ºåˆ¶ä¸»ä½“å®ç°Observableæ¥å£ï¼Œå¼ºåˆ¶è§‚å¯Ÿè€…å®ç°Observeræ¥å£ï¼Œå¹¶å…è®¸è§‚å¯Ÿè€…åœ¨ä¸»ä½“ä¸Šè¿›è¡Œæ³¨å†Œã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="c1">// è¢«è§‚å¯Ÿçš„ä¸»ä½“éœ€è¦å®ç°è¯¥æ¥å£</span>
<span class="kd">interface</span> <span class="nc">Observable</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">attach</span><span class="p">(</span> <span class="kt">Observer</span> <span class="nv">$observer</span> <span class="p">);</span>		<span class="c1">// æ³¨å†Œè§‚å¯Ÿè€…</span>
    <span class="k">function</span> <span class="n">detach</span><span class="p">(</span> <span class="kt">Observer</span> <span class="nv">$observer</span> <span class="p">);</span>		<span class="c1">// åˆ é™¤è§‚å¯Ÿè€…</span>
    <span class="k">function</span> <span class="n">notify</span><span class="p">();</span>						<span class="c1">// é€šçŸ¥å˜åŒ–</span>
<span class="p">}</span>

<span class="c1">// è§‚å¯Ÿè€…éœ€è¦å®ç°è¯¥æ¥å£</span>
<span class="kd">interface</span> <span class="nc">Observer</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">update</span><span class="p">(</span> <span class="kt">Observable</span> <span class="nv">$observable</span> <span class="p">);</span>	<span class="c1">// å½“å…³æ³¨çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè§¦å‘çš„æ–¹æ³•</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Login</span> <span class="kd">implements</span> <span class="nc">Observable</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$observers</span><span class="p">;</span>						<span class="c1">// è§‚å¯Ÿè€…åˆ—è¡¨</span>
    <span class="k">private</span> <span class="nv">$storage</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">LOGIN_USER_UNKNOWN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">LOGIN_WRONG_PASS</span>    <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">LOGIN_ACCESS</span>          <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">observers</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">attach</span><span class="p">(</span> <span class="kt">Observer</span> <span class="nv">$observer</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">observers</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$observer</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">detach</span><span class="p">(</span> <span class="kt">Observer</span> <span class="nv">$observer</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">observers</span> <span class="o">=</span> <span class="nb">array_udiff</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">observers</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span> <span class="nv">$observer</span> <span class="p">),</span> 
                        <span class="k">function</span><span class="p">(</span> <span class="nv">$a</span><span class="p">,</span> <span class="nv">$b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="nv">$a</span> <span class="o">===</span> <span class="nv">$b</span><span class="p">)</span><span class="o">?</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="p">}</span> <span class="p">);</span>
    <span class="p">}</span>

<span class="c1">// å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œé€ä¸€é€šçŸ¥è§‚å¯Ÿè€…</span>
    <span class="k">function</span> <span class="n">notify</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">observers</span> <span class="k">as</span> <span class="nv">$obs</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$obs</span><span class="o">-&gt;</span><span class="nf">update</span><span class="p">(</span> <span class="nv">$this</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">handleLogin</span><span class="p">(</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$pass</span><span class="p">,</span> <span class="nv">$ip</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> 
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setStatus</span><span class="p">(</span> <span class="k">self</span><span class="o">::</span><span class="no">LOGIN_ACCESS</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$ip</span> <span class="p">);</span>
                <span class="nv">$ret</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setStatus</span><span class="p">(</span> <span class="k">self</span><span class="o">::</span><span class="no">LOGIN_WRONG_PASS</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$ip</span> <span class="p">);</span>
                <span class="nv">$ret</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setStatus</span><span class="p">(</span> <span class="k">self</span><span class="o">::</span><span class="no">LOGIN_USER_UNKNOWN</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$ip</span> <span class="p">);</span>
                <span class="nv">$ret</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">notify</span><span class="p">();</span>		<span class="c1">// æ‰§è¡Œäº‹ä»¶é€šçŸ¥</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">setStatus</span><span class="p">(</span> <span class="nv">$status</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$ip</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="nv">$status</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$ip</span> <span class="p">);</span> 
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getStatus</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// æ‰€æœ‰éœ€è¦å…³æ³¨Loginäº‹ä»¶çš„ç±»éœ€è¦ç»§æ‰¿æ­¤ç±»</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">LoginObserver</span> <span class="kd">implements</span> <span class="nc">Observer</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$login</span><span class="p">;</span>		
    <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span> <span class="kt">Login</span> <span class="nv">$login</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">login</span> <span class="o">=</span> <span class="nv">$login</span><span class="p">;</span> 
        <span class="nv">$login</span><span class="o">-&gt;</span><span class="nf">attach</span><span class="p">(</span> <span class="nv">$this</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">update</span><span class="p">(</span> <span class="kt">Observable</span> <span class="nv">$observable</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// åˆ¤æ–­ä½¿ç”¨çš„æ˜¯è‡ªå·±è¢«æ³¨å†Œçš„Loginå¯¹è±¡ï¼Œè€Œä¸æ˜¯ä»»æ„çš„Observableå¯¹è±¡</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$observable</span> <span class="o">===</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">login</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">doUpdate</span><span class="p">(</span> <span class="nv">$observable</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">abstract</span> <span class="k">function</span> <span class="n">doUpdate</span><span class="p">(</span> <span class="kt">Login</span> <span class="nv">$login</span> <span class="p">);</span>
<span class="p">}</span> 

<span class="c1">// Loginäº‹ä»¶å‘ç”Ÿåéœ€è¦æ‰§è¡Œçš„é€»è¾‘1</span>
<span class="kd">class</span> <span class="nc">SecurityMonitor</span> <span class="kd">extends</span> <span class="nc">LoginObserver</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">doUpdate</span><span class="p">(</span> <span class="kt">Login</span> <span class="nv">$login</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$login</span><span class="o">-&gt;</span><span class="nf">getStatus</span><span class="p">();</span> 
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nc">Login</span><span class="o">::</span><span class="no">LOGIN_WRONG_PASS</span> <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// send mail to sysadmin </span>
            <span class="k">print</span> <span class="k">__CLASS__</span><span class="mf">.</span><span class="s2">":</span><span class="se">\t</span><span class="s2">sending mail to sysadmin</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span> 
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Loginäº‹ä»¶å‘ç”Ÿåéœ€è¦æ‰§è¡Œçš„é€»è¾‘2</span>
<span class="kd">class</span> <span class="nc">GeneralLogger</span>  <span class="kd">extends</span> <span class="nc">LoginObserver</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">doUpdate</span><span class="p">(</span> <span class="kt">Login</span> <span class="nv">$login</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$login</span><span class="o">-&gt;</span><span class="nf">getStatus</span><span class="p">();</span> 
        <span class="c1">// add login data to log</span>
        <span class="k">print</span> <span class="k">__CLASS__</span><span class="mf">.</span><span class="s2">":</span><span class="se">\t</span><span class="s2">add login data to log</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span> 
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Loginäº‹ä»¶å‘ç”Ÿåéœ€è¦æ‰§è¡Œçš„é€»è¾‘3</span>
<span class="kd">class</span> <span class="nc">PartnershipTool</span> <span class="kd">extends</span> <span class="nc">LoginObserver</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">doUpdate</span><span class="p">(</span> <span class="kt">Login</span> <span class="nv">$login</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$login</span><span class="o">-&gt;</span><span class="nf">getStatus</span><span class="p">();</span> 
        <span class="c1">// check $ip address </span>
        <span class="c1">// set cookie if it matches a list</span>
        <span class="k">print</span> <span class="k">__CLASS__</span><span class="mf">.</span><span class="s2">":</span><span class="se">\t</span><span class="s2">set cookie if it matches a list</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span> 
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨</span>
<span class="nv">$login</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Login</span><span class="p">();</span>
<span class="k">new</span> <span class="nc">SecurityMonitor</span><span class="p">(</span> <span class="nv">$login</span> <span class="p">);</span>  	<span class="c1">// æ³¨å†Œ1</span>
<span class="k">new</span> <span class="nc">GeneralLogger</span><span class="p">(</span> <span class="nv">$login</span> <span class="p">);</span>		<span class="c1">// æ³¨å†Œ2</span>
<span class="nv">$pt</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PartnershipTool</span><span class="p">(</span> <span class="nv">$login</span> <span class="p">);</span>
<span class="nv">$login</span><span class="o">-&gt;</span><span class="nf">detach</span><span class="p">(</span> <span class="nv">$pt</span> <span class="p">);</span>
<span class="k">for</span> <span class="p">(</span> <span class="nv">$x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$x</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="nv">$x</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nv">$login</span><span class="o">-&gt;</span><span class="nf">handleLogin</span><span class="p">(</span> <span class="s2">"bob"</span><span class="p">,</span><span class="s2">"mypass"</span><span class="p">,</span> <span class="s1">'158.152.55.35'</span> <span class="p">);</span>
    <span class="k">print</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>
<h2 id="è®¿é—®è€…æ¨¡å¼">è®¿é—®è€…æ¨¡å¼</h2>
<p>è®¿é—®è€…è¡¨ç¤ºä¸€ä¸ªä½œç”¨äºæŸå¯¹è±¡ç»“æ„ä¸­çš„å„å…ƒç´ çš„æ“ä½œã€‚å®ƒä½¿å¾—å¯ä»¥åœ¨ä¸æ”¹å˜å„å…ƒç´ ç±»çš„å‰æä¸‹å®šä¹‰ä½œç”¨äºè¿™äº›å…ƒç´ çš„æ–°æ“ä½œã€‚æŠŠæ•°æ®ç»“æ„å’Œä½œç”¨äºç»“æ„ä¸Šçš„æ“ä½œè§£è€¦åˆï¼Œä½¿å¾—æ“ä½œé›†åˆå¯ç›¸å¯¹è‡ªç”±åœ°æ¼”åŒ–ã€‚é€‚ç”¨äºæ•°æ®ç»“æ„ç›¸å¯¹ç¨³å®šç®—æ³•åˆæ˜“å˜åŒ–çš„ç³»ç»Ÿã€‚
å¦‚ä¸‹åœ¨Unitç±»æ—çš„åŸºç¡€ä¸Šæ·»åŠ æ–°çš„åŠŸèƒ½ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="cm">/* 
åº”ç”¨ç»„åˆæ¨¡å¼å®ç°çš„Unitç±»æ—
 */</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>						<span class="c1">// èŠ‚ç‚¹æ·±åº¦</span>

    <span class="k">function</span> <span class="n">getComposite</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">protected</span> <span class="k">function</span> <span class="n">setDepth</span><span class="p">(</span> <span class="nv">$depth</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">depth</span><span class="o">=</span><span class="nv">$depth</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getDepth</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">abstract</span> <span class="k">function</span> <span class="n">bombardStrength</span><span class="p">();</span>			<span class="c1">// ç»„åˆæ¨¡å¼çš„ç»Ÿä¸€æ¥å£</span>

    <span class="k">function</span> <span class="n">accept</span><span class="p">(</span> <span class="kt">ArmyVisitor</span> <span class="nv">$visitor</span> <span class="p">)</span> <span class="p">{</span>		<span class="c1">// æ¥æ”¶ä¸€ä¸ªè®¿é—®è€…å¯¹è±¡</span>
        <span class="nv">$method</span> <span class="o">=</span> <span class="s2">"visit"</span><span class="mf">.</span><span class="nb">get_class</span><span class="p">(</span> <span class="nv">$this</span> <span class="p">);</span>		<span class="c1">// æ‹¼å‡‘è®¿é—®è€…å¯¹è±¡çš„æ–¹æ³•ï¼Œå¦‚å½“å‰å¯¹è±¡æ˜¯ä¸€ä¸ªåä¸ºArcherçš„Unitçš„å­ç±»çš„å¯¹è±¡ï¼Œåˆ™æ‹¼å‡‘å‡ºæ¥çš„æ–¹æ³•åä¸ºï¼švisitArcher()</span>
        <span class="nv">$visitor</span><span class="o">-&gt;</span><span class="nv">$method</span><span class="p">(</span> <span class="nv">$this</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä¸€ç§å•èŠ‚ç‚¹å•å…ƒ</span>
<span class="kd">class</span> <span class="nc">Archer</span> <span class="kd">extends</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">bombardStrength</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// ä¸€ç§å•èŠ‚ç‚¹å•å…ƒ</span>
<span class="kd">class</span> <span class="nc">Cavalry</span> <span class="kd">extends</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">bombardStrength</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä¸€ç§å•èŠ‚ç‚¹å•å…ƒ</span>
<span class="kd">class</span> <span class="nc">LaserCanonUnit</span> <span class="kd">extends</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">bombardStrength</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">44</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å¤šèŠ‚ç‚¹å•å…ƒçš„åŸºç±»</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">CompositeUnit</span> <span class="kd">extends</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$units</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">function</span> <span class="n">getComposite</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">units</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">units</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">removeUnit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$unit</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$units</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">units</span> <span class="k">as</span> <span class="nv">$thisunit</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nv">$unit</span> <span class="o">!==</span> <span class="nv">$thisunit</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nv">$units</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$thisunit</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">units</span> <span class="o">=</span> <span class="nv">$units</span><span class="p">;</span>
    <span class="p">}</span>

<span class="c1">// å¤šèŠ‚ç‚¹å¯¹è±¡åœ¨æ¥å—è®¿é—®è€…å¯¹è±¡æ—¶è¡Œä¸ºä¸åŒäºå•èŠ‚ç‚¹å¯¹è±¡</span>
    <span class="k">function</span> <span class="n">accept</span><span class="p">(</span> <span class="kt">ArmyVisitor</span> <span class="nv">$visitor</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">accept</span><span class="p">(</span> <span class="nv">$visitor</span> <span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">units</span> <span class="k">as</span> <span class="nv">$thisunit</span> <span class="p">)</span> <span class="p">{</span>  <span class="c1">// æ‰€æœ‰å­èŠ‚ç‚¹ä¹Ÿåº”è¯¥å¯ä»¥è¢«è¯¥è®¿é—®è€…å¯¹è±¡æ‰€è®¿é—®</span>
            <span class="nv">$thisunit</span><span class="o">-&gt;</span><span class="nf">accept</span><span class="p">(</span> <span class="nv">$visitor</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">addUnit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$unit</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">units</span> <span class="k">as</span> <span class="nv">$thisunit</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nv">$unit</span> <span class="o">===</span> <span class="nv">$thisunit</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$unit</span><span class="o">-&gt;</span><span class="nf">setDepth</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">units</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$unit</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä¸€ç§å¤šèŠ‚ç‚¹å•å…ƒ</span>
<span class="kd">class</span> <span class="nc">TroopCarrier</span> <span class="kd">extends</span> <span class="nc">CompositeUnit</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">addUnit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$unit</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$unit</span> <span class="k">instanceof</span> <span class="nc">Cavalry</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">UnitException</span><span class="p">(</span><span class="s2">"Can't get a horse on the vehicle"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">addUnit</span><span class="p">(</span> <span class="nv">$unit</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">bombardStrength</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä¸€ç§å¤šèŠ‚ç‚¹å•å…ƒ</span>
<span class="kd">class</span> <span class="nc">Army</span> <span class="kd">extends</span> <span class="nc">CompositeUnit</span> <span class="p">{</span>

    <span class="k">function</span> <span class="n">bombardStrength</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">foreach</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">units</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$unit</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$ret</span> <span class="o">+=</span> <span class="nv">$unit</span><span class="o">-&gt;</span><span class="nf">bombardStrength</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ========================================================================</span>
<span class="c1">// è®¿é—®è€…çš„åŸºç±»</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">ArmyVisitor</span>  <span class="p">{</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">visit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$node</span> <span class="p">);</span>

<span class="cm">/*
å®šä¹‰è®¿é—®æ¯ç§å¯è®¿é—®å¯¹è±¡çš„æ¥å£
å®é™…éƒ½æ˜¯é‡å®šå‘åˆ°visit(...)æ–¹æ³•
*/</span>
    <span class="k">function</span> <span class="n">visitArcher</span><span class="p">(</span> <span class="kt">Archer</span> <span class="nv">$node</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">visit</span><span class="p">(</span> <span class="nv">$node</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">function</span> <span class="n">visitCavalry</span><span class="p">(</span> <span class="kt">Cavalry</span> <span class="nv">$node</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">visit</span><span class="p">(</span> <span class="nv">$node</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">visitLaserCanonUnit</span><span class="p">(</span> <span class="kt">LaserCanonUnit</span> <span class="nv">$node</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">visit</span><span class="p">(</span> <span class="nv">$node</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">visitTroopCarrierUnit</span><span class="p">(</span> <span class="kt">TroopCarrierUnit</span> <span class="nv">$node</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">visit</span><span class="p">(</span> <span class="nv">$node</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">visitArmy</span><span class="p">(</span> <span class="kt">Army</span> <span class="nv">$node</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">visit</span><span class="p">(</span> <span class="nv">$node</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// æ¯ä¸€ä¸ªè®¿é—®è€…å­ç±»å³ç›¸å½“äºæä¾›äº†ä¸€ç»„æ–°çš„åŠŸèƒ½</span>
<span class="c1">// ä¸€ç§è®¿é—®è€…</span>
<span class="kd">class</span> <span class="nc">TextDumpArmyVisitor</span> <span class="kd">extends</span> <span class="nc">ArmyVisitor</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$text</span><span class="o">=</span><span class="s2">""</span><span class="p">;</span>
<span class="c1">// é‡å†™visitæ–¹æ³•å®šä¹‰ç‰¹å®šåŠŸèƒ½</span>
    <span class="k">function</span> <span class="n">visit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$node</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$ret</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
        <span class="nv">$pad</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">getDepth</span><span class="p">();</span>			<span class="c1">// ä½¿ç”¨äº†èŠ‚ç‚¹çš„æ–¹æ³•</span>
        <span class="nv">$ret</span> <span class="mf">.</span><span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span> <span class="s2">"%</span><span class="si">{</span><span class="nv">$pad</span><span class="si">}</span><span class="s2">s"</span><span class="p">,</span> <span class="s2">""</span> <span class="p">);</span>
        <span class="nv">$ret</span> <span class="mf">.</span><span class="o">=</span> <span class="nb">get_class</span><span class="p">(</span><span class="nv">$node</span><span class="p">)</span><span class="mf">.</span><span class="s2">": "</span><span class="p">;</span>
        <span class="nv">$ret</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"bombard: "</span><span class="mf">.</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">bombardStrength</span><span class="p">()</span><span class="mf">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">text</span> <span class="mf">.</span><span class="o">=</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>

<span class="c1">// è¯¥è®¿é—®å™¨çš„å¯¹å¤–æ¥å£ï¼šè§¦å‘è®¿é—®çš„å…¥å£</span>
    <span class="k">function</span> <span class="n">getText</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä¸€ç§è®¿é—®è€…</span>
<span class="kd">class</span> <span class="nc">TaxCollectionVisitor</span> <span class="kd">extends</span> <span class="nc">ArmyVisitor</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$due</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$report</span><span class="o">=</span><span class="s2">""</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">visit</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$node</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">levy</span><span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">visitArcher</span><span class="p">(</span> <span class="kt">Archer</span> <span class="nv">$node</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">levy</span><span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">visitCavalry</span><span class="p">(</span> <span class="kt">Cavalry</span> <span class="nv">$node</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">levy</span><span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="mi">3</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">visitTroopCarrierUnit</span><span class="p">(</span> <span class="kt">TroopCarrierUnit</span> <span class="nv">$node</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">levy</span><span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="mi">5</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">levy</span><span class="p">(</span> <span class="kt">Unit</span> <span class="nv">$unit</span><span class="p">,</span> <span class="nv">$amount</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">report</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"Tax levied for "</span><span class="mf">.</span><span class="nb">get_class</span><span class="p">(</span> <span class="nv">$unit</span> <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">report</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">": </span><span class="nv">$amount</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">due</span> <span class="o">+=</span> <span class="nv">$amount</span><span class="p">;</span>
    <span class="p">}</span>

<span class="c1">// è¯¥è®¿é—®å™¨çš„å¯¹å¤–æ¥å£ï¼šè§¦å‘è®¿é—®çš„å…¥å£1</span>
    <span class="k">function</span> <span class="n">getReport</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">report</span><span class="p">;</span>
    <span class="p">}</span>

<span class="c1">// è¯¥è®¿é—®å™¨çš„å¯¹å¤–æ¥å£ï¼šè§¦å‘è®¿é—®çš„å…¥å£2</span>
    <span class="k">function</span> <span class="n">getTax</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">due</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨</span>
<span class="c1">// æ„å»ºä¸€ä¸ªå†›é˜Ÿï¼ˆä¸€ç»„èŠ‚ç‚¹ï¼Œä¸€æ£µæ ‘ï¼‰</span>
<span class="nv">$main_army</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Army</span><span class="p">();</span>
<span class="nv">$main_army</span><span class="o">-&gt;</span><span class="nf">addUnit</span><span class="p">(</span> <span class="k">new</span> <span class="nc">Archer</span><span class="p">()</span> <span class="p">);</span>
<span class="nv">$main_army</span><span class="o">-&gt;</span><span class="nf">addUnit</span><span class="p">(</span> <span class="k">new</span> <span class="nc">LaserCanonUnit</span><span class="p">()</span> <span class="p">);</span>
<span class="nv">$main_army</span><span class="o">-&gt;</span><span class="nf">addUnit</span><span class="p">(</span> <span class="k">new</span> <span class="nc">Cavalry</span><span class="p">()</span> <span class="p">);</span>

<span class="nv">$textdump</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TextDumpArmyVisitor</span><span class="p">();</span>			<span class="c1">// å®ä¾‹åŒ–ä¸€ä¸ªè®¿é—®å™¨</span>
<span class="nv">$main_army</span><span class="o">-&gt;</span><span class="nf">accept</span><span class="p">(</span> <span class="nv">$textdump</span>  <span class="p">);</span>				<span class="c1">// èŠ‚ç‚¹æ•°æ¥å—è¿™ä¸ªè®¿é—®è€…å¯¹è±¡</span>
<span class="k">print</span> <span class="nv">$textdump</span><span class="o">-&gt;</span><span class="nb">getText</span><span class="p">();</span>						<span class="c1">// è®¿é—®ï¼</span>

<span class="nv">$taxcollector</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TaxCollectionVisitor</span><span class="p">();</span>
<span class="nv">$main_army</span><span class="o">-&gt;</span><span class="nf">accept</span><span class="p">(</span> <span class="nv">$taxcollector</span> <span class="p">);</span>
<span class="k">print</span> <span class="nv">$taxcollector</span><span class="o">-&gt;</span><span class="nf">getReport</span><span class="p">();</span>
<span class="k">print</span> <span class="s2">"TOTAL: "</span><span class="p">;</span>
<span class="k">print</span> <span class="nv">$taxcollector</span><span class="o">-&gt;</span><span class="nf">getTax</span><span class="p">()</span><span class="mf">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<h2 id="å‘½ä»¤æ¨¡å¼">å‘½ä»¤æ¨¡å¼</h2>
<p>ä»¥å¯¹è±¡æ¥ä»£è¡¨å®é™…è¡ŒåŠ¨ã€‚å‘½ä»¤å¯¹è±¡å¯ä»¥æŠŠè¡ŒåŠ¨ï¼ˆactionï¼‰åŠå…¶å‚æ•°å°è£…èµ·æ¥ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">CommandNotFoundException</span> <span class="kd">extends</span> <span class="nc">Exception</span> <span class="p">{}</span>

<span class="c1">// é€šè¿‡CommandContextæœºåˆ¶ï¼Œè¯·æ±‚æ•°æ®å¯è¢«ä¼ é€’ç»™Commandå¯¹è±¡ï¼ŒåŒæ—¶å“åº”ä¹Ÿå¯ä»¥è¢«è¿”å›åˆ°è§†å›¾å±‚ </span>
<span class="kd">class</span> <span class="nc">CommandContext</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">private</span> <span class="nv">$error</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">params</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">;</span>		<span class="c1">// å°†è¯·æ±‚å‚æ•°æ˜ å°„åˆ°å‚æ•°åˆ—è¡¨ï¼Œè¯·æ±‚å‚æ•°ä¸­åŒ…å«å‘½ä»¤åç§°ä»¥åŠå…¶ä»–çš„å‚æ•°</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">addParam</span><span class="p">(</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span> <span class="p">)</span> <span class="p">{</span> 
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span><span class="o">=</span><span class="nv">$val</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">get</span><span class="p">(</span> <span class="nv">$key</span> <span class="p">)</span> <span class="p">{</span> 
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">setError</span><span class="p">(</span> <span class="nv">$error</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nv">$error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getError</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ç”Ÿæˆå‘½ä»¤å¯¹è±¡çš„å·¥å‚</span>
<span class="c1">// åœ¨commndsç›®å½•é‡ŒæŸ¥æ‰¾ç‰¹å®šçš„ç±»æ–‡ä»¶</span>
<span class="c1">// å¦‚æœæ–‡ä»¶å’Œç±»éƒ½å­˜åœ¨ï¼Œåˆ™è¿”å›å‘½ä»¤å¯¹è±¡ç»™è°ƒç”¨è€…</span>
<span class="kd">class</span> <span class="nc">CommandFactory</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$dir</span> <span class="o">=</span> <span class="s1">'commands'</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">function</span> <span class="n">getCommand</span><span class="p">(</span> <span class="nv">$action</span><span class="o">=</span><span class="s1">'Default'</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">preg_match</span><span class="p">(</span> <span class="s1">'/\W/'</span><span class="p">,</span> <span class="nv">$action</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">Exception</span><span class="p">(</span><span class="s2">"illegal characters in action"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$class</span> <span class="o">=</span> <span class="nb">UCFirst</span><span class="p">(</span><span class="nb">strtolower</span><span class="p">(</span><span class="nv">$action</span><span class="p">))</span><span class="mf">.</span><span class="s2">"Command"</span><span class="p">;</span>  
        <span class="nv">$file</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nv">$dir</span><span class="mf">.</span><span class="no">DIRECTORY_SEPARATOR</span><span class="mf">.</span><span class="s2">"</span><span class="nv">$class</span><span class="s2">.php"</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">file_exists</span><span class="p">(</span> <span class="nv">$file</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">CommandNotFoundException</span><span class="p">(</span> <span class="s2">"could not find '</span><span class="nv">$file</span><span class="s2">'"</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">require_once</span><span class="p">(</span> <span class="nv">$file</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">class_exists</span><span class="p">(</span> <span class="nv">$class</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">CommandNotFoundException</span><span class="p">(</span> <span class="s2">"no '</span><span class="nv">$class</span><span class="s2">' class located"</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$class</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$cmd</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å‘½ä»¤è°ƒç”¨è€…</span>
<span class="kd">class</span> <span class="nc">Controller</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$context</span><span class="p">;</span>
    <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CommandContext</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getContext</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">process</span><span class="p">()</span> <span class="p">{</span>
<span class="c1">// åœ¨ä¸€ä¸ªWebé¡¹ç›®ä¸­ï¼Œé€‰æ‹©å®ä¾‹åŒ–å“ªä¸ªå‘½ä»¤å¯¹è±¡çš„æœ€ç®€å•çš„åŠæ³•æ˜¯æ ¹æ®è¯·æ±‚æœ¬èº«çš„å‚æ•°æ¥å†³å®š</span>
        <span class="nv">$cmd</span> <span class="o">=</span> <span class="nc">CommandFactory</span><span class="o">::</span><span class="nf">getCommand</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">context</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'action'</span><span class="p">)</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$cmd</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">context</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// å¤„ç†é”™è¯¯</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// æˆåŠŸï¼Œè¿”å›è§†å›¾</span>
        <span class="p">}</span>
    <span class="p">}</span> 
<span class="p">}</span>    

<span class="c1">// ä½¿ç”¨</span>
<span class="nv">$controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Controller</span><span class="p">();</span>

<span class="c1">// è·å–controllerçš„CommandContextï¼Œå¹¶è®¾ç½®å‚æ•°</span>
<span class="nv">$context</span> <span class="o">=</span> <span class="nv">$controller</span><span class="o">-&gt;</span><span class="nf">getContext</span><span class="p">();</span>	
<span class="nv">$context</span><span class="o">-&gt;</span><span class="nf">addParam</span><span class="p">(</span><span class="s1">'action'</span><span class="p">,</span> <span class="s1">'feedback'</span> <span class="p">);</span>  <span class="c1">// æŒ‡å®šå‘½ä»¤åç§°ï¼Œå°†è¢«ç”¨äºæŸ¥æ‰¾ç±»æ–‡ä»¶</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="nf">addParam</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'bob@bob.com'</span> <span class="p">);</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="nf">addParam</span><span class="p">(</span><span class="s1">'topic'</span><span class="p">,</span> <span class="s1">'my brain'</span> <span class="p">);</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="nf">addParam</span><span class="p">(</span><span class="s1">'msg'</span><span class="p">,</span> <span class="s1">'all about my brain'</span> <span class="p">);</span>

<span class="c1">// æ‰§è¡Œå‘½ä»¤</span>
<span class="nv">$controller</span><span class="o">-&gt;</span><span class="nf">process</span><span class="p">();</span>
<span class="k">print</span> <span class="nv">$context</span><span class="o">-&gt;</span><span class="nf">getError</span><span class="p">();</span>

<span class="cp">?&gt;</span>

å‘½ä»¤ç±»çš„å…·ä½“å®ç°ï¼š
	class FeedbackCommand extends Command{
function execute(CommandContext $context){
$email = $context-&gt;get(â€˜emailâ€™);
$msg = $context-&gt;get(â€˜msgâ€™);
...
return true;
}
}

å¯ä»¥å†å®šä¹‰å…¶ä»–çš„å‘½ä»¤ç±»ï¼Œæ¯”å¦‚ï¼š
class LoginCommand extends Command{
function execute(CommandContext $context){
...
}
}
</code></pre></div></div>
<h2 id="æ³¨å†Œè¡¨">æ³¨å†Œè¡¨</h2>
<p>æ³¨å†Œè¡¨æ˜¯è·³å‡ºå±‚çº¦æŸçš„ä¸»è¦é€”å¾„ä¹‹ä¸€ï¼Œå¤§å¤šæ•°æ¨¡å¼åªèƒ½ç”¨åœ¨æŸä¸ªå±‚ï¼Œä½†æ³¨å†Œè¡¨æ˜¯ä¸€ä¸ªä¾‹å¤–ã€‚
æ³¨å†Œè¡¨çš„ä½œç”¨æ˜¯æä¾›ç³»ç»Ÿçº§åˆ«çš„å¯¹è±¡è®¿é—®èƒ½åŠ›ï¼ˆè·¨å±‚ï¼‰ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">woo\base</span><span class="p">;</span>

<span class="c1">// æ³¨å†Œè¡¨åŸºç±»ï¼Œéœ€è¦æ”¯æŒâ€œåº”ç”¨ç¨‹åºä½œç”¨åŸŸâ€çš„æ•°æ®å¯ä»¥ç»§æ‰¿è¯¥ç±»</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">Registry</span> <span class="p">{</span>
    <span class="k">abstract</span> <span class="k">protected</span> <span class="k">function</span> <span class="n">get</span><span class="p">(</span> <span class="nv">$key</span> <span class="p">);</span>
    <span class="k">abstract</span> <span class="k">protected</span> <span class="k">function</span> <span class="n">set</span><span class="p">(</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span> <span class="p">);</span>
<span class="p">}</span>

<span class="c1">// è¯·æ±‚-æä¾›åº”ç”¨ç¨‹åºçº§åˆ«çš„ã€å¯¹è¯·æ±‚å¯¹è±¡çš„è®¿é—®æ¥å£</span>
<span class="kd">class</span> <span class="nc">RequestRegistry</span> <span class="kd">extends</span> <span class="nc">Registry</span> <span class="p">{</span>
    <span class="mf">...</span>
<span class="p">}</span>

<span class="c1">// ä¼šè¯-æä¾›åº”ç”¨ç¨‹åºçº§åˆ«çš„ã€å¯¹ä¼šè¯å¯¹è±¡çš„è®¿é—®æ¥å£</span>
<span class="kd">class</span> <span class="nc">SessionRegistry</span> <span class="kd">extends</span> <span class="nc">Registry</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$instance</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">session_start</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">function</span> <span class="n">instance</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">isset</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="nv">$instance</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span> <span class="k">self</span><span class="o">::</span><span class="nv">$instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">self</span><span class="p">();</span> <span class="p">}</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">::</span><span class="nv">$instance</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">get</span><span class="p">(</span> <span class="nv">$key</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">isset</span><span class="p">(</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="k">__CLASS__</span><span class="p">][</span><span class="nv">$key</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="k">__CLASS__</span><span class="p">][</span><span class="nv">$key</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">set</span><span class="p">(</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$_SESSION</span><span class="p">[</span><span class="k">__CLASS__</span><span class="p">][</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">setComplex</span><span class="p">(</span> <span class="kt">Complex</span> <span class="nv">$complex</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">::</span><span class="nf">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'complex'</span><span class="p">,</span> <span class="nv">$complex</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getComplex</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">::</span><span class="nf">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'complex'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// åº”ç”¨ç¨‹åº-ä»£è¡¨åº”ç”¨ç¨‹åºè‡ªèº«</span>
<span class="kd">class</span> <span class="nc">ApplicationRegistry</span> <span class="kd">extends</span> <span class="nc">Registry</span> <span class="p">{</span>
    <span class="mf">...</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">MemApplicationRegistry</span> <span class="kd">extends</span> <span class="nc">Registry</span> <span class="p">{</span>
    <span class="mf">...</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">AppException</span> <span class="k">extends</span> <span class="err">\</span><span class="nc">Exception</span> <span class="p">{}</span>
<span class="cp">?&gt;</span>

// ä½¿ç”¨
if ( ! isset( $argv[1] ) ) {
    // run script without argument to monitor
    while ( 1 ) {
        sleep(5);
        $thing = \woo\base\ApplicationRegistry::getDSN();

// åˆå§‹åŒ–å„ç§æ³¨å†Œè¡¨
        \woo\base\RequestRegistry::instance();
        \woo\base\SessionRegistry::instance();
        \woo\base\MemApplicationRegistry::instance();

        print "dsn is {$thing}\n";
    }
} else {
    // run script with argument in separate window to change value.. see the result in monitor process
    print "setting dsn {$argv[1]}\n"; 
    \woo\base\ApplicationRegistry::setDSN($argv[1]);
}
</code></pre></div></div>
<h2 id="å‰ç«¯æ§åˆ¶å™¨">å‰ç«¯æ§åˆ¶å™¨</h2>
<p>ç”¨ä¸€ä¸ªä¸­å¿ƒæ¥å¤„ç†æ‰€æœ‰åˆ°æ¥çš„è¯·æ±‚ï¼šå•ä¸€å…¥å£ã€‚
æ‰€æœ‰è¯·æ±‚éƒ½å®šå‘åˆ°index.phpä¸­ï¼Œè¯¥æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š
require(â€œwoo/controller/Controller.phpâ€);
\woo\controller\Controller::run();			// åˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªå‰ç«¯æ§åˆ¶å™¨æ¥å¤„ç†æ‰€æœ‰çš„æ“ä½œ
å‰ç«¯æ§åˆ¶å™¨å§”æ‰˜ApplicationHelperå¯¹è±¡æ¥åˆå§‹åŒ–æ‰§è¡Œç¯å¢ƒï¼Œç„¶åä»CommandResolverå¯¹è±¡è·å–ä¸€ä¸ªCommandå¯¹è±¡ï¼Œæœ€åè°ƒç”¨Command::execute()å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">woo\controller</span><span class="p">;</span>

<span class="c1">// å‰ç«¯æ§åˆ¶å™¨ç±»</span>
<span class="kd">class</span> <span class="nc">Controller</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$applicationHelper</span><span class="p">;</span>				<span class="c1">// è¾…åŠ©ç±»ï¼Œç”¨äºåˆå§‹åŒ–ç¯å¢ƒå˜é‡</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{}</span>

<span class="c1">// æ§åˆ¶å™¨æ‰§è¡Œå…¥å£</span>
    <span class="k">static</span> <span class="k">function</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Controller</span><span class="p">();</span>	
        <span class="nv">$instance</span><span class="o">-&gt;</span><span class="nf">init</span><span class="p">();</span>					<span class="c1">// åˆå§‹åŒ–</span>
        <span class="nv">$instance</span><span class="o">-&gt;</span><span class="nf">handleRequest</span><span class="p">();</span>			<span class="c1">// å¤„ç†è¯·æ±‚</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$applicationHelper</span> <span class="o">=</span> <span class="nc">ApplicationHelper</span><span class="o">::</span><span class="nf">instance</span><span class="p">();</span>
        <span class="nv">$applicationHelper</span><span class="o">-&gt;</span><span class="nf">init</span><span class="p">();</span>
    <span class="p">}</span>

<span class="c1">// å®é™…å¤„ç†è¯·æ±‚çš„åœ°æ–¹</span>
    <span class="k">function</span> <span class="n">handleRequest</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$request</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">woo\controller\Request</span><span class="p">();</span>				<span class="c1">// è¯·æ±‚å¯¹è±¡</span>
        <span class="nv">$cmd_r</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">woo\command\CommandResolver</span><span class="p">();</span>		<span class="c1">// å‘½ä»¤è§£æå¯¹è±¡</span>
        <span class="nv">$cmd</span> <span class="o">=</span> <span class="nv">$cmd_r</span><span class="o">-&gt;</span><span class="nf">getCommand</span><span class="p">(</span> <span class="nv">$request</span> <span class="p">);</span>				<span class="c1">// è·å–å‘½ä»¤å¯¹è±¡</span>
        <span class="nv">$cmd</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span> <span class="nv">$request</span> <span class="p">);</span>							<span class="c1">// å¤„ç†è¯·æ±‚</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// è¾…åŠ©ç±»ï¼Œç”¨äºåˆå§‹åŒ–ç¯å¢ƒå˜é‡ã€‚æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œå¹¶ç”¨æ³¨å†Œè¡¨æ¨¡å¼æ“ä½œåº”ç”¨ç¨‹åºçº§å¯¹è±¡</span>
<span class="kd">class</span> <span class="nc">ApplicationHelper</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$instance</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$config</span> <span class="o">=</span> <span class="s2">"/tmp/data/woo_options.xml"</span><span class="p">;</span>				<span class="c1">// é…ç½®æ–‡ä»¶è·¯å¾„</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{}</span>

    <span class="k">static</span> <span class="k">function</span> <span class="n">instance</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">self</span><span class="o">::</span><span class="nv">$instance</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">::</span><span class="nv">$instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">self</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">::</span><span class="nv">$instance</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$dsn</span> <span class="o">=</span> <span class="err">\</span><span class="nc">woo\base\ApplicationRegistry</span><span class="o">::</span><span class="nf">getDSN</span><span class="p">(</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">is_null</span><span class="p">(</span> <span class="nv">$dsn</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getOptions</span><span class="p">();</span>
     <span class="p">}</span>

     <span class="k">private</span> <span class="k">function</span> <span class="n">getOptions</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">ensure</span><span class="p">(</span> <span class="nb">file_exists</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">config</span>  <span class="p">),</span><span class="s2">"Could not find options file"</span> <span class="p">);</span>
        <span class="nv">$options</span> <span class="o">=</span> <span class="nb">SimpleXml_load_file</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">config</span> <span class="p">);</span>
        <span class="k">print</span> <span class="nb">get_class</span><span class="p">(</span> <span class="nv">$options</span> <span class="p">);</span>
        <span class="nv">$dsn</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="nv">$options</span><span class="o">-&gt;</span><span class="n">dsn</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">ensure</span><span class="p">(</span> <span class="nv">$dsn</span><span class="p">,</span> <span class="s2">"No DSN found"</span> <span class="p">);</span>
        <span class="err">\</span><span class="nc">woo\base\ApplicationRegistry</span><span class="o">::</span><span class="nf">setDSN</span><span class="p">(</span> <span class="nv">$dsn</span> <span class="p">);</span>
        <span class="c1">// set other values</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">ensure</span><span class="p">(</span> <span class="nv">$expr</span><span class="p">,</span> <span class="nv">$message</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$expr</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">woo\base\AppException</span><span class="p">(</span> <span class="nv">$message</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// è¯·æ±‚ç±»</span>
<span class="kd">class</span> <span class="nc">Request</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$properties</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$feedback</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">init</span><span class="p">();</span>
        <span class="err">\</span><span class="nc">woo\base\RequestRegistry</span><span class="o">::</span><span class="nf">setRequest</span><span class="p">(</span><span class="nv">$this</span> <span class="p">);</span>			<span class="c1">// è®¾ç½®åº”ç”¨ç¨‹åºæ³¨å†Œè¡¨ä¸­çš„è¯·æ±‚å¯¹è±¡ä¸ºè‡ªå·±</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">isset</span><span class="p">(</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">properties</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">;</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">foreach</span><span class="p">(</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'argv'</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$arg</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nb">strpos</span><span class="p">(</span> <span class="nv">$arg</span><span class="p">,</span> <span class="s1">'='</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">list</span><span class="p">(</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span> <span class="p">)</span><span class="o">=</span><span class="nb">explode</span><span class="p">(</span> <span class="s2">"="</span><span class="p">,</span> <span class="nv">$arg</span> <span class="p">);</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setProperty</span><span class="p">(</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getProperty</span><span class="p">(</span> <span class="nv">$key</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">isset</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">setProperty</span><span class="p">(</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">function</span> <span class="n">addFeedback</span><span class="p">(</span> <span class="nv">$msg</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nb">array_push</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">feedback</span><span class="p">,</span> <span class="nv">$msg</span> <span class="p">);</span>
    <span class="p">}</span>
 
    <span class="k">function</span> <span class="n">getFeedback</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">feedback</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getFeedbackString</span><span class="p">(</span> <span class="nv">$separator</span><span class="o">=</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">implode</span><span class="p">(</span> <span class="nv">$separator</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">feedback</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="kn">namespace</span> <span class="nn">woo\command</span><span class="p">;</span>
<span class="c1">// å‘½ä»¤å¯¹è±¡çš„åŸºç±»ã€‚å‰ç«¯æ§åˆ¶å™¨çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯æ ¹æ®è¯·æ±‚å‚æ•°æ˜ å°„åˆ°ä¸åŒçš„å‘½ä»¤</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">Command</span> <span class="p">{</span>
    <span class="k">final</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="c1">// æ‰§è¡Œå‘½ä»¤</span>
    <span class="k">function</span> <span class="n">execute</span><span class="p">(</span> <span class="err">\</span><span class="nc">woo\controller\Request</span> <span class="nv">$request</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">doExecute</span><span class="p">(</span> <span class="nv">$request</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">abstract</span> <span class="k">function</span> <span class="n">doExecute</span><span class="p">(</span> <span class="err">\</span><span class="nc">woo\controller\Request</span> <span class="nv">$request</span> <span class="p">);</span>
<span class="p">}</span>

<span class="c1">// é»˜è®¤çš„å‘½ä»¤</span>
<span class="kd">class</span> <span class="nc">DefaultCommand</span> <span class="kd">extends</span> <span class="nc">Command</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">doExecute</span><span class="p">(</span> <span class="err">\</span><span class="nc">woo\controller\Request</span> <span class="nv">$request</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">addFeedback</span><span class="p">(</span> <span class="s2">"Welcome to WOO"</span> <span class="p">);</span>
        <span class="k">include</span><span class="p">(</span> <span class="s2">"woo/view/main.php"</span><span class="p">);</span>					<span class="c1">// åˆ†é…è§†å›¾</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å‘½ä»¤è§£æå™¨ï¼ˆç”Ÿæˆä¸åŒå‘½ä»¤çš„å·¥å‚ï¼‰</span>
<span class="kd">class</span> <span class="nc">CommandResolver</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$base_cmd</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$default_cmd</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">self</span><span class="o">::</span><span class="nv">$base_cmd</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">::</span><span class="nv">$base_cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">ReflectionClass</span><span class="p">(</span> <span class="s2">"\woo\command\Command"</span> <span class="p">);</span>		<span class="c1">// ä½¿ç”¨åå°„</span>
            <span class="k">self</span><span class="o">::</span><span class="nv">$default_cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultCommand</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="c1">// è·å–å‘½ä»¤å¯¹è±¡</span>
    <span class="k">function</span> <span class="n">getCommand</span><span class="p">(</span> <span class="err">\</span><span class="nc">woo\controller\Request</span> <span class="nv">$request</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$cmd</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">getProperty</span><span class="p">(</span> <span class="s1">'cmd'</span> <span class="p">);</span>
        <span class="nv">$sep</span> <span class="o">=</span> <span class="no">DIRECTORY_SEPARATOR</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$cmd</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">self</span><span class="o">::</span><span class="nv">$default_cmd</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$cmd</span><span class="o">=</span><span class="nb">str_replace</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="nv">$sep</span><span class="p">),</span> <span class="s2">""</span><span class="p">,</span> <span class="nv">$cmd</span> <span class="p">);</span>
        <span class="nv">$filepath</span> <span class="o">=</span> <span class="s2">"woo</span><span class="si">{</span><span class="nv">$sep</span><span class="si">}</span><span class="s2">command</span><span class="si">{</span><span class="nv">$sep</span><span class="si">}{</span><span class="nv">$cmd</span><span class="si">}</span><span class="s2">.php"</span><span class="p">;</span>
        <span class="nv">$classname</span> <span class="o">=</span> <span class="s2">"woo</span><span class="se">\\</span><span class="s2">command</span><span class="se">\\</span><span class="si">{</span><span class="nv">$cmd</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">file_exists</span><span class="p">(</span> <span class="nv">$filepath</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="o">@</span><span class="k">require_once</span><span class="p">(</span> <span class="s2">"</span><span class="nv">$filepath</span><span class="s2">"</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nb">class_exists</span><span class="p">(</span> <span class="nv">$classname</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nv">$cmd_class</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReflectionClass</span><span class="p">(</span><span class="nv">$classname</span><span class="p">);</span><span class="c1">// ä½¿ç”¨åå°„çš„æ–¹å¼ï¼Œæ ¹æ®ç±»åè¿”å›ç±»å®ä¾‹</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nv">$cmd_class</span><span class="o">-&gt;</span><span class="nf">isSubClassOf</span><span class="p">(</span> <span class="k">self</span><span class="o">::</span><span class="nv">$base_cmd</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nv">$cmd_class</span><span class="o">-&gt;</span><span class="nf">newInstance</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">addFeedback</span><span class="p">(</span> <span class="s2">"command '</span><span class="nv">$cmd</span><span class="s2">' is not a Command"</span> <span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">addFeedback</span><span class="p">(</span> <span class="s2">"command '</span><span class="nv">$cmd</span><span class="s2">' not found"</span> <span class="p">);</span>
        <span class="k">return</span> <span class="k">clone</span> <span class="k">self</span><span class="o">::</span><span class="nv">$default_cmd</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>
<h2 id="åº”ç”¨æ§åˆ¶å™¨">åº”ç”¨æ§åˆ¶å™¨*</h2>
<p>åº”ç”¨æ§åˆ¶å™¨è´Ÿè´£æ˜ å°„è¯·æ±‚åˆ°å‘½ä»¤ï¼Œå¹¶æ˜ å°„å‘½ä»¤åˆ°è§†å›¾ï¼ˆé€šè¿‡ä¸€ä¸ªXMLé…ç½®æ–‡ä»¶ï¼‰ã€‚
æ¯”å‰ç«¯æ§åˆ¶å™¨å¤æ‚çš„åœ°æ–¹åœ¨äºè¿›ä¸€æ­¥å¯¹Commandè¿›è¡Œåˆ†ç¦»ï¼ˆå‰ç«¯æ§åˆ¶å™¨ä¸­è§†å›¾ä¸Commandæœªåˆ†ç¦»ï¼‰ã€‚</p>

<h2 id="é¡µé¢æ§åˆ¶å™¨">é¡µé¢æ§åˆ¶å™¨</h2>
<p>æ¯”å‰ç«¯æ§åˆ¶å™¨æ›´ç®€å•çš„å®ç°ï¼šæ§åˆ¶é€»è¾‘è¢«æ”¾åœ¨è§†å›¾é‡Œé¢ã€‚
æœ€ç®€å•çš„é¡µé¢æ§åˆ¶å™¨ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 	<span class="cp">&lt;?php</span>
<span class="k">require_once</span><span class="p">(</span><span class="s2">"woo/domain/Venue.php"</span><span class="p">);</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="nv">$venues</span> <span class="o">=</span> <span class="err">\</span><span class="nc">woo\domain\Venue</span><span class="o">::</span><span class="nf">findAll</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span> <span class="nc">Exception</span> <span class="nv">$e</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">include</span><span class="p">(</span> <span class="s1">'error.php'</span> <span class="p">);</span>
    <span class="k">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// default page follows</span>
<span class="cp">?&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Venues<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h1&gt;</span>Venues<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;?php</span> <span class="k">foreach</span><span class="p">(</span> <span class="nv">$venues</span> <span class="k">as</span> <span class="nv">$venue</span> <span class="p">)</span> <span class="p">{</span> <span class="cp">?&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">print</span> <span class="nv">$venue</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="cp">&lt;?php</span> <span class="p">}</span> <span class="cp">?&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</code></pre></div></div>
<p>æ¨¡æ¿è§†å›¾å’Œè§†å›¾åŠ©æ‰‹
ä¸åº”è¯¥åœ¨è§†å›¾ä¸­æ··å…¥ä¸šåŠ¡é€»è¾‘ä»£ç ï¼Œåº”è¯¥æŠŠåº”ç”¨å¤„ç†é€»è¾‘æ”¾åœ¨è§†å›¾å¤–çš„åœ°æ–¹ï¼Œåªå…è®¸è§†å›¾æ‰§è¡Œâ€œæ˜¾ç¤ºæ•°æ®â€çš„åŠŸèƒ½ï¼Œé€šå¸¸çš„åšæ³•æ˜¯å…ˆå¾—åˆ°æ•°æ®ï¼Œå†å°†æ•°æ®ä¼ é€’ç»™è§†å›¾ã€‚å½“ä¸€ä¸ªè§†å›¾éœ€è¦è®¿é—®ç³»ç»Ÿæ•°æ®æ—¶ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªè§†å›¾åŠ©æ‰‹å¯¹è±¡æ¥å¸®åŠ©è§†å›¾è¾¾åˆ°ç›®çš„ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">woo\view</span><span class="p">;</span>

<span class="c1">// å®šä¹‰ä¸€ä¸ªè§†å›¾åŠ©æ‰‹ç±»</span>
<span class="kd">class</span> <span class="nc">VH</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">function</span> <span class="n">getRequest</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="err">\</span><span class="nc">woo\base\RequestRegistry</span><span class="o">::</span><span class="nf">getRequest</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>
<p>åœ¨è§†å›¾ä¸­ä½¿ç”¨è§†å›¾åŠ©æ‰‹ç±»ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">require_once</span><span class="p">(</span><span class="s2">"woo/view/ViewHelper.php"</span><span class="p">);</span>
<span class="nv">$request</span> <span class="o">=</span> <span class="err">\</span><span class="no">woo\view\VH</span><span class="o">::</span><span class="nf">getRequest</span><span class="p">();</span>		<span class="c1">// é€šè¿‡è§†å›¾åŠ©æ‰‹ç±»æ¥è·å¾—è¯·æ±‚å¯¹è±¡</span>
<span class="nv">$venue</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">getObject</span><span class="p">(</span><span class="s1">'venue'</span><span class="p">);</span>			<span class="c1">// è·å¾—è§†å›¾æ‰€éœ€çš„æ•°æ®</span>
<span class="cp">?&gt;</span>

<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Add a Space for venue <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$venue</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h1&gt;</span>Add a Space for Venue '<span class="cp">&lt;?php</span> <span class="k">print</span> <span class="nv">$venue</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">()</span> <span class="cp">?&gt;</span>'<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;table&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">print</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">getFeedbackString</span><span class="p">(</span><span class="s2">"&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;"</span><span class="p">);</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span>
     <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">getProperty</span><span class="p">(</span> <span class="s1">'space_name'</span> <span class="p">)</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="na">name=</span><span class="s">"space_name"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"venue_id"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$venue</span><span class="o">-&gt;</span><span class="nf">getId</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"submit"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<h2 id="äº‹åŠ¡è„šæœ¬">äº‹åŠ¡è„šæœ¬</h2>
<p>äº‹åŠ¡å³ä¸€ä¸ªåŠŸèƒ½ï¼Œäº‹åŠ¡è„šæœ¬æä¾›ä¸€ä¸ªå¿«é€Ÿè€Œæœ‰æ•ˆçš„æœºåˆ¶æ¥æ»¡è¶³ç³»ç»Ÿç›®æ ‡ï¼Œè‡ªå·±å¤„ç†è¯·æ±‚ï¼ˆä¸åˆ†å±‚ï¼Œæ¯”å¦‚æŠŠè¿æ¥æ•°æ®åº“å’Œè®¡ç®—ä¸šåŠ¡é€»è¾‘çš„ä»£ç è€¦åˆåœ¨ä¸€ä¸ªç±»ä¸­ï¼‰ï¼Œè€Œä¸æ˜¯å§”æ‰˜ç»™ç‰¹å®šçš„å¯¹è±¡æ¥å®Œæˆã€‚å¥½å¤„åœ¨äºå¯ä»¥å¾ˆå¿«å°±å¾—åˆ°æƒ³è¦çš„ç»“æœï¼Œä½†ä¸€èˆ¬åªåº”ç”¨åœ¨å°å‹é¡¹ç›®ä¸­ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">woo\process</span><span class="p">;</span>

<span class="c1">// å°è£…ä¸åŒäº‹åŠ¡çš„å…¬å…±æ“ä½œ</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">Base</span> <span class="p">{</span>
    <span class="k">static</span> <span class="nv">$DB</span><span class="p">;</span>
    <span class="k">static</span> <span class="nv">$stmts</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
   
    <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$dsn</span> <span class="o">=</span> <span class="err">\</span><span class="nc">woo\base\ApplicationRegistry</span><span class="o">::</span><span class="nf">getDSN</span><span class="p">(</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">is_null</span><span class="p">(</span> <span class="nv">$dsn</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">woo\base\AppException</span><span class="p">(</span> <span class="s2">"No DSN"</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">self</span><span class="o">::</span><span class="nv">$DB</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">PDO</span><span class="p">(</span> <span class="nv">$dsn</span> <span class="p">);</span>
        <span class="k">self</span><span class="o">::</span><span class="nv">$DB</span><span class="o">-&gt;</span><span class="nf">setAttribute</span><span class="p">(</span><span class="err">\</span><span class="no">PDO</span><span class="o">::</span><span class="no">ATTR_ERRMODE</span><span class="p">,</span> <span class="err">\</span><span class="no">PDO</span><span class="o">::</span><span class="no">ERRMODE_EXCEPTION</span><span class="p">);</span>
    <span class="p">}</span> 

    <span class="k">function</span> <span class="n">prepareStatement</span><span class="p">(</span> <span class="nv">$stmt_s</span> <span class="p">)</span> <span class="p">{</span>					<span class="c1">// æ‹¼è£…SQLè¯­å¥</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">isset</span><span class="p">(</span> <span class="k">self</span><span class="o">::</span><span class="nv">$stmts</span><span class="p">[</span><span class="nv">$stmt_s</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">self</span><span class="o">::</span><span class="nv">$stmts</span><span class="p">[</span><span class="nv">$stmt_s</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="nv">$stmt_handle</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nv">$DB</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="nv">$stmt_s</span><span class="p">);</span>
        <span class="k">self</span><span class="o">::</span><span class="nv">$stmts</span><span class="p">[</span><span class="nv">$stmt_s</span><span class="p">]</span><span class="o">=</span><span class="nv">$stmt_handle</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$stmt_handle</span><span class="p">;</span>
    <span class="p">}</span> 

    <span class="k">protected</span> <span class="k">function</span> <span class="n">doStatement</span><span class="p">(</span> <span class="nv">$stmt_s</span><span class="p">,</span> <span class="nv">$values_a</span> <span class="p">)</span> <span class="p">{</span>	<span class="c1">// æ‰§è¡ŒSQLæŸ¥è¯¢</span>
        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">prepareStatement</span><span class="p">(</span> <span class="nv">$stmt_s</span> <span class="p">);</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">closeCursor</span><span class="p">();</span>
        <span class="nv">$db_result</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span> <span class="nv">$values_a</span> <span class="p">);</span>
        <span class="k">return</span> <span class="nv">$sth</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">VenueManager</span> <span class="kd">extends</span> <span class="nc">Base</span> <span class="p">{</span>
    <span class="k">static</span> <span class="nv">$add_venue</span> <span class="o">=</span>  <span class="s2">"INSERT INTO venue ( name ) values( ? )"</span><span class="p">;</span>
    <span class="k">static</span> <span class="nv">$add_space</span>  <span class="o">=</span> <span class="s2">"INSERT INTO space( name, venue ) values( ?, ? )"</span><span class="p">;</span> 
    <span class="k">static</span> <span class="nv">$check_slot</span> <span class="o">=</span> <span class="s2">"SELECT id, name FROM event WHERE space = ? AND (start+duration) &gt; ? AND start &lt; ?"</span><span class="p">;</span> 
    <span class="k">static</span> <span class="nv">$add_event</span> <span class="o">=</span>  <span class="s2">"INSERT INTO event ( name, space, start, duration ) values( ?, ?, ?, ? )"</span><span class="p">;</span> 

<span class="c1">// ä¸€ä¸ªäº‹åŠ¡ï¼šæ·»åŠ ç©ºé—´</span>
    <span class="k">function</span> <span class="n">addVenue</span><span class="p">(</span> <span class="nv">$name</span><span class="p">,</span> <span class="nv">$space_array</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$ret</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nv">$ret</span><span class="p">[</span><span class="s1">'venue'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="nv">$name</span> <span class="p">);</span> 
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">doStatement</span><span class="p">(</span> <span class="k">self</span><span class="o">::</span><span class="nv">$add_venue</span><span class="p">,</span> <span class="nv">$ret</span><span class="p">[</span><span class="s1">'venue'</span><span class="p">]);</span>
        <span class="nv">$v_id</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nv">$DB</span><span class="o">-&gt;</span><span class="nf">lastInsertId</span><span class="p">();</span>
        <span class="nv">$ret</span><span class="p">[</span><span class="s1">'spaces'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$space_array</span> <span class="k">as</span> <span class="nv">$space_name</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$values</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="nv">$space_name</span><span class="p">,</span> <span class="nv">$v_id</span> <span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">doStatement</span><span class="p">(</span> <span class="k">self</span><span class="o">::</span><span class="nv">$add_space</span><span class="p">,</span> <span class="nv">$values</span><span class="p">);</span>
            <span class="nv">$s_id</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nv">$DB</span><span class="o">-&gt;</span><span class="nf">lastInsertId</span><span class="p">();</span>
            <span class="nb">array_unshift</span><span class="p">(</span> <span class="nv">$values</span><span class="p">,</span> <span class="nv">$s_id</span> <span class="p">);</span>
            <span class="nv">$ret</span><span class="p">[</span><span class="s1">'spaces'</span><span class="p">][]</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
    <span class="p">}</span>
    
<span class="c1">// ä¸€ä¸ªäº‹åŠ¡ï¼šæ³¨å†Œäº‹ä»¶</span>
    <span class="k">function</span> <span class="n">bookEvent</span><span class="p">(</span> <span class="nv">$space_id</span><span class="p">,</span> <span class="nv">$name</span><span class="p">,</span> <span class="nv">$time</span><span class="p">,</span> <span class="nv">$duration</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$values</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="nv">$space_id</span><span class="p">,</span> <span class="nv">$time</span><span class="p">,</span> <span class="p">(</span><span class="nv">$time</span><span class="o">+</span><span class="nv">$duration</span><span class="p">)</span> <span class="p">);</span> 
        <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">doStatement</span><span class="p">(</span> <span class="k">self</span><span class="o">::</span><span class="nv">$check_slot</span><span class="p">,</span> <span class="nv">$values</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">fetch</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">woo\base\AppException</span><span class="p">(</span> <span class="s2">"double booked! try again"</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">doStatement</span><span class="p">(</span> <span class="k">self</span><span class="o">::</span><span class="nv">$add_event</span><span class="p">,</span> 
            <span class="k">array</span><span class="p">(</span> <span class="nv">$name</span><span class="p">,</span> <span class="nv">$space_id</span><span class="p">,</span> <span class="nv">$time</span><span class="p">,</span> <span class="nv">$duration</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span> 

<span class="c1">// è¿˜å¯ä»¥ç”¨åŒæ ·çš„å½¢å¼å®šä¹‰å…¶ä»–çš„åŸºäºæ•°æ®åº“æ“ä½œçš„äº‹åŠ¡ï¼Œå¿«é€Ÿå®ç°åŠŸèƒ½ã€‚</span>
<span class="p">}</span>
<span class="nv">$halfhour</span> <span class="o">=</span> <span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">30</span><span class="p">);</span>
<span class="nv">$hour</span>     <span class="o">=</span> <span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">);</span>
<span class="nv">$day</span>      <span class="o">=</span> <span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="nv">$hour</span><span class="p">);</span>

<span class="nv">$mode</span><span class="o">=</span><span class="s2">"sqlite"</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span> <span class="nv">$mode</span> <span class="o">==</span> <span class="s1">'mysql'</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nv">$dsn</span> <span class="o">=</span> <span class="s2">"mysql:dbname=test"</span><span class="p">;</span>    
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$dsn</span> <span class="o">=</span> <span class="s2">"sqlite://tmp/data/woo.db"</span><span class="p">;</span>    
<span class="p">}</span>

<span class="err">\</span><span class="nc">woo\base\ApplicationRegistry</span><span class="o">::</span><span class="nf">setDSN</span><span class="p">(</span> <span class="nv">$dsn</span> <span class="p">);</span> 
<span class="nv">$mgr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VenueManager</span><span class="p">();</span>
<span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$mgr</span><span class="o">-&gt;</span><span class="nf">addVenue</span><span class="p">(</span> <span class="s2">"The Eyeball Inn"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span> <span class="s1">'The Room Upstairs'</span><span class="p">,</span> <span class="s1">'Main Bar'</span> <span class="p">));</span>
<span class="nv">$space_id</span> <span class="o">=</span> <span class="nv">$ret</span><span class="p">[</span><span class="s1">'spaces'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="nv">$mgr</span><span class="o">-&gt;</span><span class="nf">bookEvent</span><span class="p">(</span> <span class="nv">$space_id</span><span class="p">,</span> <span class="s2">"Running like the rain"</span><span class="p">,</span> <span class="nb">time</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="nv">$day</span><span class="p">),</span> <span class="p">(</span><span class="nv">$hour</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="p">);</span> 
<span class="nv">$mgr</span><span class="o">-&gt;</span><span class="nf">bookEvent</span><span class="p">(</span> <span class="nv">$space_id</span><span class="p">,</span> <span class="s2">"Running like the trees"</span><span class="p">,</span> <span class="nb">time</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="nv">$day</span><span class="o">-</span><span class="nv">$hour</span><span class="p">),</span> <span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span> <span class="p">);</span> 
<span class="cp">?&gt;</span>
</code></pre></div></div>
<h2 id="é¢†åŸŸæ¨¡å‹">é¢†åŸŸæ¨¡å‹</h2>
<p>é¢†åŸŸæ¨¡å‹è±¡å¾ç€çœŸå®ä¸–ç•Œé‡Œé¡¹ç›®ä¸­çš„å„ä¸ªå‚ä¸è€…ï¼Œæ˜¯æ›´çº¯ç²¹çš„â€œä¸‡ç‰©çš†å¯¹è±¡â€ï¼Œåœ¨å…¶ä»–åœ°æ–¹å¯¹è±¡æ€»æ˜¯å¸¦ç€æŸç§å…·ä½“çš„è´£ä»»ï¼Œè€Œåœ¨é¢†åŸŸæ¨¡å‹ä¸­ï¼Œå®ƒä»¬å¸¸å¸¸è¢«æè¿°ä¸ºä¸€ç»„å±æ€§åŠé™„åŠ çš„ä»£ç†ã€‚å¸¸è§çš„åšæ³•æ˜¯å°†é¢†åŸŸæ¨¡å‹ç±»ç›´æ¥æ˜ å°„ä¸ºå…³ç³»æ•°æ®åº“çš„è¡¨ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">woo\domain</span><span class="p">;</span>

<span class="c1">// æŠ½è±¡åŸºç±»</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">DomainObject</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span> <span class="nv">$id</span><span class="o">=</span><span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getId</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">function</span> <span class="n">getCollection</span><span class="p">(</span> <span class="nv">$type</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">();</span>			 		<span class="c1">// dummy</span>
    <span class="p">}</span>
 
    <span class="k">function</span> <span class="n">collection</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">::</span><span class="nf">getCollection</span><span class="p">(</span> <span class="nb">get_class</span><span class="p">(</span> <span class="nv">$this</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å¯¹åº”æ•°æ®åº“ä¸­çš„Venueè¡¨</span>
<span class="kd">class</span> <span class="nc">Venue</span> <span class="kd">extends</span> <span class="nc">DomainObject</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$name</span><span class="p">;</span>		<span class="c1">// å­—æ®µ1</span>
    <span class="k">private</span> <span class="nv">$spaces</span><span class="p">;</span>	<span class="c1">// å­—æ®µ2</span>

    <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span> <span class="nv">$id</span><span class="o">=</span><span class="kc">null</span><span class="p">,</span> <span class="nv">$name</span><span class="o">=</span><span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">spaces</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nf">getCollection</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">woo</span><span class="se">\\</span><span class="s2">domain</span><span class="se">\\</span><span class="s2">Space"</span><span class="p">);</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">(</span> <span class="nv">$id</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">setSpaces</span><span class="p">(</span> <span class="kt">SpaceCollection</span> <span class="nv">$spaces</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">spaces</span> <span class="o">=</span> <span class="nv">$spaces</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getSpaces</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">spaces</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">addSpace</span><span class="p">(</span> <span class="kt">Space</span> <span class="nv">$space</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">spaces</span><span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span> <span class="nv">$space</span> <span class="p">);</span>
        <span class="nv">$space</span><span class="o">-&gt;</span><span class="nf">setVenue</span><span class="p">(</span> <span class="nv">$this</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">setName</span><span class="p">(</span> <span class="nv">$name_s</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nv">$name_s</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">markDirty</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">getName</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$v</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Venue</span><span class="p">(</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">"The grep and grouch"</span> <span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<h2 id="æ•°æ®æ˜ å°„å™¨">æ•°æ®æ˜ å°„å™¨</h2>
<p>æ•°æ®æ˜ å°„å™¨æ˜¯ä¸€ä¸ªè´Ÿè´£å°†æ•°æ®åº“æ•°æ®æ˜ å°„åˆ°å¯¹è±¡çš„ç±»ã€‚
é€šå¸¸ä¹ æƒ¯ä¸ºæ¯ä¸€ä¸ªé¢†åŸŸç±»å®ç°ä¸€ä¸ªæ˜ å°„ç±»ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æ•°æ®æ˜ å°„å™¨çš„åŸºç±»</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">Mapper</span> <span class="p">{</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="nv">$PDO</span><span class="p">;</span> 
    <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">isset</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="nv">$PDO</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span> 
            <span class="nv">$dsn</span> <span class="o">=</span> <span class="err">\</span><span class="nc">woo\base\ApplicationRegistry</span><span class="o">::</span><span class="nf">getDSN</span><span class="p">(</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nb">is_null</span><span class="p">(</span> <span class="nv">$dsn</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">woo\base\AppException</span><span class="p">(</span> <span class="s2">"No DSN"</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">self</span><span class="o">::</span><span class="nv">$PDO</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">PDO</span><span class="p">(</span> <span class="nv">$dsn</span> <span class="p">);</span>
            <span class="k">self</span><span class="o">::</span><span class="nv">$PDO</span><span class="o">-&gt;</span><span class="nf">setAttribute</span><span class="p">(</span><span class="err">\</span><span class="no">PDO</span><span class="o">::</span><span class="no">ATTR_ERRMODE</span><span class="p">,</span> <span class="err">\</span><span class="no">PDO</span><span class="o">::</span><span class="no">ERRMODE_EXCEPTION</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="c1">// æ ¹æ®IDä»æ•°æ®åº“ä¸­æŸ¥æ‰¾è®°å½•ï¼Œå¹¶æ˜ å°„ä¸ºä¸€ä¸ªå¯¹è±¡è¿”å›</span>
    <span class="k">function</span> <span class="n">find</span><span class="p">(</span> <span class="nv">$id</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">selectstmt</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span> <span class="nv">$id</span> <span class="p">)</span> <span class="p">);</span>
        <span class="nv">$array</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">selectstmt</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">fetch</span><span class="p">(</span> <span class="p">);</span> 
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">selectstmt</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">closeCursor</span><span class="p">(</span> <span class="p">);</span> 
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">is_array</span><span class="p">(</span> <span class="nv">$array</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">isset</span><span class="p">(</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
        <span class="nv">$object</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createObject</span><span class="p">(</span> <span class="nv">$array</span> <span class="p">);</span>			<span class="c1">// é‡å®šå‘åˆ°createObject(...)</span>
        <span class="k">return</span> <span class="nv">$object</span><span class="p">;</span> 
    <span class="p">}</span>

<span class="c1">// æ ¹æ®ä¸€ä¸ªæ•°ç»„å‚æ•°åˆ›å»ºä¸€ä¸ªå¯¹è±¡è¿”å›</span>
    <span class="k">function</span> <span class="n">createObject</span><span class="p">(</span> <span class="nv">$array</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$obj</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">doCreateObject</span><span class="p">(</span> <span class="nv">$array</span> <span class="p">);</span>			<span class="c1">// é‡å®šå‘åˆ°doCreateObject(...)</span>
        <span class="k">return</span> <span class="nv">$obj</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">insert</span><span class="p">(</span> <span class="err">\</span><span class="nc">woo\domain\DomainObject</span> <span class="nv">$obj</span> <span class="p">)</span> <span class="p">{</span>	<span class="c1">// é‡å®šå‘åˆ°doInsert(...)</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">doInsert</span><span class="p">(</span> <span class="nv">$obj</span> <span class="p">);</span>
    <span class="p">}</span>

<span class="c1">// ç•™å¾…å­ç±»å®ç°çš„æ–¹æ³•</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">update</span><span class="p">(</span> <span class="err">\</span><span class="nc">woo\domain\DomainObject</span> <span class="nv">$object</span> <span class="p">);</span>
    <span class="k">protected</span> <span class="k">abstract</span> <span class="k">function</span> <span class="n">doCreateObject</span><span class="p">(</span> <span class="kt">array</span> <span class="nv">$array</span> <span class="p">);</span>
    <span class="k">protected</span> <span class="k">abstract</span> <span class="k">function</span> <span class="n">doInsert</span><span class="p">(</span> <span class="err">\</span><span class="nc">woo\domain\DomainObject</span> <span class="nv">$object</span> <span class="p">);</span>
    <span class="k">protected</span> <span class="k">abstract</span> <span class="k">function</span> <span class="n">selectStmt</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// å¯¹åº”æ•°æ®åº“ä¸­Venueè¡¨çš„æ•°æ®æ˜ å°„å™¨</span>
<span class="kd">class</span> <span class="nc">VenueMapper</span> <span class="kd">extends</span> <span class="nc">Mapper</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">();</span>
<span class="c1">// åœ¨æ„é€ æ–¹æ³•ä¸­é¢„å®šä¹‰äº†ä¸€äº›sqlè¯­å¥æ¨¡æ¿ï¼Œå…¶ä¸­å°±å…³è”äº†æŒ‡å®šçš„è¡¨venue</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">selectStmt</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nv">$PDO</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span> <span class="s2">"SELECT * FROM venue WHERE id=?"</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">updateStmt</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nv">$PDO</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="s2">"update venue set name=?, id=? where id=?"</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insertStmt</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nv">$PDO</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="s2">"insert into venue ( name ) values( ? )"</span><span class="p">);</span>
    <span class="p">}</span> 
    
<span class="c1">// åœ¨å¯¹è±¡å…³ç³»å±‚é¢ï¼Œä¸€ä¸ªvenueå¯ä»¥åŒ…å«å¤šä¸ªspace</span>
    <span class="k">function</span> <span class="n">getCollection</span><span class="p">(</span> <span class="kt">array</span> <span class="nv">$raw</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">SpaceCollection</span><span class="p">(</span> <span class="nv">$raw</span><span class="p">,</span> <span class="nv">$this</span> <span class="p">);</span>
    <span class="p">}</span>

<span class="c1">// åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæ­¤æ—¶ä¸æ•°æ®åº“æ— å…³</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">doCreateObject</span><span class="p">(</span> <span class="kt">array</span> <span class="nv">$array</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="err">\</span><span class="nf">woo\domain\Venue</span><span class="p">(</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="p">);</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nf">setname</span><span class="p">(</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="p">);</span>
        <span class="c1">// $space_mapper = new spacemapper();</span>
        <span class="c1">// $space_collection = $space_mapper-&gt;findbyvenue( $array['id'] );</span>
        <span class="c1">// $obj-&gt;setspaces( $space_collection );</span>
        <span class="k">return</span> <span class="nv">$obj</span><span class="p">;</span>
    <span class="p">}</span>

<span class="c1">// æ’å…¥ï¼šå°†å¯¹è±¡æ˜ å°„åˆ°æ•°æ®åº“</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="n">doInsert</span><span class="p">(</span> <span class="err">\</span><span class="nc">woo\domain\DomainObject</span> <span class="nv">$object</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s2">"inserting</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="nb">debug_print_backtrace</span><span class="p">();</span>
        <span class="nv">$values</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="nv">$object</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">()</span> <span class="p">);</span> 
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">insertStmt</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span> <span class="nv">$values</span> <span class="p">);</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nv">$PDO</span><span class="o">-&gt;</span><span class="nf">lastInsertId</span><span class="p">();</span>
        <span class="nv">$object</span><span class="o">-&gt;</span><span class="nf">setId</span><span class="p">(</span> <span class="nv">$id</span> <span class="p">);</span>
    <span class="p">}</span>
    
<span class="c1">// æ›´æ–°</span>
    <span class="k">function</span> <span class="n">update</span><span class="p">(</span> <span class="err">\</span><span class="nc">woo\domain\DomainObject</span> <span class="nv">$object</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s2">"updating</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="nv">$values</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="nv">$object</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">(),</span> <span class="nv">$object</span><span class="o">-&gt;</span><span class="nf">getId</span><span class="p">(),</span> <span class="nv">$object</span><span class="o">-&gt;</span><span class="nf">getId</span><span class="p">()</span> <span class="p">);</span> 
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">updateStmt</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span> <span class="nv">$values</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">selectStmt</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">selectStmt</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨</span>
<span class="nv">$mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VenueMapper</span><span class="p">();</span>
<span class="nv">$venue</span> <span class="o">=</span> <span class="nv">$mapper</span><span class="o">-&gt;</span><span class="nf">find</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>				<span class="c1">// ä½¿ç”¨æ•°æ®æ˜ å°„å™¨æ¥å¡«å……ä¸€ä¸ªé¢†åŸŸå¯¹è±¡æ¨¡å‹</span>
<span class="nb">print_r</span><span class="p">(</span> <span class="nv">$venue</span> <span class="p">);</span>
</code></pre></div></div>
<h2 id="æ ‡è¯†æ˜ å°„">æ ‡è¯†æ˜ å°„</h2>
<p>ä¿å­˜æ¯ä¸ªå·²åŠ è½½è¿‡çš„å¯¹è±¡ï¼Œç¡®ä¿æ¯ä¸ªå¯¹è±¡åªåŠ è½½ä¸€æ¬¡ï¼ˆç›¸å½“äºåœ¨æ•°æ®æ˜ å°„å™¨ä¸æ•°æ®åº“ä¹‹é—´åˆåŠ äº†ä¸€å±‚é€»è¾‘ï¼‰å½“è¦è®¿é—®ä»–ä»¬çš„æ—¶å€™ï¼Œé€šè¿‡æ˜ å°„æ¥æŸ¥æ‰¾å®ƒä»¬ã€‚æ ‡è¯†æ˜ å°„çš„ä¸»è¦ç›®çš„æ˜¯ä¿æŒä¸€è‡´æ€§ï¼Œè€Œä¸æ˜¯æé«˜æ€§èƒ½ã€‚ï¼š
ï¼ˆ1ï¼‰å½“è¦è®¿é—®å¯¹è±¡æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥æ ‡è¯†æ˜ å°„ï¼Œçœ‹éœ€è¦çš„å¯¹è±¡æ˜¯å¦å·²ç»å­˜åœ¨å…¶ä¸­ã€‚
ï¼ˆ2ï¼‰ä½¿ç”¨Identifyæ¥ç¡®ä¿ä¸é‡å¤åŠ è½½ç›¸åŒçš„æ•°æ®ï¼Œä¸ä»…æœ‰åŠ©äºä¿è¯æ­£ç¡®æ€§ï¼ˆä¸ä¼šå°†åŒä¸€æ•°æ®åŠ è½½åˆ°ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ä¸Šï¼‰ï¼Œè¿˜èƒ½æå‡æ€§èƒ½ã€‚</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ä¸€ä¸ªæ ‡è¯†æ˜ å°„ç±»ï¼ˆä¸€ä¸ªå¯¹è±¡æ± ï¼‰</span>
<span class="c1">// åŒæ—¶å®ç°äº†æ ‡è¯†æ˜ å°„æ¨¡å¼å’Œå·¥ä½œå•å…ƒæ¨¡å¼</span>
<span class="kd">class</span> <span class="nc">ObjectWatcher</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$all</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>			<span class="c1">// å·²åŠ è½½çš„æ‰€æœ‰å¯¹è±¡</span>
    <span class="k">private</span> <span class="nv">$dirty</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">private</span> <span class="nv">$new</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">private</span> <span class="nv">$delete</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$instance</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="c1">// å•ä¾‹</span>
    <span class="k">static</span> <span class="k">function</span> <span class="n">instance</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">self</span><span class="o">::</span><span class="nv">$instance</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">::</span><span class="nv">$instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectWatcher</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">::</span><span class="nv">$instance</span><span class="p">;</span>
    <span class="p">}</span>
 
<span class="c1">// æ„é€ å”¯ä¸€æ ‡è¯†ï¼Œç¡®ä¿ä¸å­˜åœ¨é‡å¤å¯¹è±¡</span>
    <span class="k">function</span> <span class="n">globalKey</span><span class="p">(</span> <span class="kt">DomainObject</span> <span class="nv">$obj</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$key</span> <span class="o">=</span> <span class="nb">get_class</span><span class="p">(</span> <span class="nv">$obj</span> <span class="p">)</span><span class="mf">.</span><span class="s2">"."</span><span class="mf">.</span><span class="nv">$obj</span><span class="o">-&gt;</span><span class="nf">getId</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$key</span><span class="p">;</span>
    <span class="p">}</span>
  
<span class="c1">// æ·»åŠ æ–°çš„åŠ è½½å¯¹è±¡ï¼Œå¦‚æœå·²å­˜åœ¨åˆ™è¦†ç›–</span>
    <span class="k">static</span> <span class="k">function</span> <span class="n">add</span><span class="p">(</span> <span class="kt">DomainObject</span> <span class="nv">$obj</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$inst</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nf">instance</span><span class="p">();</span>
        <span class="nv">$inst</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">[</span><span class="nv">$inst</span><span class="o">-&gt;</span><span class="nf">globalKey</span><span class="p">(</span> <span class="nv">$obj</span> <span class="p">)]</span> <span class="o">=</span> <span class="nv">$obj</span><span class="p">;</span>
    <span class="p">}</span>

<span class="c1">// åˆ¤æ–­æŸä¸ªç±»çš„æŸä¸ªå¯¹è±¡æ˜¯å¦å·²è¢«åŠ è½½</span>
    <span class="k">static</span> <span class="k">function</span> <span class="n">exists</span><span class="p">(</span> <span class="nv">$classname</span><span class="p">,</span> <span class="nv">$id</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$inst</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nf">instance</span><span class="p">();</span>
        <span class="nv">$key</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$classname</span><span class="s2">.</span><span class="nv">$id</span><span class="s2">"</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">isset</span><span class="p">(</span> <span class="nv">$inst</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$inst</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
 
<span class="cd">/***
ä»¥ä¸‹æ˜¯å·¥ä½œå•å…ƒæ¨¡å¼çš„å®ç°
***/</span>
    <span class="k">static</span> <span class="k">function</span> <span class="n">addDelete</span><span class="p">(</span> <span class="kt">DomainObject</span> <span class="nv">$obj</span> <span class="p">)</span> <span class="p">{</span>				<span class="c1">// åˆ é™¤</span>
        <span class="nv">$self</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nf">instance</span><span class="p">();</span>
        <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">delete</span><span class="p">[</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="nf">globalKey</span><span class="p">(</span> <span class="nv">$obj</span> <span class="p">)]</span> <span class="o">=</span> <span class="nv">$obj</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">function</span> <span class="n">addDirty</span><span class="p">(</span> <span class="kt">DomainObject</span> <span class="nv">$obj</span> <span class="p">)</span> <span class="p">{</span>				<span class="c1">// æ·»åŠ è„å¯¹è±¡</span>
        <span class="nv">$inst</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nf">instance</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">in_array</span><span class="p">(</span> <span class="nv">$obj</span><span class="p">,</span> <span class="nv">$inst</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$inst</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">[</span><span class="nv">$inst</span><span class="o">-&gt;</span><span class="nf">globalKey</span><span class="p">(</span> <span class="nv">$obj</span> <span class="p">)]</span> <span class="o">=</span> <span class="nv">$obj</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">function</span> <span class="n">addNew</span><span class="p">(</span> <span class="kt">DomainObject</span> <span class="nv">$obj</span> <span class="p">)</span> <span class="p">{</span>				<span class="c1">// æ–°å¯¹è±¡</span>
        <span class="nv">$inst</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nf">instance</span><span class="p">();</span>
        <span class="c1">// we don't yet have an id</span>
        <span class="nv">$inst</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$obj</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">function</span> <span class="n">addClean</span><span class="p">(</span><span class="kt">DomainObject</span> <span class="nv">$obj</span> <span class="p">)</span> <span class="p">{</span>				<span class="c1">// å°†è„å¯¹è±¡åˆ—è¡¨ä¸­çš„æŸä¸ªå¯¹è±¡æ ‡è¯†ä¸ºå¹²å‡€çš„</span>
        <span class="nv">$self</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nf">instance</span><span class="p">();</span>
        <span class="nb">unset</span><span class="p">(</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">delete</span><span class="p">[</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="nf">globalKey</span><span class="p">(</span> <span class="nv">$obj</span> <span class="p">)]</span> <span class="p">);</span>
        <span class="nb">unset</span><span class="p">(</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">[</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="nf">globalKey</span><span class="p">(</span> <span class="nv">$obj</span> <span class="p">)]</span> <span class="p">);</span>

        <span class="nv">$self</span><span class="o">-&gt;</span><span class="k">new</span> <span class="o">=</span> <span class="nb">array_filter</span><span class="p">(</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">,</span> 
                <span class="k">function</span><span class="p">(</span> <span class="nv">$a</span> <span class="p">)</span> <span class="k">use</span> <span class="p">(</span> <span class="nv">$obj</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="p">(</span> <span class="nv">$a</span> <span class="o">===</span> <span class="nv">$obj</span> <span class="p">);</span> <span class="p">}</span> 
                <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">performOperations</span><span class="p">()</span> <span class="p">{</span>							<span class="c1">// æäº¤æ‰€æœ‰æ“ä½œ</span>
        <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="k">as</span> <span class="nv">$key</span><span class="o">=&gt;</span><span class="nv">$obj</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nf">finder</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">insert</span><span class="p">(</span> <span class="nv">$obj</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="k">new</span> <span class="nc">as</span> <span class="nv">$key</span><span class="o">=&gt;</span><span class="nv">$obj</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nf">finder</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">insert</span><span class="p">(</span> <span class="nv">$obj</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="k">new</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="p">}</span> 
<span class="p">}</span>
</code></pre></div></div>

<h2 id="å·¥ä½œå•å…ƒ">å·¥ä½œå•å…ƒ</h2>
<p>å·¥ä½œå•å…ƒçš„ç›®æ ‡æ˜¯ç»´æŠ¤å˜åŒ–çš„å¯¹è±¡åˆ—è¡¨ã€‚æ”¶é›†å˜åŒ–çš„å¯¹è±¡ï¼Œå¹¶å°†å˜åŒ–çš„å¯¹è±¡æ”¾åˆ°å„è‡ªçš„å¢åˆ æ”¹åˆ—è¡¨ä¸­ï¼Œæœ€åCommitï¼ŒCommitæ—¶éœ€è¦å¾ªç¯éå†è¿™äº›åˆ—è¡¨ã€‚</p>

<p>å·¥ä½œå•å…ƒæ¨¡å¼å’Œæ ‡è¯†æ˜ å°„æ¨¡å¼æ˜¯äº’è¡¥çš„ï¼Œæ ‡è¯†æ˜ å°„æ¨¡å¼åœ¨è¯»æ•°æ®åº“ä¹‹å‰åŠ äº†ä¸€å±‚é€»è¾‘ï¼Œä¿è¯ä¸åŠ è½½é‡å¤çš„å¯¹è±¡ã€‚å·¥ä½œå•å…ƒæ¨¡å¼åœ¨å†™æ•°æ®ä¹‹å‰åŠ äº†ä¸€å±‚é€»è¾‘ï¼Œä¿è¯ä¸ä¼šé‡å¤æäº¤æ•°æ®åº“æ“ä½œã€‚</p>

<p>è„å¯¹è±¡ï¼šå½“å¯¹è±¡ä»æ•°æ®åº“ä¸­å–å‡ºå¹¶è¢«ä¿®æ”¹åï¼Œå°±è®¤ä¸ºè¯¥å¯¹è±¡â€œè„â€äº†ï¼Œè„å¯¹è±¡ä¿å­˜åœ¨$dirtyæ•°ç»„ä¸­ï¼Œç›´åˆ°æ›´æ–°æ•°æ®åº“ã€‚å¯ä»¥å°†ä¸€ä¸ªè„å¯¹è±¡æ ‡è¯†ä¸ºå¹²å‡€çš„ï¼Œè¿™æ ·æ•°æ®åº“å°±ä¸ä¼šè¢«æ›´æ–°ã€‚</p>

<p>ä»£ç è§ä¸Šä¾‹ã€‚</p>

<h2 id="å»¶è¿ŸåŠ è½½">å»¶è¿ŸåŠ è½½</h2>
<p>ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒè™½ç„¶ä¸åŒ…å«æ‰€éœ€è¦çš„æ‰€æœ‰æ•°æ®ï¼Œä½†æ˜¯çŸ¥é“å¦‚ä½•å»è·å–è¿™äº›æ•°æ®ã€‚
åŠ è½½ä¸€ä¸ªå¯¹è±¡ä¼šå¼•èµ·å¤§é‡ç›¸å…³å¯¹è±¡çš„åŠ è½½ï¼Œå¦‚åˆå§‹åŒ–æŸå¯¹è±¡çš„æ—¶å€™ï¼Œå…¶ä¸­çš„æŸäº›åŸŸï¼ˆå±æ€§ï¼‰éœ€è¦å»è¿æ¥æ•°æ®åº“ï¼ˆæˆ–è€…è¯´è¿æ¥å…¶ä»–æ•°æ®åº“ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´æŸä¸ªå¯¹è±¡çš„æ˜¯ä»æ•°æ®åº“Aä¸­è·å¾—ï¼Œä½†å…¶éƒ¨åˆ†å±æ€§éœ€è¦ä»å…¶ä»–æ•°æ®åº“è·å¾—ï¼Œè¿™æ—¶å€™éœ€è¦è€ƒè™‘é‡‡ç”¨å»¶è¿ŸåŠ è½½æ¥å‡å°‘åˆå§‹åŒ–æ—¶è¿æ¥æ•°æ®åº“çš„æ¬¡æ•°ã€‚</p>

<p>[ä»£ç ç•¥]</p>

<h2 id="é¢†åŸŸå¯¹è±¡å·¥å‚">é¢†åŸŸå¯¹è±¡å·¥å‚</h2>
<p>æŠŠæ˜ å°„å™¨ç±»çš„createObject()æ–¹æ³•ç§»å‡ºæ¥æ”¾åˆ°ä¸€ä¸ªç‹¬ç«‹çš„ç±»ä¸­ï¼Œå°±æ„æˆäº†é¢†åŸŸå¯¹è±¡å·¥å‚æ¨¡å¼ã€‚</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// é¢†åŸŸå¯¹è±¡å·¥å‚åŸºç±»</span>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">DomainObjectFactory</span> <span class="p">{</span>
    <span class="k">abstract</span> <span class="k">function</span> <span class="n">createObject</span><span class="p">(</span> <span class="kt">array</span> <span class="nv">$array</span> <span class="p">);</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">getFromMap</span><span class="p">(</span> <span class="nv">$class</span><span class="p">,</span> <span class="nv">$id</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="err">\</span><span class="nc">woo\domain\ObjectWatcher</span><span class="o">::</span><span class="nf">exists</span><span class="p">(</span> <span class="nv">$class</span><span class="p">,</span> <span class="nv">$id</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="n">addToMap</span><span class="p">(</span> <span class="err">\</span><span class="nc">woo\domain\DomainObject</span> <span class="nv">$obj</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="err">\</span><span class="nc">woo\domain\ObjectWatcher</span><span class="o">::</span><span class="nf">add</span><span class="p">(</span> <span class="nv">$obj</span> <span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// Venueç±»çš„é¢†åŸŸå¯¹è±¡å·¥å‚ç±»</span>
<span class="kd">class</span> <span class="nc">VenueObjectFactory</span> <span class="kd">extends</span> <span class="nc">DomainObjectFactory</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">createObject</span><span class="p">(</span> <span class="kt">array</span> <span class="nv">$array</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$class</span> <span class="o">=</span> <span class="s1">'\woo\domain\Venue'</span><span class="p">;</span>
        <span class="nv">$old</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getFromMap</span><span class="p">(</span> <span class="nv">$class</span><span class="p">,</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$old</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$old</span><span class="p">;</span> <span class="p">}</span>
        <span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$class</span><span class="p">(</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="p">);</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nf">setname</span><span class="p">(</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="p">);</span>
        <span class="c1">//$space_mapper = new SpaceMapper();</span>
        <span class="c1">//$space_collection = $space_mapper-&gt;findByVenue( $array['id'] );</span>
        <span class="c1">//$obj-&gt;setSpaces( $space_collection );</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">addToMap</span><span class="p">(</span> <span class="nv">$obj</span> <span class="p">);</span>
        <span class="k">return</span> <span class="nv">$obj</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Spaceç±»çš„é¢†åŸŸå¯¹è±¡å·¥å‚ç±»</span>
<span class="kd">class</span> <span class="nc">SpaceObjectFactory</span> <span class="kd">extends</span> <span class="nc">DomainObjectFactory</span> <span class="p">{</span>
    <span class="k">function</span> <span class="n">createObject</span><span class="p">(</span> <span class="kt">array</span> <span class="nv">$array</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$class</span> <span class="o">=</span> <span class="s1">'\woo\domain\Space'</span><span class="p">;</span>
        <span class="nv">$old</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getFromMap</span><span class="p">(</span> <span class="nv">$class</span><span class="p">,</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$old</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$old</span><span class="p">;</span> <span class="p">}</span>
        <span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$class</span><span class="p">(</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="p">);</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nf">setname</span><span class="p">(</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="p">);</span>
        <span class="nv">$ven_mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VenueMapper</span><span class="p">();</span>
        <span class="nv">$venue</span> <span class="o">=</span> <span class="nv">$ven_mapper</span><span class="o">-&gt;</span><span class="nf">find</span><span class="p">(</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'venue'</span><span class="p">]</span> <span class="p">);</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nf">setVenue</span><span class="p">(</span> <span class="nv">$venue</span> <span class="p">);</span>

        <span class="nv">$event_mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EventMapper</span><span class="p">();</span>
        <span class="nv">$event_collection</span> <span class="o">=</span> <span class="nv">$event_mapper</span><span class="o">-&gt;</span><span class="nf">findBySpaceId</span><span class="p">(</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="p">);</span>        
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nf">setEvents</span><span class="p">(</span> <span class="nv">$event_collection</span> <span class="p">);</span>
        <span class="k">return</span> <span class="nv">$obj</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

:ET