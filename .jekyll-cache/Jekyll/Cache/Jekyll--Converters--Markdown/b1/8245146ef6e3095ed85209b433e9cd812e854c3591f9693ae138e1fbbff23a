I"Óh<ul id="markdown-toc">
  <li><a href="#æ¦‚å¿µ" id="markdown-toc-æ¦‚å¿µ">æ¦‚å¿µ</a></li>
  <li><a href="#ç”ŸæˆxmlæŠ¥æ–‡" id="markdown-toc-ç”ŸæˆxmlæŠ¥æ–‡">ç”ŸæˆxmlæŠ¥æ–‡</a></li>
  <li><a href="#ç”Ÿæˆç§é’¥è¯ä¹¦" id="markdown-toc-ç”Ÿæˆç§é’¥è¯ä¹¦">ç”Ÿæˆç§é’¥ã€è¯ä¹¦</a>    <ul>
      <li><a href="#å‡†å¤‡ç›®å½•" id="markdown-toc-å‡†å¤‡ç›®å½•">å‡†å¤‡ç›®å½•</a></li>
      <li><a href="#ç”Ÿæˆè‡ªç­¾åçš„é¡¶çº§ca" id="markdown-toc-ç”Ÿæˆè‡ªç­¾åçš„é¡¶çº§ca">ç”Ÿæˆè‡ªç­¾åçš„é¡¶çº§CA</a></li>
      <li><a href="#ç”Ÿæˆä¸­çº§è¯ä¹¦ä¸åº”ç”¨è¯ä¹¦" id="markdown-toc-ç”Ÿæˆä¸­çº§è¯ä¹¦ä¸åº”ç”¨è¯ä¹¦">ç”Ÿæˆä¸­çº§è¯ä¹¦ä¸åº”ç”¨è¯ä¹¦</a></li>
    </ul>
  </li>
  <li><a href="#ç­¾åxmlæŠ¥æ–‡" id="markdown-toc-ç­¾åxmlæŠ¥æ–‡">ç­¾åXMLæŠ¥æ–‡</a>    <ul>
      <li><a href="#å‡†å¤‡å‰ç½®æ•°æ®" id="markdown-toc-å‡†å¤‡å‰ç½®æ•°æ®">å‡†å¤‡å‰ç½®æ•°æ®</a></li>
      <li><a href="#ç­¾å" id="markdown-toc-ç­¾å">ç­¾å</a></li>
    </ul>
  </li>
  <li><a href="#éªŒè¯æŠ¥æ–‡" id="markdown-toc-éªŒè¯æŠ¥æ–‡">éªŒè¯æŠ¥æ–‡</a></li>
  <li><a href="#å‚è€ƒæ–‡æ¡£" id="markdown-toc-å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</a></li>
</ul>

<p><a href="https://github.com/woojean/demos/tree/master/php-xml-signature">ä¸‹è½½ä»£ç :https://github.com/woojean/demos/tree/master/php-xml-signature</a></p>

<h1 id="æ¦‚å¿µ">æ¦‚å¿µ</h1>
<ul>
  <li>
    <p><strong>ã€ŠXMLæ•°å­—ç­¾åè§„èŒƒã€‹</strong><br />
<a href="https://www.w3.org/TR/2002/REC-xmldsig-core-20020212/">W3C XML signature recommendation on 12 February 2002</a></p>
  </li>
  <li>
    <p><strong>è§„èŒƒåŒ–XML</strong> 
é¢„å¤„ç†XMLæ–‡æ¡£ä»¥å®ç°çº¯æ–‡æœ¬æ¯”è¾ƒå’Œæ•°å­—ç­¾åã€‚</p>
  </li>
  <li>
    <p><strong>C14Nè§„èŒƒ</strong> 
Canonical XMLï¼Œä¸€ç§ç”ŸæˆXMLæ–‡æ¡£ç‰©ç†è¡¨ç¤ºçš„æ ‡å‡†æ–¹æ³•ã€‚</p>
  </li>
  <li>
    <p><strong>å°å†…åŠ ç­¾</strong> 
å…ƒç´ æˆä¸ºè¢«ç­¾åæ•°æ®çš„å­å…ƒç´ ã€‚</p>
  </li>
  <li>
    <p><strong>X.509æ ‡å‡†</strong> 
æ•°å­—è¯ä¹¦æ ‡å‡†ï¼Œä¸€ç§éå¸¸é€šç”¨çš„è¯ä¹¦æ ¼å¼ã€‚ä¸€ä»½X.509è¯ä¹¦æ˜¯ä¸€äº›æ ‡å‡†å­—æ®µçš„é›†åˆï¼ˆ<strong>å«è¯ä¹¦æŒæœ‰äººçš„å…¬é’¥ä¿¡æ¯åŠæ‰€ä½¿ç”¨çš„åŠ å¯†ç®—æ³•</strong>ï¼‰ã€‚
å¸¸ç”¨æ–‡ä»¶æ‰©å±•åï¼š<code class="language-plaintext highlighter-rouge">.cer</code>ã€ <code class="language-plaintext highlighter-rouge">.crt</code>- é€šå¸¸è¢«ç”¨äºäºŒè¿›åˆ¶çš„DERæ–‡ä»¶æ ¼å¼(åŒäº<code class="language-plaintext highlighter-rouge">.der</code>)ï¼Œä¸è¿‡ä¹Ÿè¢«ç”¨äºBase64ç¼–ç çš„æ–‡ä»¶ (ä¾‹å¦‚<code class="language-plaintext highlighter-rouge">.pem</code>).</p>
  </li>
  <li>
    <p><strong>SHA</strong> 
å®‰å…¨å“ˆå¸Œç®—æ³•ï¼ˆSecure Hash Algorithmï¼‰ï¼Œä¸»è¦é€‚ç”¨äºæ•°å­—ç­¾åæ ‡å‡†ï¼ˆDigital Signature Standard DSSï¼‰é‡Œé¢å®šä¹‰çš„æ•°å­—ç­¾åç®—æ³•ï¼ˆDigital Signature Algorithm DSAï¼‰ã€‚
<em>ç»è¿‡æƒå¨æœºæ„è¯å®ï¼Œsha-1åŠ å¯†ç®—æ³•çš„ä¸å®‰å…¨æ€§è¶Šæ¥è¶Šé«˜ï¼Œsha-1æŒ‡çº¹é€ å‡æˆæœ¬è¶Šæ¥è¶Šä½ï¼Œéšå³å¾®è½¯ã€è°·æ­Œç­‰ITå·¨å¤´ç›¸ç»§å‘å¸ƒå¼ƒç”¨sha-1åŠ å¯†ç®—æ³•å£°æ˜ï¼Œç¬¬ä¸‰æ–¹è®¤è¯æœºæ„è‡ª2016å¹´1æœˆ1æ—¥èµ·ï¼Œå°†å…¨é¢åœæ­¢ç­¾å‘sha-1ç®—æ³•çš„æ•°å­—è¯ä¹¦ã€‚è¿™ä¸€åˆ‡è¡¨æ˜éƒ½è¡¨æ˜ä»1995å¹´è¯ç”Ÿè‡³ä»Šçš„SHA1ç®—æ³•å°†è¢«sha-256æ‰€å–ä»£ã€‚</em></p>
  </li>
  <li>
    <p><strong>RSA</strong> 
ä¸€ç§å…¬é’¥åŠ å¯†ç®—æ³•ï¼ˆéå¯¹ç§°åŠ å¯†ç®—æ³•ï¼‰ã€‚å‘½åå–è‡ª3ä¸ªå¼€å‘è€…å§“åçš„é¦–å­—æ¯ã€‚
RSAç®—æ³•åŸºäºä¸€ä¸ªååˆ†ç®€å•çš„æ•°è®ºäº‹å®ï¼šå°†ä¸¤ä¸ªå¤§è´¨æ•°ç›¸ä¹˜ååˆ†å®¹æ˜“ï¼Œä½†æ˜¯æƒ³è¦å¯¹å…¶ä¹˜ç§¯è¿›è¡Œå› å¼åˆ†è§£å´æå…¶å›°éš¾ï¼Œå› æ­¤å¯ä»¥å°†ä¹˜ç§¯å…¬å¼€ä½œä¸ºåŠ å¯†å¯†é’¥ã€‚</p>
  </li>
  <li>
    <p><strong>è‡ªç­¾åçš„è¯ä¹¦</strong> 
æ•°å­—è¯ä¹¦ç”±è¯ä¹¦æœºæ„ç­¾å‘ï¼Œè¯ä¹¦æœºæ„é€šå¸¸éœ€ç»æƒå¨è®¤è¯æœºæ„æ³¨å†Œè®¤è¯ã€‚åœ¨ä¼ä¸šåº”ç”¨ä¸­ï¼Œä¹Ÿå¸¸ç”¨ä¼ä¸šè‡ªèº«ä½œä¸ºå‘è¯æœºæ„ï¼ˆæœªç»è¿‡è®¤è¯ï¼‰ç­¾å‘æ•°å­—è¯ä¹¦ï¼Œè¯ä¹¦çš„ä½¿ç”¨èŒƒå›´ä¹Ÿå¸¸æ˜¯ä¼ä¸šå†…éƒ¨ï¼Œè¿™æ ·çš„è¯ä¹¦å°±æ˜¯æ‰€è°“çš„â€œè‡ªç­¾åâ€çš„ã€‚</p>
  </li>
  <li>
    <p><strong>å…¬é’¥åŠ å¯†ç®—æ³•</strong> 
éå¯¹ç§°åŠ å¯†æŠ€æœ¯ã€‚ç§é’¥ç”¨äºè¿›è¡Œè§£å¯†å’Œ<strong>ç­¾å</strong>ã€‚å…¬é’¥ç”¨äºåŠ å¯†å’Œ<strong>éªŒè¯ç­¾å</strong>ã€‚</p>
  </li>
  <li>
    <p><strong>æ¶ˆæ¯æ‘˜è¦ç®—æ³•</strong> 
å•å‘å‡½æ•°æˆ–å“ˆå¸Œå‡½æ•°ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªç®€çŸ­çš„å›ºå®šé•¿åº¦ï¼Œæˆ–å¯å˜é•¿åº¦çš„æ¶ˆæ¯ã€‚å¯ç”¨äºéªŒè¯æ¶ˆæ¯æ˜¯å¦è¢«ç¯¡æ”¹ã€‚</p>
  </li>
  <li>
    <p><strong>æ•°å­—ç­¾å</strong> 
ç”¨äºå®‰å…¨åœ°å‘é€æ¶ˆæ¯æ‘˜è¦ï¼Œä¸»è¦ä½¿ç”¨ç§é’¥æ¥åŠ å¯†æ¶ˆæ¯æ‘˜è¦å’Œå…¶ä»–ä¿¡æ¯ï¼Œåªæœ‰å‘é€æ–¹çŸ¥é“ç§é’¥ï¼Œå› æ­¤åªæœ‰å‘ä»¶äººå¯ä»¥ç­¾åã€‚ç­¾ååŒ…å«ä¸€ä¸ªå”¯ä¸€çš„åºåˆ—å·ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å‘é€æ–¹æ— æ³•å¦è®¤æ›¾ç»å‘é€è¿‡æ¶ˆæ¯ï¼ˆå› ä¸ºåªæœ‰ä»–å¯ä»¥ç­¾åè¿™æ¡æ¶ˆæ¯ï¼‰ã€‚</p>
  </li>
  <li>
    <p><strong>è¯ä¹¦</strong> 
ç”¨äºå‘é€æ–¹ç¡®ä¿å…¬é’¥çš„æ­£ç¡®æ€§ï¼ŒåŒæ ·ï¼Œæ¥æ”¶æ–¹ä¹Ÿéœ€è¦æ ¸å®ç”¨äºç­¾åè¯¥æ¶ˆæ¯çš„ç§é’¥å±äºå‘é€æ–¹ã€‚
è¯ä¹¦çš„ä¸»è¦å†…å®¹åŒ…æ‹¬ï¼šå…¬é’¥ã€çœŸå®èº«ä»½è¯†åˆ«ä¿¡æ¯ï¼ˆDNï¼‰ã€è®¤è¯å’Œç­¾å‘çš„CAã€æœ‰æ•ˆæœŸç­‰ã€‚</p>
  </li>
  <li>
    <p><strong>DN</strong> 
Distinguished Nameï¼Œç”¨æ¥æä¾›å¯¹æŸä¸ªç‰¹å®šèƒŒæ™¯ä¸‹çš„èº«ä»½ä¿¡æ¯ï¼Œç”±X.509æ ‡å‡†å®šä¹‰ã€‚
ä¸»è¦çš„å­—æ®µåŒ…æ‹¬ï¼šCNï¼ˆCommon Nameï¼Œè¯ä¹¦é¢å‘å¯¹è±¡åç§°ï¼‰ï¼ŒOï¼ˆOrganizationï¼‰ï¼ŒOUï¼ˆ Organizational Unitï¼‰ï¼ŒLï¼ˆ City/localityï¼‰ï¼ŒSTï¼ˆState/Provinceï¼‰ï¼ŒCï¼ˆCountryï¼‰ã€‚</p>
  </li>
  <li>
    <p><strong>è®¤è¯ä¸­å¿ƒï¼ˆCA)</strong> 
è¯ä¹¦é¢å‘æœºæ„ï¼Œè´Ÿè´£è®¤è¯è¯ä¹¦ï¼Œå³ç»™è¯ä¹¦è¿›è¡Œç­¾åï¼Œé¢å‘è¯ä¹¦çš„æƒå¨æœºæ„ã€‚</p>
  </li>
  <li>
    <p><strong>è¯ä¹¦é“¾</strong> 
CAæœºæ„æœ‰æ—¶ä¹Ÿä¼šä¸ºå¦å¤–ä¸€å®¶CAæœºæ„é¢å‘è¯ä¹¦ã€‚
å½“æ£€æŸ¥è¯ä¹¦çš„æ—¶å€™ï¼Œéœ€è¦æ£€æŸ¥æ¯ä¸€çº§è¯ä¹¦çš„çˆ¶äº²è¯ä¹¦ï¼Œä¸€ç›´æ‰¾åˆ°ä¸€ä¸ªèƒ½ä¿¡ä»»çš„è¯ä¹¦ä¸ºæ­¢ã€‚</p>
  </li>
  <li>
    <p><strong>æ ¹CA</strong> 
æ¯ä¸ªè¯ä¹¦éœ€è¦å‘è¡Œè€…æ¥å£°æ˜è¯ä¹¦æ‹¥æœ‰è€…èº«ä»½çš„æœ‰æ•ˆæ€§ï¼Œä¸€ç›´åˆ°æœ€é¡¶å±‚CAã€‚
æœ€é¡¶å±‚CAæ²¡æœ‰å‘è¡Œè€…ï¼Œè¯ä¹¦é‡‡ç”¨ä¸€ç§â€œè‡ªç­¾åâ€çš„æ–¹å¼ï¼Œæ‰€ä»¥è¯ä¹¦çš„å‘è¡Œè€…å°±æ˜¯è¯ä¹¦æ‹¥æœ‰è€…è‡ªå·±ã€‚
ç”¨æˆ·ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå·±çš„è¯ä¹¦é¢å‘æœºæ„ã€‚</p>
  </li>
  <li>
    <p><strong>ä¸­çº§è¯ä¹¦</strong> 
å…·æœ‰ç»§ç»­é¢å‘ä¸‹çº§è¯ä¹¦æƒé™çš„å­CAã€‚</p>
  </li>
  <li>
    <p><strong>åº”ç”¨è¯ä¹¦</strong> 
ä¸èƒ½ç”¨æ¥ç»§ç»­é¢å‘ä¸‹çº§è¯ä¹¦ï¼Œåªèƒ½ç”¨æ¥è¯æ˜ä¸ªä½“èº«ä»½çš„è¯ä¹¦ã€‚ï¼ˆè¯ä¹¦æ²¡æœ‰-extensions v3_caé€‰é¡¹ï¼‰</p>
  </li>
  <li>
    <p><strong>CSRè¯ä¹¦ç”³è¯·æ–‡ä»¶</strong> 
Cerificate Signing Requestï¼Œè¯ä¹¦ç”³è¯·è€…åœ¨ç”³è¯·æ•°å­—è¯ä¹¦æ—¶ç”±CSP(åŠ å¯†æœåŠ¡æä¾›è€…)åœ¨ç”Ÿæˆç§é’¥çš„åŒæ—¶ä¹Ÿç”Ÿæˆè¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼Œè¯ä¹¦ç”³è¯· è€…åªè¦æŠŠCSRæ–‡ä»¶æäº¤ç»™è¯ä¹¦é¢å‘æœºæ„åï¼Œè¯ä¹¦é¢å‘æœºæ„ä½¿ç”¨å…¶æ ¹è¯ä¹¦ç§é’¥ç­¾åå°±ç”Ÿæˆäº†è¯ä¹¦å…¬é’¥æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯é¢å‘ç»™ç”¨æˆ·çš„è¯ä¹¦ã€‚</p>
  </li>
</ul>

<h1 id="ç”ŸæˆxmlæŠ¥æ–‡">ç”ŸæˆxmlæŠ¥æ–‡</h1>

<p>å¾…åŠ å¯†çš„XMLå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;RootInfo&gt;</span>
  <span class="nt">&lt;NS:Item</span> <span class="na">type=</span><span class="s">"1"</span> <span class="na">xmlns:NS=</span><span class="s">"http://www.woojean.com/"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;NS:id&gt;</span>01<span class="nt">&lt;/NS:id&gt;</span>
    <span class="nt">&lt;name&gt;</span>woojean<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;/NS:Item&gt;</span>
<span class="nt">&lt;/RootInfo&gt;</span>
</code></pre></div></div>

<p>ç”Ÿæˆè¯¥XMLçš„PHPæºç ï¼š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$xml</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLWriter</span><span class="p">();</span>

<span class="c1">//$xml-&gt;openUri("php://output");</span>
<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">openURI</span><span class="p">(</span><span class="s1">'test.xml'</span><span class="p">);</span>

<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">setIndentString</span><span class="p">(</span><span class="s1">'  '</span><span class="p">);</span>
<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">setIndent</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">startDocument</span><span class="p">(</span><span class="s1">'1.0'</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">);</span>

<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">startElement</span><span class="p">(</span><span class="s2">"RootInfo"</span><span class="p">);</span>
<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">startElementNS</span><span class="p">(</span><span class="s2">"NS"</span><span class="p">,</span><span class="s2">"Item"</span><span class="p">,</span><span class="s1">'http://www.woojean.com/'</span><span class="p">);</span>
<span class="c1">//æ·»åŠ å±æ€§</span>
<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">writeAttribute</span><span class="p">(</span><span class="s2">"type"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">);</span>

<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">startElementNS</span><span class="p">(</span><span class="s2">"NS"</span><span class="p">,</span><span class="s2">"id"</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span>
<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">text</span><span class="p">(</span><span class="s2">"01"</span><span class="p">);</span>
<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">endElement</span><span class="p">();</span>

<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">startElement</span><span class="p">(</span><span class="s2">"name"</span><span class="p">);</span>
<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">text</span><span class="p">(</span><span class="s2">"woojean"</span><span class="p">);</span>
<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">endElement</span><span class="p">();</span>

<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">endElement</span><span class="p">();</span>
<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">endElement</span><span class="p">();</span>
<span class="nv">$xml</span><span class="o">-&gt;</span><span class="nf">endDocument</span><span class="p">();</span>

<span class="c1">//header("Content-type: text/xml");</span>
<span class="c1">//echo $xml-&gt;outputMemory();</span>
</code></pre></div></div>

<h1 id="ç”Ÿæˆç§é’¥è¯ä¹¦">ç”Ÿæˆç§é’¥ã€è¯ä¹¦</h1>

<h2 id="å‡†å¤‡ç›®å½•">å‡†å¤‡ç›®å½•</h2>
<p>ç›®å½•ç»“æ„å–å†³äº/System/Library/OpenSSL/openssl.cnfçš„é…ç½®ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /Users/wujian/projects/demo/test
mkdir -p ./demoCA/private
mkdir -p ./demoCA/newcerts
touch ./demoCA/index.txt
echo 01 &gt; ./demoCA/serial
</code></pre></div></div>

<h2 id="ç”Ÿæˆè‡ªç­¾åçš„é¡¶çº§ca">ç”Ÿæˆè‡ªç­¾åçš„é¡¶çº§CA</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ç”Ÿæˆé¡¶çº§CAçš„å…¬é’¥è¯ä¹¦å’Œç§é’¥æ–‡ä»¶ï¼Œæœ‰æ•ˆæœŸ10å¹´ï¼ˆRSA 1024bitsï¼Œé»˜è®¤ï¼‰ï¼Œä¼šæç¤ºè¾“å…¥phraseã€DNä¿¡æ¯
openssl req -new -x509 -days 3650 -keyout CARoot.key -out CARoot.crt

# ä¸ºé¡¶çº§CAçš„ç§é’¥æ–‡ä»¶å»é™¤ä¿æŠ¤å£ä»¤ï¼ˆä¸æƒ³åœ¨è¿è¡Œè¿‡ç¨‹ä¸­è¿˜è¦è¾“å…¥åŠ å¯†å£ä»¤ï¼‰
openssl rsa -in CARoot.key -out CARoot.key
</code></pre></div></div>

<h2 id="ç”Ÿæˆä¸­çº§è¯ä¹¦ä¸åº”ç”¨è¯ä¹¦">ç”Ÿæˆä¸­çº§è¯ä¹¦ä¸åº”ç”¨è¯ä¹¦</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ä¸ºåº”ç”¨è¯ä¹¦/ä¸­çº§è¯ä¹¦ç”Ÿæˆç§é’¥æ–‡ä»¶  
openssl genrsa -out app.key 2048

# æ ¹æ®ç§é’¥æ–‡ä»¶ï¼Œä¸ºåº”ç”¨è¯ä¹¦/ä¸­çº§è¯ä¹¦ç”Ÿæˆcsræ–‡ä»¶ï¼ˆè¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼‰  
openssl req -new -key app.key -out app.csr

# ä½¿ç”¨CAçš„ç§é’¥æ–‡ä»¶ã€å…¬é’¥è¯ä¹¦ç»™csræ–‡ä»¶ç­¾åï¼Œç”Ÿæˆåº”ç”¨è¯ä¹¦ï¼Œæœ‰æ•ˆæœŸ5å¹´  
openssl ca -in app.csr -out app.crt -cert CARoot.crt -keyfile CARoot.key -days 1826 -policy policy_anything
</code></pre></div></div>
<p>æç¤ºï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Certificate is to be certified until Apr 27 06:46:15 2022 GMT (1826 days)
Sign the certificate? [y/n]:Y

1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated
</code></pre></div></div>

<p><strong>ç”Ÿæˆä¸­çº§è¯ä¹¦[æœ¬ä¾‹ç”¨ä¸åˆ°ï¼Œè¿™é‡Œå¤‡å¿˜]</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ä½¿ç”¨CAçš„å…¬ç§é’¥æ–‡ä»¶ç»™csræ–‡ä»¶ç­¾åï¼Œç”Ÿæˆä¸­çº§è¯ä¹¦ï¼Œæœ‰æ•ˆæœŸ5å¹´  
openssl ca -extensions v3_ca -in app.csr -out app.crt -cert CARoot.crt -keyfile CARoot.key -days 1826 -policy policy_anything
</code></pre></div></div>

<p><strong>ç”Ÿæˆ.pemæ ¼å¼çš„è¯ä¹¦</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat app.key &gt;&gt; app_private.pem
openssl rsa -in app.key -out app_private.pem 
openssl x509 -in app.crt -out app_public.pem -outform PEM
</code></pre></div></div>
<p>.cer/.crtæ˜¯ç”¨äºå­˜æ”¾è¯ä¹¦ï¼Œå®ƒæ˜¯2è¿›åˆ¶å½¢å¼å­˜æ”¾çš„ï¼Œä¸å«ç§é’¥ã€‚
.pemè·Ÿcrt/cerçš„åŒºåˆ«æ˜¯å®ƒä»¥Asciiæ¥è¡¨ç¤ºã€‚</p>

<h1 id="ç­¾åxmlæŠ¥æ–‡">ç­¾åXMLæŠ¥æ–‡</h1>

<h2 id="å‡†å¤‡å‰ç½®æ•°æ®">å‡†å¤‡å‰ç½®æ•°æ®</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="s1">'/Users/wujian/projects/demo/xmlseclibs/src/XMLSecEnc.php'</span><span class="p">;</span>
<span class="k">require_once</span> <span class="s1">'/Users/wujian/projects/demo/xmlseclibs/src/XMLSecurityDSig.php'</span><span class="p">;</span>
<span class="k">require_once</span> <span class="s1">'/Users/wujian/projects/demo/xmlseclibs/src/XMLSecurityKey.php'</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">RobRichards\XMLSecLibs\XMLSecEnc</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">RobRichards\XMLSecLibs\XMLSecurityDSig</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">RobRichards\XMLSecLibs\XMLSecurityKey</span><span class="p">;</span>

<span class="nv">$privateKey</span> <span class="o">=</span> <span class="s1">'/Users/wujian/projects/demo/test/app_private.pem'</span><span class="p">;</span>
<span class="nv">$publicKey</span> <span class="o">=</span> <span class="s1">'/Users/wujian/projects/demo/test/app_public.pem'</span><span class="p">;</span>
<span class="nv">$dumpPath</span> <span class="o">=</span> <span class="s1">'/Users/wujian/projects/demo/dump3.xml'</span><span class="p">;</span>

<span class="nv">$xmlStr</span> <span class="o">=</span> <span class="s1">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;RootInfo&gt;
  &lt;NS:Item type="3" xmlns:NS="http://www.woojean.com/"&gt;
    &lt;NS:id&gt;021&lt;/NS:id&gt;
    &lt;name&gt;woojean&lt;/name&gt;
  &lt;/NS:Item&gt;
&lt;/RootInfo&gt;'</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="ç­¾å">ç­¾å</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DOMDocument</span><span class="p">();</span>
<span class="nv">$doc</span><span class="o">-&gt;</span><span class="nf">loadXML</span><span class="p">(</span><span class="nv">$xmlStr</span><span class="p">);</span>

<span class="nv">$objDSig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLSecurityDSig</span><span class="p">();</span>
<span class="nv">$objDSig</span><span class="o">-&gt;</span><span class="nf">setCanonicalMethod</span><span class="p">(</span><span class="nc">XMLSecurityDSig</span><span class="o">::</span><span class="no">EXC_C14N</span><span class="p">);</span>
<span class="nv">$objDSig</span><span class="o">-&gt;</span><span class="nf">addReference</span><span class="p">(</span>
    <span class="nv">$doc</span><span class="p">,</span>
    <span class="nc">XMLSecurityDSig</span><span class="o">::</span><span class="no">SHA256</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">'http://www.w3.org/2000/09/xmldsig#enveloped-signature'</span><span class="p">]</span>
<span class="p">);</span>

<span class="nv">$objKey</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLSecurityKey</span><span class="p">(</span><span class="nc">XMLSecurityKey</span><span class="o">::</span><span class="no">RSA_SHA256</span><span class="p">,</span> <span class="p">[</span><span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'private'</span><span class="p">]);</span>
<span class="nv">$objKey</span><span class="o">-&gt;</span><span class="nf">loadKey</span><span class="p">(</span><span class="nv">$privateKey</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">);</span>
<span class="c1">// $objKey-&gt;passphrase = '&lt;passphrase&gt;';  // å¯†ç </span>

<span class="nv">$objDSig</span><span class="o">-&gt;</span><span class="nf">sign</span><span class="p">(</span><span class="nv">$objKey</span><span class="p">);</span>
<span class="nv">$keyNameNode</span> <span class="o">=</span> <span class="nv">$objDSig</span><span class="o">-&gt;</span><span class="n">sigNode</span><span class="o">-&gt;</span><span class="n">ownerDocument</span><span class="o">-&gt;</span><span class="nf">createElementNS</span><span class="p">(</span><span class="s1">'http://www.w3.org/2000/09/xmldsig#'</span><span class="p">,</span> <span class="s1">'ds:KeyName'</span><span class="p">,</span><span class="s1">'my_public_key'</span><span class="p">);</span>
<span class="nv">$objDSig</span><span class="o">-&gt;</span><span class="nf">appendToKeyInfo</span><span class="p">(</span><span class="nv">$keyNameNode</span><span class="p">);</span>
<span class="nv">$objDSig</span><span class="o">-&gt;</span><span class="nf">add509Cert</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$publicKey</span><span class="p">));</span>
<span class="nv">$objDSig</span><span class="o">-&gt;</span><span class="nf">appendSignature</span><span class="p">(</span><span class="nv">$doc</span><span class="o">-&gt;</span><span class="n">documentElement</span><span class="p">);</span>

<span class="nv">$doc</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">(</span><span class="nv">$dumpPath</span><span class="p">);</span>
</code></pre></div></div>

<p><strong>ç­¾ååçš„æŠ¥æ–‡</strong></p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;RootInfo&gt;</span>
  <span class="nt">&lt;NS:Item</span> <span class="na">xmlns:NS=</span><span class="s">"http://www.woojean.com/"</span> <span class="na">type=</span><span class="s">"3"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;NS:id&gt;</span>021<span class="nt">&lt;/NS:id&gt;</span>
    <span class="nt">&lt;name&gt;</span>woojean<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;/NS:Item&gt;</span>
<span class="nt">&lt;ds:Signature</span> <span class="na">xmlns:ds=</span><span class="s">"http://www.w3.org/2000/09/xmldsig#"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ds:SignedInfo&gt;&lt;ds:CanonicalizationMethod</span> <span class="na">Algorithm=</span><span class="s">"http://www.w3.org/2001/10/xml-exc-c14n#"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;ds:SignatureMethod</span> <span class="na">Algorithm=</span><span class="s">"http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;ds:Reference&gt;&lt;ds:Transforms&gt;&lt;ds:Transform</span> <span class="na">Algorithm=</span><span class="s">"http://www.w3.org/2000/09/xmldsig#enveloped-signature"</span><span class="nt">/&gt;&lt;/ds:Transforms&gt;&lt;ds:DigestMethod</span> <span class="na">Algorithm=</span><span class="s">"http://www.w3.org/2001/04/xmlenc#sha256"</span><span class="nt">/&gt;&lt;ds:DigestValue&gt;</span>73MIGt50pK6TaTWoCiehnuRHII2HgOgqjjnrmR0+PqA=<span class="nt">&lt;/ds:DigestValue&gt;&lt;/ds:Reference&gt;&lt;/ds:SignedInfo&gt;&lt;ds:SignatureValue&gt;</span>HPYP4AxYhsC6g25Cfd4hMrmPCJmfr+4jw34LAKay2fcU2MzNAItB6bQVrWNaWiQt5wr93ms+CCUF/Q0j5IMolSmJIO7R1NpEj1zpn+/2pqDPoiUNUJbJmZLZH3+dVPrSZqYcCQWz121gBpcjHpPvChLf4OI3+0Nu98BbLZF2XUMwBMUjAainK9QjyDFp13U97zRm50baigjE1rAcLxi1DuZPJljtPmwqPvhy2j7754ekbQUBVhfHe20AnkZs930Y48kOXoCGwq9pD6gsgRT1BA1+DsOlZKo13P/aakuuKoroJ+horPbC88tVU36KQ1aMkAVXdWwdecrfCF4/EEj8KA==<span class="nt">&lt;/ds:SignatureValue&gt;</span>
<span class="nt">&lt;ds:KeyInfo&gt;&lt;ds:KeyName&gt;</span>my_public_key<span class="nt">&lt;/ds:KeyName&gt;&lt;ds:X509Data&gt;&lt;ds:X509Certificate&gt;</span>MIIDITCCAoqgAwIBAgIBATANBgkqhkiG9w0BAQUFADBVMQswCQYDVQQGEwJVUzELMAkGA1UECBMCV1UxDTALBgNVBAcTBEpJQU4xCzAJBgNVBAoTAldVMQswCQYDVQQLEwJXVTEQMA4GA1UEAxMHd29vamVhbjAeFw0xNzA0MjcwNjQ2MTVaFw0yMjA0MjcwNjQ2MTVaMFcxCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJXVTENMAsGA1UEBxMESklBTjELMAkGA1UEChMCV1UxDTALBgNVBAsTBEpJQU4xEDAOBgNVBAMTB3dvb2plYW4wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDC2JgwHZjRtiXpiQU7SL9VdfqamOJuZ+crD84HwXPuypkHakR+GSVo1aRhbOO2h55xeAG7C5S/qHRfVtJ5KFVckXWFgndTfZNCS2PycZqnu2MFIburpPcp/Bf7e+Z2ldluyC3TDExCma63uk5kGakzbCS/7kpocEVsJrEIYGdzjNTp+JclKJcfmCq/YZ8M3OVhPr4RuO/PdTtzL3uMiyGU9wO17nl9VsTIbgxKYs+/bI2pOEE9iFPHDAEhsaF/k1SBZXlLAmE0x/HVw4SraE5AqL7KLS3Rc/rRp8WveqmHvIqDbX4jv6jgrSMcCznqv+/VUv4IGt7qwbBuPWVGhUsNAgMBAAGjezB5MAkGA1UdEwQCMAAwLAYJYIZIAYb4QgENBB8WHU9wZW5TU0wgR2VuZXJhdGVkIENlcnRpZmljYXRlMB0GA1UdDgQWBBQ2Dq/d05/Egnytyvplxu4ykfnvqTAfBgNVHSMEGDAWgBQhnHeUnjnTvK0UnFLZkaRz4VT4CTANBgkqhkiG9w0BAQUFAAOBgQBaCL75URSWqJMA3uWWcwwjWEF0KFiasXzhEAdyeHOoqu8mZHLAXDgKxVpFPfNHAE6Dq9V5cVzqdYC6j5HVdVO6P3wlZXRCrn3MGMmjtfkFu0PNhbWKz//IpJR16d4NqvF8xLtYYvhqMq1jl5gAyFRHTF2itLW3lHkZLAAZG9+o9g==<span class="nt">&lt;/ds:X509Certificate&gt;&lt;/ds:X509Data&gt;&lt;/ds:KeyInfo&gt;&lt;/ds:Signature&gt;&lt;/RootInfo&gt;</span>
</code></pre></div></div>

<h1 id="éªŒè¯æŠ¥æ–‡">éªŒè¯æŠ¥æ–‡</h1>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DOMDocument</span><span class="p">();</span>
<span class="nv">$doc</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nv">$dumpPath</span><span class="p">);</span>

<span class="nv">$objXMLSecDSig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLSecurityDSig</span><span class="p">();</span>
<span class="nv">$objDSig</span> <span class="o">=</span> <span class="nv">$objXMLSecDSig</span><span class="o">-&gt;</span><span class="nf">locateSignature</span><span class="p">(</span><span class="nv">$doc</span><span class="p">);</span>
<span class="nv">$objXMLSecDSig</span><span class="o">-&gt;</span><span class="nf">canonicalizeSignedInfo</span><span class="p">();</span>
<span class="nv">$objKey</span> <span class="o">=</span> <span class="nv">$objXMLSecDSig</span><span class="o">-&gt;</span><span class="nf">locateKey</span><span class="p">();</span>

<span class="nc">XMLSecEnc</span><span class="o">::</span><span class="nf">staticLocateKeyInfo</span><span class="p">(</span><span class="nv">$objKey</span><span class="p">,</span> <span class="nv">$objDSig</span><span class="p">);</span>
<span class="nv">$publicKey</span> <span class="o">=</span> <span class="nv">$objKey</span><span class="o">-&gt;</span><span class="nf">getX509Certificate</span><span class="p">();</span>

<span class="nv">$keyAlgorithm</span> <span class="o">=</span> <span class="nv">$objKey</span><span class="o">-&gt;</span><span class="nf">getAlgorith</span><span class="p">();</span>

<span class="c1">// Check signature</span>
<span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$objXMLSecDSig</span><span class="o">-&gt;</span><span class="nf">verify</span><span class="p">(</span><span class="nv">$objKey</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!==</span> <span class="nv">$ret</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">var_dump</span><span class="p">(</span><span class="s1">'wrong!'</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">FALSE</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span><span class="p">{</span>
    <span class="nb">var_dump</span><span class="p">(</span><span class="s1">'ok!'</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Check references (data)</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="nv">$objXMLSecDSig</span><span class="o">-&gt;</span><span class="nf">validateReference</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="err">\</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">FALSE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>è¾“å‡º</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/wujian/projects/demo/decrypt.php:37:string 'ok!' (length=3)
</code></pre></div></div>

<h1 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h1>

<ul>
  <li><a href="http://blog.csdn.net/howeverpf/article/details/21622545?reload">http://blog.csdn.net/howeverpf/article/details/21622545?reload</a></li>
  <li><a href="http://www.baike.com/wiki/SSL">http://www.baike.com/wiki/SSL</a></li>
  <li><a href="https://github.com/robrichards/xmlseclibs">https://github.com/robrichards/xmlseclibs</a></li>
  <li><a href="https://serverfault.com/questions/706336/how-to-get-a-pem-file-from-ssh-key-pair">https://serverfault.com/questions/706336/how-to-get-a-pem-file-from-ssh-key-pair</a></li>
  <li><a href="http://www.jianshu.com/p/98569e81cc0b">http://www.jianshu.com/p/98569e81cc0b</a></li>
</ul>

:ET