I"Ä<ul id="markdown-toc">
  <li><a href="#å‡†å¤‡" id="markdown-toc-å‡†å¤‡">å‡†å¤‡</a>    <ul>
      <li><a href="#å®‰è£…rabbitmq-server" id="markdown-toc-å®‰è£…rabbitmq-server">å®‰è£…rabbitmq server</a></li>
      <li><a href="#å®‰è£…php-amqplibåŒ…" id="markdown-toc-å®‰è£…php-amqplibåŒ…">å®‰è£…php-amqplibåŒ…</a></li>
    </ul>
  </li>
  <li><a href="#ä¾‹hello-world-" id="markdown-toc-ä¾‹hello-world-">ä¾‹ï¼šHello World !</a>    <ul>
      <li><a href="#ç”Ÿäº§è€…sendphp" id="markdown-toc-ç”Ÿäº§è€…sendphp">ç”Ÿäº§è€…ï¼šsend.php</a></li>
      <li><a href="#æ¶ˆè´¹è€…receivephp" id="markdown-toc-æ¶ˆè´¹è€…receivephp">æ¶ˆè´¹è€…ï¼šreceive.php</a></li>
      <li><a href="#æµ‹è¯•" id="markdown-toc-æµ‹è¯•">æµ‹è¯•</a></li>
    </ul>
  </li>
  <li><a href="#ä¾‹work-queues" id="markdown-toc-ä¾‹work-queues">ä¾‹ï¼šWork Queues</a>    <ul>
      <li><a href="#æ·»åŠ æ–°ä»»åŠ¡new_taskphp" id="markdown-toc-æ·»åŠ æ–°ä»»åŠ¡new_taskphp">æ·»åŠ æ–°ä»»åŠ¡ï¼šnew_task.php</a></li>
      <li><a href="#ä»»åŠ¡å¤„ç†å™¨workerphp" id="markdown-toc-ä»»åŠ¡å¤„ç†å™¨workerphp">ä»»åŠ¡å¤„ç†å™¨ï¼šworker.php</a></li>
    </ul>
  </li>
  <li><a href="#ä¾‹publishsubscribe" id="markdown-toc-ä¾‹publishsubscribe">ä¾‹ï¼šPublish/Subscribe</a>    <ul>
      <li><a href="#logæ¥æ”¶è€…" id="markdown-toc-logæ¥æ”¶è€…">logæ¥æ”¶è€…</a></li>
      <li><a href="#logå‘é€è€…" id="markdown-toc-logå‘é€è€…">logå‘é€è€…</a></li>
    </ul>
  </li>
  <li><a href="#ä¾‹routing" id="markdown-toc-ä¾‹routing">ä¾‹ï¼šRouting</a>    <ul>
      <li><a href="#å‘å‡ºæ—¥å¿—emit_log_directphp" id="markdown-toc-å‘å‡ºæ—¥å¿—emit_log_directphp">å‘å‡ºæ—¥å¿—ï¼šemit_log_direct.php</a></li>
      <li><a href="#å¤„ç†æ—¥å¿—receive_logs_directphp" id="markdown-toc-å¤„ç†æ—¥å¿—receive_logs_directphp">å¤„ç†æ—¥å¿—ï¼šreceive_logs_direct.php</a></li>
      <li><a href="#æµ‹è¯•-1" id="markdown-toc-æµ‹è¯•-1">æµ‹è¯•</a></li>
    </ul>
  </li>
  <li><a href="#ä¾‹topics" id="markdown-toc-ä¾‹topics">ä¾‹ï¼šTopics</a>    <ul>
      <li><a href="#å‘å‡ºæ—¥å¿—emit_log_directphp-1" id="markdown-toc-å‘å‡ºæ—¥å¿—emit_log_directphp-1">å‘å‡ºæ—¥å¿—ï¼šemit_log_direct.php</a></li>
      <li><a href="#å¤„ç†æ—¥å¿—receive_logs_directphp-1" id="markdown-toc-å¤„ç†æ—¥å¿—receive_logs_directphp-1">å¤„ç†æ—¥å¿—ï¼šreceive_logs_direct.php</a></li>
      <li><a href="#æµ‹è¯•-2" id="markdown-toc-æµ‹è¯•-2">æµ‹è¯•</a></li>
    </ul>
  </li>
  <li><a href="#ä¾‹remote-procedure-call-rpc" id="markdown-toc-ä¾‹remote-procedure-call-rpc">ä¾‹ï¼šRemote procedure call (RPC)</a>    <ul>
      <li><a href="#rpc_serverphp" id="markdown-toc-rpc_serverphp">rpc_server.php</a></li>
      <li><a href="#rpc_clientphp" id="markdown-toc-rpc_clientphp">rpc_client.php</a></li>
    </ul>
  </li>
</ul>

<p><a href="https://github.com/woojean/demos/tree/master/rabbitmq-tutorials">ä¸‹è½½ä»£ç :https://github.com/woojean/demos/tree/master/rabbitmq-tutorials</a></p>

<h1 id="å‡†å¤‡">å‡†å¤‡</h1>
<h2 id="å®‰è£…rabbitmq-server">å®‰è£…rabbitmq server</h2>
<p>ç•¥ã€‚</p>

<h2 id="å®‰è£…php-amqplibåŒ…">å®‰è£…php-amqplibåŒ…</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /Users/wujian/projects/demo/rabbitmq
composer require php-amqplib/php-amqplib
</code></pre></div></div>

<h1 id="ä¾‹hello-world-">ä¾‹ï¼šHello World !</h1>

<p>ä¸€ä¸ªç”Ÿäº§è€…å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…æ”¶åˆ°è¯¥æ¶ˆæ¯å¹¶æ‰“å°ã€‚</p>

<h2 id="ç”Ÿäº§è€…sendphp">ç”Ÿäº§è€…ï¼šsend.php</h2>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Connection\AMQPStreamConnection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Message\AMQPMessage</span><span class="p">;</span>

<span class="nv">$queueName</span> <span class="o">=</span> <span class="s1">'queue_hello'</span><span class="p">;</span>
<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPStreamConnection</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span><span class="mi">5672</span><span class="p">,</span><span class="s1">'guest'</span><span class="p">,</span><span class="s1">'guest'</span><span class="p">);</span>  <span class="c1">// vhost</span>

<span class="c1">// AMQP 0-9-1 connections are multiplexed with channels that can be thought of as â€œlightweight connections that share a single TCP connectionâ€.</span>
<span class="nv">$channel</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">channel</span><span class="p">();</span>

<span class="c1">// declare a queue for us to send to</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">queue_declare</span><span class="p">(</span><span class="nv">$queueName</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>

<span class="c1">// publish a message to the queue</span>
<span class="nv">$msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPMessage</span><span class="p">(</span><span class="s1">'Hello World!'</span><span class="p">);</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">basic_publish</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span><span class="s1">''</span><span class="p">,</span> <span class="nv">$queueName</span><span class="p">);</span>

<span class="k">echo</span> <span class="s2">" [x] Sent 'Hello World!'</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="c1">// close the channel and the connection</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="æ¶ˆè´¹è€…receivephp">æ¶ˆè´¹è€…ï¼šreceive.php</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Connection\AMQPStreamConnection</span><span class="p">;</span>

<span class="nv">$queueName</span> <span class="o">=</span> <span class="s1">'queue_hello'</span><span class="p">;</span>
<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPStreamConnection</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">5672</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">);</span>
<span class="nv">$channel</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">channel</span><span class="p">();</span>

<span class="c1">// Note that we declare the queue here, as well. Because we might start the consumer before the publisher, we want to make sure the queue exists before we try to consume messages from it.</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">queue_declare</span><span class="p">(</span><span class="nv">$queueName</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>
<span class="k">echo</span> <span class="s1">' [*] Waiting for messages. To exit press CTRL+C'</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="c1">// define a PHP callable that will receive the messages sent by the server</span>
<span class="nv">$callback</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="nv">$msg</span><span class="p">){</span>
    <span class="k">echo</span> <span class="s2">" [x] Received "</span><span class="p">,</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">};</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">basic_consume</span><span class="p">(</span><span class="nv">$queueName</span><span class="p">,</span><span class="s1">''</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="nv">$callback</span><span class="p">);</span>

<span class="cm">/*
basic_consume(...)çš„ç¬¬2ä¸ªå‚æ•°æ˜¯$consumer_tagï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¼šå¯¹å½“å‰$channelå¯¹è±¡æ‰§è¡Œï¼š
$this-&gt;callbacks[$consumer_tag] = $callback;
æ‰€ä»¥ï¼Œå½“$channelå¯¹è±¡çš„callbacksåˆ—è¡¨ä¸ä¸ºç©ºæ—¶ï¼Œè¡¨æ˜å­˜åœ¨ç›‘å¬è¯¥channelçš„æ¶ˆè´¹è€…
*/</span>

<span class="c1">// keep it running to listen for messages and print them out .</span>
<span class="k">while</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$channel</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">)){</span>
    <span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">wait</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="æµ‹è¯•">æµ‹è¯•</h2>
<p>å…ˆæ‰§è¡Œæ¶ˆè´¹è€…ï¼Œå†æ‰§è¡Œç”Ÿäº§è€…ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php receive.php
php send.php
</code></pre></div></div>

<h1 id="ä¾‹work-queues">ä¾‹ï¼šWork Queues</h1>
<p>è½®è¯¢åœ°åˆ†å‘æ¶ˆæ¯ã€‚<u>å¯åŠ¨2ä¸ªworkerï¼Œä¹‹åæ‰§è¡Œå¤šæ¬¡new_taskï¼Œæ¶ˆæ¯å°†ä¼šåœ¨2ä¸ªworkerä¹‹é—´äº¤æ›¿è¿›è¡Œå¤„ç†ã€‚</u></p>

<p>å·¥ä½œé˜Ÿåˆ—çš„æ–¹å¼éå¸¸ä¾¿äºå¹¶å‘æ‰©å±•ï¼ˆé€šè¿‡æ·»åŠ æ›´å¤šçš„é˜Ÿåˆ—ï¼‰ã€‚RabbitMQä¼šæŒ‰åºå‘é€æ¯ä¸€ä¸ªæ¶ˆæ¯è‡³ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œæ‰€ä»¥ä»å¹³å‡æ¥è®²ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…å°†ä¼šæ”¶åˆ°ç›¸åŒæ•°é‡çš„æ¶ˆæ¯ã€‚</p>

<p>æ¶ˆæ¯æ²¡æœ‰è¶…æ—¶çš„æ¦‚å¿µï¼Œæ‰€ä»¥å¤„ç†æ¶ˆæ¯çš„æ—¶é—´å¯ä»¥å¾ˆé•¿ã€‚RabbitMQé€šè¿‡åˆ¤æ–­è¿æ¥æ˜¯å¦æ–­å¼€æ¥åˆ¤æ–­æ¶ˆè´¹è€…æ˜¯å¦å´©æºƒã€‚</p>

<p>æ¶ˆæ¯ç¡®è®¤ï¼ˆMessage acknowledgmentsï¼‰é»˜è®¤æ˜¯å…³é—­çš„ã€‚</p>

<p>ä¸ºäº†ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œè¦å°†é˜Ÿåˆ—å’Œæ¶ˆæ¯éƒ½è®¾ç½®ä¸ºæŒä¹…åŒ–ï¼ˆdurableï¼‰ã€‚</p>

<p>Marking messages as persistent doesnâ€™t fully guarantee that a message wonâ€™t be lost. Although it tells RabbitMQ to save the message to disk, <strong>there is still a short time window when RabbitMQ has accepted a message and hasnâ€™t saved it yet</strong>. Also, RabbitMQ doesnâ€™t do fsync(2) for every message â€“ it may be just saved to cache and not really written to the disk. The persistence guarantees arenâ€™t strong, but itâ€™s more than enough for our simple task queue. If you need a stronger guarantee then you can use publisher confirms.</p>

<p>RabbitMQåœ¨æ”¶åˆ°æ¶ˆæ¯æ—¶å°±ç›´æ¥åˆ†å‘ï¼Œè€Œä¸ä¼šå»æ£€æŸ¥å½“å‰æŸä¸ªæ¶ˆè´¹è€…æœªç¡®è®¤çš„æ¶ˆæ¯çš„æ•°é‡ï¼Œå®ƒåªæ˜¯ç›²ç›®åœ°åˆ†å‘ä¸‹ä¸€ä¸ªæ¶ˆæ¯å»å¾€ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚</p>

<h2 id="æ·»åŠ æ–°ä»»åŠ¡new_taskphp">æ·»åŠ æ–°ä»»åŠ¡ï¼šnew_task.php</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Connection\AMQPStreamConnection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Message\AMQPMessage</span><span class="p">;</span>

<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPStreamConnection</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">5672</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">);</span>
<span class="nv">$channel</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">channel</span><span class="p">();</span>

<span class="c1">// ç¬¬3ä¸ªå‚æ•°ä¸ºtrueï¼Œä»£è¡¨é˜Ÿåˆ—çš„durableä¸ºtrueï¼Œæ­¤å¤„è¦ä¸workerä¸­çš„å®šä¹‰ä¸€è‡´</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">queue_declare</span><span class="p">(</span><span class="s1">'task_queue'</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>

<span class="c1">// æ‹¼è£…æ¶ˆæ¯å‚æ•°</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="s2">"Hello World!"</span><span class="p">;</span>
<span class="nv">$msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPMessage</span><span class="p">(</span><span class="nv">$data</span><span class="p">,[</span>
    <span class="s1">'delivery_mode'</span> <span class="o">=&gt;</span> <span class="nc">AMQPMessage</span><span class="o">::</span><span class="no">DELIVERY_MODE_PERSISTENT</span>  <span class="c1">// ä»£è¡¨æŒä¹…åŒ–æ¶ˆæ¯</span>
<span class="p">]);</span>

<span class="c1">// å‘å¸ƒæ¶ˆæ¯</span>
<span class="c1">// exchangeä¸ºç©ºå­—ç¬¦ä¸²ï¼Œå³ä½¿ç”¨default exchangeï¼Œé‚£ä¹ˆé˜Ÿåˆ—åå°±æ˜¯routing key</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">basic_publish</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span><span class="s1">''</span><span class="p">,</span><span class="s1">'task_queue'</span><span class="p">);</span>
<span class="k">echo</span> <span class="s2">" [x] Sent "</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="ä»»åŠ¡å¤„ç†å™¨workerphp">ä»»åŠ¡å¤„ç†å™¨ï¼šworker.php</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Connection\AMQPStreamConnection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Message\AMQPMessage</span><span class="p">;</span>

<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPStreamConnection</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">5672</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">);</span>
<span class="nv">$channel</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">channel</span><span class="p">();</span>

<span class="c1">// ç¬¬3ä¸ªå‚æ•°ä¸ºtrueï¼Œä»£è¡¨é˜Ÿåˆ—çš„durableä¸ºtrue</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">queue_declare</span><span class="p">(</span><span class="s1">'task_queue'</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>
<span class="k">echo</span> <span class="s1">' [*] Waiting for messages. To exit press CTRL+C'</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="c1">// å®šä¹‰ä»»åŠ¡å¤„ç†å‡½æ•°</span>
<span class="nv">$callback</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$msg</span><span class="p">){</span>
    <span class="k">echo</span> <span class="s2">" [x] Received "</span><span class="p">,</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>  <span class="c1">// æ€»ä¹‹ï¼Œæ¶ˆæ¯ä½“çš„å½¢å¼è‚¯å®šæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆbyte stringï¼‰</span>
    <span class="nb">sleep</span><span class="p">(</span><span class="nb">substr_count</span><span class="p">(</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">));</span>  <span class="c1">// æ¨¡æ‹Ÿä»»åŠ¡æ‰§è¡Œæ—¶é—´</span>
    <span class="k">echo</span> <span class="s2">" [x] Done"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

    <span class="c1">// message acknowledgment</span>
    <span class="nv">$msg</span><span class="o">-&gt;</span><span class="n">delivery_info</span><span class="p">[</span><span class="s1">'channel'</span><span class="p">]</span><span class="o">-&gt;</span><span class="nf">basic_ack</span><span class="p">(</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="n">delivery_info</span><span class="p">[</span><span class="s1">'delivery_tag'</span><span class="p">]);</span>
<span class="p">};</span>

<span class="c1">// prefetch_count = 1,This tells RabbitMQ not to give more than one message to a worker at a time.</span>
<span class="c1">// in other words, don't dispatch a new message to a worker until it has processed and acknowledged the previous one. Instead, it will dispatch it to the next worker that is not still busy.</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">basic_qos</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">basic_consume</span><span class="p">(</span><span class="s1">'task_queue'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="nv">$callback</span><span class="p">);</span>

<span class="k">while</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$channel</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">wait</span><span class="p">();</span>
<span class="p">}</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
</code></pre></div></div>

<h1 id="ä¾‹publishsubscribe">ä¾‹ï¼šPublish/Subscribe</h1>
<p>åˆ†å‘ä¸€ä¸ªæ¶ˆæ¯ç»™å¤šä¸ªæ¶ˆè´¹è€…ã€‚</p>

<p>RabbitMQçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šç”Ÿäº§è€…ä»ä¸ç›´æ¥å°†æ¶ˆæ¯å‘é€ç»™é˜Ÿåˆ—ï¼Œè€Œæ˜¯å°†æ¶ˆæ¯å‘é€ç»™exchangeï¼Œexchangeåœ¨æ¥æ”¶åˆ°æ¶ˆæ¯åéœ€è¦çŸ¥é“å¦‚ä½•è¿›è¡Œåˆ†å‘ï¼šåˆ†å‘ç»™ç‰¹å®šçš„æŸä¸ªé˜Ÿåˆ—ã€åˆ†å‘ç»™å¤šä¸ªé˜Ÿåˆ—ã€ä¸¢å¼ƒæ¶ˆæ¯ç­‰ï¼Œå–å†³äºexchangeçš„ç±»å‹ï¼šdirect, topic, headers , fanoutã€‚</p>

<p>å¦‚æœä½¿ç”¨ç©ºå­—ç¬¦ä¸²å®šä¹‰é˜Ÿåˆ—ï¼Œå°†ä¼šåˆ›ä¸€ä¸ªéæŒä¹…åŒ–çš„é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—çš„åå­—è‡ªåŠ¨ç”Ÿæˆï¼ˆä»¥amq.å¼€å¤´ï¼‰ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>list($queue_name, ,) = $channel-&gt;queue_declare(""); // amq.gen-JzTY20BRgKO-HjmUJj0wLg
</code></pre></div></div>
<p>exchangeå’Œé˜Ÿåˆ—ä¹‹é—´çš„å…³ç³»ç§°ä¸ºbinding.</p>

<h2 id="logæ¥æ”¶è€…">logæ¥æ”¶è€…</h2>
<p>æ¯æ¬¡è¿è¡ŒåŠ¨æ€ç”Ÿæˆä¸€ä¸ªqueueï¼Œå¹¶ç»‘å®šåˆ°ç›¸åº”çš„exchangeä¸Š</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Connection\AMQPStreamConnection</span><span class="p">;</span>

<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPStreamConnection</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">5672</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">);</span>
<span class="nv">$channel</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">channel</span><span class="p">();</span>

<span class="c1">// å®šä¹‰fanout exchange</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">exchange_declare</span><span class="p">(</span><span class="s1">'logs'</span><span class="p">,</span><span class="s1">'fanout'</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>

<span class="c1">// ç”Ÿæˆä¸€ä¸ªä¸´æ—¶queueï¼Œå¹¶ä¿å­˜queueçš„åå­—</span>
<span class="k">list</span><span class="p">(</span><span class="nv">$queue_name</span><span class="p">,,)</span> <span class="o">=</span> <span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">queue_declare</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span><span class="kc">TRUE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>

<span class="c1">// å°†queueç»‘å®šåˆ°exchangeï¼Œå› ä¸ºè¯¥exchangeæ˜¯ä¸€ä¸ªfanoutç±»å‹çš„ï¼Œæ‰€ä»¥ç»‘å®šçš„æ¯ä¸ªqueueå°†è¢«å¹¿æ’­</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">queue_bind</span><span class="p">(</span><span class="nv">$queue_name</span><span class="p">,</span><span class="s1">'logs'</span><span class="p">);</span>  <span class="c1">// queue -&gt; exchange</span>
<span class="k">echo</span> <span class="s1">' [*] Waiting for logs. To exit press CTRL+C'</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="nv">$callback</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">' [x] '</span><span class="p">,</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">};</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">basic_consume</span><span class="p">(</span><span class="nv">$queue_name</span><span class="p">,</span><span class="s1">''</span><span class="p">,</span><span class="kc">FALSE</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="nv">$callback</span><span class="p">);</span>

<span class="k">while</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$channel</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">wait</span><span class="p">();</span>
<span class="p">}</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="logå‘é€è€…">logå‘é€è€…</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Connection\AMQPStreamConnection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Message\AMQPMessage</span><span class="p">;</span>

<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPStreamConnection</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">5672</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">);</span>
<span class="nv">$channel</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">channel</span><span class="p">();</span>

<span class="c1">// å®šä¹‰ä¸€ä¸ªfanoutç±»å‹çš„exchange</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">exchange_declare</span><span class="p">(</span><span class="s1">'logs'</span><span class="p">,</span><span class="s1">'fanout'</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">FALSE</span><span class="p">,</span><span class="kc">FALSE</span><span class="p">);</span>

<span class="c1">// æ‹¼è£…æ¶ˆæ¯</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="s2">"info: Hello World!"</span><span class="p">;</span>
<span class="nv">$msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPMessage</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>

<span class="c1">// å°†æ¶ˆæ¯å‘å¸ƒåˆ°exchange</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">basic_publish</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span><span class="s1">'logs'</span><span class="p">);</span>

<span class="k">echo</span> <span class="s2">" [x] Sent "</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
</code></pre></div></div>

<h1 id="ä¾‹routing">ä¾‹ï¼šRouting</h1>
<p>åªå¤„ç†å…¨éƒ¨æ¶ˆæ¯çš„å­é›†ã€‚æ¯”å¦‚åœ¨èƒ½å¤Ÿæ‰“å°æ‰€æœ‰æ—¥å¿—çš„åŒæ—¶ï¼Œå°†é”™è¯¯æ—¥å¿—ä¿å­˜åˆ°ç£ç›˜ã€‚</p>

<p>å¤šä¸ªqueueå¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªrouting keyç»‘å®šåˆ°åŒä¸€ä¸ªexchangeã€‚
åŒä¸€ä¸ªqueueå’ŒåŒä¸€ä¸ªexchangeä¹‹é—´ä¹Ÿå¯ä»¥ç»‘å®šå¤šä¸ªä¸åŒçš„keyã€‚</p>

<h2 id="å‘å‡ºæ—¥å¿—emit_log_directphp">å‘å‡ºæ—¥å¿—ï¼šemit_log_direct.php</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Connection\AMQPStreamConnection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Message\AMQPMessage</span><span class="p">;</span>

<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPStreamConnection</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">5672</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">);</span>
<span class="nv">$channel</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">channel</span><span class="p">();</span>

<span class="c1">// å®šä¹‰ä¸€ä¸ªdirectç±»å‹çš„exchange</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">exchange_declare</span><span class="p">(</span><span class="s1">'direct_logs'</span><span class="p">,</span> <span class="s1">'direct'</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>

<span class="c1">// è·å–ç”¨æˆ·è¾“å…¥</span>
<span class="nv">$severity</span> <span class="o">=</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="s1">'info'</span><span class="p">;</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="nb">array_slice</span><span class="p">(</span><span class="nv">$argv</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="s2">"Hello World!"</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPMessage</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>

<span class="c1">// å‘å‡ºä¿¡æ¯ï¼Œå…¶ä¸­$severityä¸ºroute key</span>
<span class="c1">// å³å‘å¸ƒä¸€ä¸ªrouting keyä¸º$severityçš„æ¶ˆæ¯åˆ°direct_logsè¿™ä¸ªexchangeä¸­</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">basic_publish</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="s1">'direct_logs'</span><span class="p">,</span> <span class="nv">$severity</span><span class="p">);</span>

<span class="k">echo</span> <span class="s2">" [x] Sent "</span><span class="p">,</span> <span class="nv">$severity</span><span class="p">,</span> <span class="s1">':'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="s2">" </span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="å¤„ç†æ—¥å¿—receive_logs_directphp">å¤„ç†æ—¥å¿—ï¼šreceive_logs_direct.php</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Connection\AMQPStreamConnection</span><span class="p">;</span>

<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPStreamConnection</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">5672</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">);</span>
<span class="nv">$channel</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">channel</span><span class="p">();</span>

<span class="c1">// å®šä¹‰ä¸€ä¸ªdirectç±»å‹çš„exchange</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">exchange_declare</span><span class="p">(</span><span class="s1">'direct_logs'</span><span class="p">,</span> <span class="s1">'direct'</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>

<span class="c1">// åŠ¨æ€ç”Ÿæˆä¸€ä¸ªqueue</span>
<span class="k">list</span><span class="p">(</span><span class="nv">$queue_name</span><span class="p">,</span> <span class="p">,)</span> <span class="o">=</span> <span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">queue_declare</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>

<span class="nv">$severities</span> <span class="o">=</span> <span class="nb">array_slice</span><span class="p">(</span><span class="nv">$argv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$severities</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">file_put_contents</span><span class="p">(</span><span class="s1">'php://stderr'</span><span class="p">,</span> <span class="s2">"Usage: </span><span class="nv">$argv[0]</span><span class="s2"> [info] [warning] [error]</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
    <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// æ¯ä¸€ç§çº§åˆ«çš„æ—¥å¿—éƒ½è¿›è¡Œä¸€æ¬¡ç»‘å®š</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$severities</span> <span class="k">as</span> <span class="nv">$severity</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// å°†$queue_nameè¿™ä¸ªqueueä½¿ç”¨routing key $severityç»‘å®šåˆ°exchange direct_logs</span>
    <span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">queue_bind</span><span class="p">(</span><span class="nv">$queue_name</span><span class="p">,</span> <span class="s1">'direct_logs'</span><span class="p">,</span> <span class="nv">$severity</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="s1">' [*] Waiting for logs. To exit press CTRL+C'</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="nv">$callback</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">' [x] '</span><span class="p">,</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="n">delivery_info</span><span class="p">[</span><span class="s1">'routing_key'</span><span class="p">],</span> <span class="s1">':'</span><span class="p">,</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">};</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">basic_consume</span><span class="p">(</span><span class="nv">$queue_name</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="nv">$callback</span><span class="p">);</span>

<span class="k">while</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$channel</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">wait</span><span class="p">();</span>
<span class="p">}</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="æµ‹è¯•-1">æµ‹è¯•</h2>
<p>å¯2ä¸ªreceiver</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php receive_logs_direct.php error
php receive_logs_direct.php info error
</code></pre></div></div>
<p>å‘å‡ºä¸€ä¸ªerrorçº§åˆ«çš„logï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php emit_log_direct.php error
</code></pre></div></div>

<p><u>å¦‚æœå‘å¸ƒerroræ¶ˆæ¯ï¼Œ2ä¸ªreceiveréƒ½ä¼šæ”¶åˆ°ï¼Œå¦‚æœå‘å¸ƒinfoæ¶ˆæ¯ï¼Œåˆ™åªæœ‰ç¬¬2ä¸ªreceiverä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚</u></p>

<h1 id="ä¾‹topics">ä¾‹ï¼šTopics</h1>
<p>direct exchangeçš„ä¸è¶³åœ¨äºå®ƒä¸èƒ½åŸºäºå¤šä¸ªçº¬åº¦æ¥åˆ†å‘æ¶ˆæ¯ã€‚æ¯”å¦‚è¦åŒæ—¶åŸºäºæ—¥å¿—çš„é”™è¯¯çº§åˆ«å’Œæ¥æºè¿›è¡Œå¤„ç†ã€‚</p>

<p>å‘é€å¾€topic exchangeçš„æ¶ˆæ¯éœ€è¦å¸¦æœ‰ä¸€ä¸ªç”±.å·åˆ†éš”çš„å¤šä¸ªå•è¯ç»„æˆçš„binding keyï¼Œä¸”æœ‰2ä¸ªå­—ç¬¦æ¯”è¾ƒç‰¹æ®Šï¼š</p>

<ul>
  <li>* (star) ä»£è¡¨1ä¸ªå•è¯ï¼›</li>
  <li># (hash) ä»£è¡¨0æˆ–å¤šä¸ªå•è¯ï¼›</li>
</ul>

<p>æ¯”å¦‚ï¼š<code class="language-plaintext highlighter-rouge">&lt;speed&gt;.&lt;colour&gt;.&lt;species&gt;</code>ï¼Œå£°æ˜å¦‚ä¸‹çš„ç»‘å®šï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Q1: *.orange.*  // all the orange animals
Q2: *.*.rabbit  // everything about rabbits
Q3: lazy.#      // everything about lazy animals
</code></pre></div></div>
<p>â€œquick.brown.foxâ€ä¸èƒ½åŒ¹é…ä»»ä½•ç»‘å®šï¼Œæ‰€ä»¥è¯¥æ¶ˆæ¯å°†è¢«ä¸¢å¼ƒã€‚
â€œorangeâ€æˆ–â€quick.orange.male.rabbitâ€ä¹Ÿä¸èƒ½åŒ¹é…ä»»ä½•ç»‘å®šã€‚
â€œlazy.orange.male.rabbitâ€, å°†åŒ¹é…æœ€åä¸€ä¸ªç»‘å®šã€‚</p>

<p>å¦‚æœä»…ä½¿ç”¨â€#â€ä½œä¸ºbinding keyï¼Œé‚£ä¹ˆå°†ä¼šåŒ¹é…æ‰€æœ‰æ¥æ”¶åˆ°çš„æ¶ˆæ¯è€Œå¿½ç•¥routing keyï¼Œå°±åƒfanout exchangeä¸€æ ·ã€‚å¯¹äºtopic exchangeï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ â€œ*â€ å’Œâ€#â€ï¼Œé‚£ä¹ˆå…¶è¡Œä¸ºå°†å’Œdirect exchangeä¸€æ ·ã€‚</p>

<p>æ ·ä¾‹ä»£ç å‡ ä¹å’ŒRoutingéƒ¨åˆ†çš„ä¸€æ ·ã€‚</p>

<h2 id="å‘å‡ºæ—¥å¿—emit_log_directphp-1">å‘å‡ºæ—¥å¿—ï¼šemit_log_direct.php</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Connection\AMQPStreamConnection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Message\AMQPMessage</span><span class="p">;</span>

<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPStreamConnection</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">5672</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">);</span>
<span class="nv">$channel</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">channel</span><span class="p">();</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">exchange_declare</span><span class="p">(</span><span class="s1">'topic_logs'</span><span class="p">,</span> <span class="s1">'topic'</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>

<span class="nv">$routing_key</span> <span class="o">=</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="s1">'anonymous.info'</span><span class="p">;</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="nb">array_slice</span><span class="p">(</span><span class="nv">$argv</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="nv">$data</span> <span class="o">=</span> <span class="s2">"Hello World!"</span><span class="p">;</span>

<span class="nv">$msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPMessage</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">basic_publish</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="s1">'topic_logs'</span><span class="p">,</span> <span class="nv">$routing_key</span><span class="p">);</span>

<span class="k">echo</span> <span class="s2">" [x] Sent "</span><span class="p">,</span> <span class="nv">$routing_key</span><span class="p">,</span> <span class="s1">':'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="s2">" </span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="å¤„ç†æ—¥å¿—receive_logs_directphp-1">å¤„ç†æ—¥å¿—ï¼šreceive_logs_direct.php</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Connection\AMQPStreamConnection</span><span class="p">;</span>

<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPStreamConnection</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">5672</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">);</span>
<span class="nv">$channel</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">channel</span><span class="p">();</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">exchange_declare</span><span class="p">(</span><span class="s1">'topic_logs'</span><span class="p">,</span> <span class="s1">'topic'</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>

<span class="k">list</span><span class="p">(</span><span class="nv">$queue_name</span><span class="p">,</span> <span class="p">,)</span> <span class="o">=</span> <span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">queue_declare</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>

<span class="nv">$binding_keys</span> <span class="o">=</span> <span class="nb">array_slice</span><span class="p">(</span><span class="nv">$argv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$binding_keys</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">file_put_contents</span><span class="p">(</span><span class="s1">'php://stderr'</span><span class="p">,</span> <span class="s2">"Usage: </span><span class="nv">$argv[0]</span><span class="s2"> [binding_key]</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
    <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$binding_keys</span> <span class="k">as</span> <span class="nv">$binding_key</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">queue_bind</span><span class="p">(</span><span class="nv">$queue_name</span><span class="p">,</span> <span class="s1">'topic_logs'</span><span class="p">,</span> <span class="nv">$binding_key</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="s1">' [*] Waiting for logs. To exit press CTRL+C'</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="nv">$callback</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">' [x] '</span><span class="p">,</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="n">delivery_info</span><span class="p">[</span><span class="s1">'routing_key'</span><span class="p">],</span> <span class="s1">':'</span><span class="p">,</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">};</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">basic_consume</span><span class="p">(</span><span class="nv">$queue_name</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="nv">$callback</span><span class="p">);</span>

<span class="k">while</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$channel</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">wait</span><span class="p">();</span>
<span class="p">}</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="æµ‹è¯•-2">æµ‹è¯•</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php receive_logs_topic.php "#"   // To receive all the logs
php receive_logs_topic.php "kern.*" // To receive all logs from the facility "kern"
php receive_logs_topic.php "kern.*" "*.critical"  // create multiple bindings
php emit_log_topic.php "kern.critical" "A critical kernel error" // emit a log with a routing key "kern.critical" type
</code></pre></div></div>

<h1 id="ä¾‹remote-procedure-call-rpc">ä¾‹ï¼šRemote procedure call (RPC)</h1>

<p>åŸºäºå›è°ƒæ–¹å¼çš„RPCè°ƒç”¨ã€‚</p>

<p>æ¶‰åŠçš„Messageå±æ€§ï¼š</p>
<ul>
  <li>delivery_mode: æŒ‡å®šæ¶ˆæ¯ä¸ºæ˜¯å¦ä¸ºæŒä¹…åŒ–çš„ï¼›</li>
  <li>content_type: æ¯”å¦‚application/jsonï¼›</li>
  <li>reply_to: ç”¨äºæŒ‡å®šå›è°ƒé˜Ÿåˆ—ï¼›</li>
  <li>correlation_id: ç”¨äºå…³è”RPC Responseå’Œè¯·æ±‚ï¼›</li>
</ul>

<h2 id="rpc_serverphp">rpc_server.php</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Connection\AMQPStreamConnection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Message\AMQPMessage</span><span class="p">;</span>

<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPStreamConnection</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">5672</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">);</span>
<span class="nv">$channel</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">channel</span><span class="p">();</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">queue_declare</span><span class="p">(</span><span class="s1">'rpc_queue'</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>

<span class="k">function</span> <span class="n">fib</span><span class="p">(</span><span class="nv">$n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="nf">fib</span><span class="p">(</span><span class="nv">$n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">fib</span><span class="p">(</span><span class="nv">$n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="s2">" [x] Awaiting RPC requests</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="nv">$callback</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$req</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$n</span> <span class="o">=</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$req</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">);</span>
    <span class="k">echo</span> <span class="s2">" [.] fib("</span><span class="p">,</span> <span class="nv">$n</span><span class="p">,</span> <span class="s2">")</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

    <span class="nv">$msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPMessage</span><span class="p">(</span>
        <span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="nf">fib</span><span class="p">(</span><span class="nv">$n</span><span class="p">),</span>
        <span class="p">[</span><span class="s1">'correlation_id'</span> <span class="o">=&gt;</span> <span class="nv">$req</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'correlation_id'</span><span class="p">)]</span>
    <span class="p">);</span>

    <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">delivery_info</span><span class="p">[</span><span class="s1">'channel'</span><span class="p">]</span><span class="o">-&gt;</span><span class="nf">basic_publish</span><span class="p">(</span>
        <span class="nv">$msg</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$req</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'reply_to'</span><span class="p">));</span>
    <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">delivery_info</span><span class="p">[</span><span class="s1">'channel'</span><span class="p">]</span><span class="o">-&gt;</span><span class="nf">basic_ack</span><span class="p">(</span>
        <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">delivery_info</span><span class="p">[</span><span class="s1">'delivery_tag'</span><span class="p">]);</span>
<span class="p">};</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">basic_qos</span><span class="p">(</span><span class="kc">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">);</span>
<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">basic_consume</span><span class="p">(</span><span class="s1">'rpc_queue'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="nv">$callback</span><span class="p">);</span>

<span class="k">while</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$channel</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">wait</span><span class="p">();</span>
<span class="p">}</span>

<span class="nv">$channel</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="rpc_clientphp">rpc_client.php</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Connection\AMQPStreamConnection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">PhpAmqpLib\Message\AMQPMessage</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">FibonacciRpcClient</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$connection</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$channel</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$callback_queue</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$response</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$corr_id</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPStreamConnection</span><span class="p">(</span>
            <span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">5672</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">,</span> <span class="s1">'guest'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">connection</span><span class="o">-&gt;</span><span class="nf">channel</span><span class="p">();</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">callback_queue</span><span class="p">,</span> <span class="p">,)</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="nf">queue_declare</span><span class="p">(</span>
            <span class="s2">""</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="nf">basic_consume</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">callback_queue</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">,</span>
            <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'on_response'</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">on_response</span><span class="p">(</span><span class="nv">$rep</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$rep</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'correlation_id'</span><span class="p">)</span> <span class="o">==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">corr_id</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">=</span> <span class="nv">$rep</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*
         If we see an unknown correlation_id value, we may safely discard the message - it doesn't belong to our requests.
        You may ask, why should we ignore unknown messages in the callback queue, rather than failing with an error?
         It's due to a possibility of a race condition on the server side.
        Although unlikely, it is possible that the RPC server will die just after sending us the answer, but before sending an acknowledgment message for the request.
        If that happens, the restarted RPC server will process the request again.
        That's why on the client we must handle the duplicate responses gracefully, and the RPC should ideally be idempotent.*/</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">call</span><span class="p">(</span><span class="nv">$n</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">corr_id</span> <span class="o">=</span> <span class="nb">uniqid</span><span class="p">();</span>  <span class="c1">// set it to a unique value for every request</span>

        <span class="nv">$msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AMQPMessage</span><span class="p">(</span>
            <span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="nv">$n</span><span class="p">,</span>
            <span class="p">[</span><span class="s1">'correlation_id'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">corr_id</span><span class="p">,</span>
             <span class="s1">'reply_to'</span>       <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">callback_queue</span><span class="p">]</span>
        <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="nf">basic_publish</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'rpc_queue'</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="nf">wait</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="p">;</span>

<span class="nv">$fibonacci_rpc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FibonacciRpcClient</span><span class="p">();</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$fibonacci_rpc</span><span class="o">-&gt;</span><span class="nf">call</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
<span class="k">echo</span> <span class="s2">" [.] Got "</span><span class="p">,</span> <span class="nv">$response</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
</code></pre></div></div>

:ET